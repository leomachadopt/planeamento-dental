{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/src/lib/api-shared/auth.ts"],"sourcesContent":["import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport jwt from 'jsonwebtoken'\r\n\r\nexport interface AuthRequest extends VercelRequest {\r\n  user?: {\r\n    id: string\r\n    email: string\r\n    role: 'admin' | 'user'\r\n    clinicId?: string\r\n    name: string\r\n  }\r\n}\r\n\r\n// Usar variável de ambiente ou fallback\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production'\r\n\r\nif (!process.env.JWT_SECRET) {\r\n  console.warn('⚠️  JWT_SECRET não configurado! Usando valor padrão inseguro.')\r\n}\r\n\r\nexport function authenticateToken(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  const authHeader = req.headers['authorization']\r\n  const token = authHeader && authHeader.split(' ')[1]\r\n\r\n  if (!token) {\r\n    return res.status(401).json({ error: 'Token não fornecido' })\r\n  }\r\n\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_SECRET) as AuthRequest['user']\r\n    req.user = decoded\r\n    next()\r\n  } catch (error) {\r\n    return res.status(403).json({ error: 'Token inválido ou expirado' })\r\n  }\r\n}\r\n\r\nexport function requireAdmin(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  if (req.user?.role !== 'admin') {\r\n    return res.status(403).json({ error: 'Acesso negado. Admin necessário.' })\r\n  }\r\n  next()\r\n}\r\n\r\nexport function optionalAuth(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  const authHeader = req.headers['authorization']\r\n  const token = authHeader && authHeader.split(' ')[1]\r\n\r\n  if (token) {\r\n    try {\r\n      const decoded = jwt.verify(token, JWT_SECRET) as AuthRequest['user']\r\n      req.user = decoded\r\n    } catch (error) {\r\n      // Token inválido, mas continua sem autenticação\r\n    }\r\n  }\r\n  next()\r\n}\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;;;AACA;;AAYA,wCAAwC;AACxC,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAE7C,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;IAC3B,QAAQ,IAAI,CAAC;AACf;AAEO,SAAS,kBACd,GAAgB,EAChB,GAAmB,EACnB,IAAgB;IAEhB,MAAM,aAAa,IAAI,OAAO,CAAC,gBAAgB;IAC/C,MAAM,QAAQ,cAAc,WAAW,KAAK,CAAC,IAAI,CAAC,EAAE;IAEpD,IAAI,CAAC,OAAO;QACV,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAsB;IAC7D;IAEA,IAAI;QACF,MAAM,UAAU,+NAAG,CAAC,MAAM,CAAC,OAAO;QAClC,IAAI,IAAI,GAAG;QACX;IACF,EAAE,OAAO,OAAO;QACd,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA6B;IACpE;AACF;AAEO,SAAS,aACd,GAAgB,EAChB,GAAmB,EACnB,IAAgB;IAEhB,IAAI,IAAI,IAAI,EAAE,SAAS,SAAS;QAC9B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAmC;IAC1E;IACA;AACF;AAEO,SAAS,aACd,GAAgB,EAChB,GAAmB,EACnB,IAAgB;IAEhB,MAAM,aAAa,IAAI,OAAO,CAAC,gBAAgB;IAC/C,MAAM,QAAQ,cAAc,WAAW,KAAK,CAAC,IAAI,CAAC,EAAE;IAEpD,IAAI,OAAO;QACT,IAAI;YACF,MAAM,UAAU,+NAAG,CAAC,MAAM,CAAC,OAAO;YAClC,IAAI,IAAI,GAAG;QACb,EAAE,OAAO,OAAO;QACd,gDAAgD;QAClD;IACF;IACA;AACF"}},
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/src/lib/api-shared/db.ts"],"sourcesContent":["// Módulo compartilhado para API routes\r\n// Este arquivo só roda no servidor (Node.js)\r\n\r\nimport { Pool } from 'pg'\r\n\r\n// Validar DATABASE_URL\r\nif (!process.env.DATABASE_URL) {\r\n  console.error('❌ DATABASE_URL não está configurada!')\r\n  console.error('❌ Configure DATABASE_URL no arquivo .env.local ou nas variáveis de ambiente')\r\n  throw new Error('DATABASE_URL não configurada. Configure no .env.local ou variáveis de ambiente.')\r\n}\r\n\r\n// Pool de conexões PostgreSQL\r\nconst pool = new Pool({\r\n  connectionString: process.env.DATABASE_URL,\r\n  ssl: {\r\n    rejectUnauthorized: false,\r\n  },\r\n  max: 20,\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 2000,\r\n})\r\n\r\npool.on('connect', () => {\r\n  console.log('✅ Conectado ao banco de dados Neon')\r\n})\r\n\r\npool.on('error', (err) => {\r\n  console.error('❌ Erro no pool de conexões:', err)\r\n})\r\n\r\nexport default pool\r\n\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA,uCAAuC;AACvC,6CAA6C;AAE7C;;;;;;AAEA,uBAAuB;AACvB,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,QAAQ,KAAK,CAAC;IACd,QAAQ,KAAK,CAAC;IACd,MAAM,IAAI,MAAM;AAClB;AAEA,8BAA8B;AAC9B,MAAM,OAAO,IAAI,qMAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK;QACH,oBAAoB;IACtB;IACA,KAAK;IACL,mBAAmB;IACnB,yBAAyB;AAC3B;AAEA,KAAK,EAAE,CAAC,WAAW;IACjB,QAAQ,GAAG,CAAC;AACd;AAEA,KAAK,EAAE,CAAC,SAAS,CAAC;IAChB,QAAQ,KAAK,CAAC,+BAA+B;AAC/C;uCAEe"}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/pages/api/clinics/%5Bid%5D/roles.ts"],"sourcesContent":["import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { authenticateToken, AuthRequest } from '@/lib/api-shared/auth'\r\nimport pool from '@/lib/api-shared/db'\r\n\r\nconst TABLE_NAME = 'roles'\r\n\r\nexport default async function handler(\r\n  req: VercelRequest,\r\n  res: VercelResponse,\r\n) {\r\n  res.setHeader('Access-Control-Allow-Credentials', 'true')\r\n  res.setHeader('Access-Control-Allow-Origin', '*')\r\n  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT')\r\n  res.setHeader('Access-Control-Allow-Headers', 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization')\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    res.status(200).end()\r\n    return\r\n  }\r\n\r\n  return authenticateToken(req as AuthRequest, res, async () => {\r\n    try {\r\n      const { method } = req\r\n      const authReq = req as AuthRequest\r\n      const user = authReq.user!\r\n      const clinicId = req.query.id as string\r\n      const entityId = req.query.entityId as string\r\n\r\n      if (!clinicId) {\r\n        return res.status(400).json({ error: 'ID da clínica é obrigatório' })\r\n      }\r\n\r\n      if (user.role !== 'admin' && user.clinicId !== clinicId) {\r\n        return res.status(403).json({ error: 'Acesso negado' })\r\n      }\r\n\r\n      if (method === 'GET') {\r\n        if (entityId) {\r\n          const result = await pool.query(\r\n            `SELECT * FROM ${TABLE_NAME} WHERE id = $1 AND clinic_id = $2`,\r\n            [entityId, clinicId],\r\n          )\r\n          if (result.rows.length === 0) {\r\n            return res.status(404).json({ error: 'Entidade não encontrada' })\r\n          }\r\n          return res.status(200).json(result.rows[0])\r\n        } else {\r\n          const result = await pool.query(\r\n            `SELECT * FROM ${TABLE_NAME} WHERE clinic_id = $1 ORDER BY created_at`,\r\n            [clinicId],\r\n          )\r\n          return res.status(200).json(result.rows)\r\n        }\r\n      }\r\n\r\n      if (method === 'POST') {\r\n        const { name, description } = req.body\r\n        if (!name) {\r\n          return res.status(400).json({ error: 'name é obrigatório' })\r\n        }\r\n\r\n        const result = await pool.query(\r\n          `INSERT INTO ${TABLE_NAME} (clinic_id, name, description)\r\n           VALUES ($1, $2, $3)\r\n           RETURNING *`,\r\n          [clinicId, name, description || null],\r\n        )\r\n        \r\n        return res.status(201).json(result.rows[0])\r\n      }\r\n\r\n      if (method === 'PUT' && entityId) {\r\n        const { name, description } = req.body\r\n\r\n        const updateFields: string[] = []\r\n        const updateValues: any[] = []\r\n        let paramIndex = 1\r\n\r\n        if (name !== undefined) {\r\n          updateFields.push(`name = $${paramIndex++}`)\r\n          updateValues.push(name)\r\n        }\r\n        if (description !== undefined) {\r\n          updateFields.push(`description = $${paramIndex++}`)\r\n          updateValues.push(description)\r\n        }\r\n\r\n        if (updateFields.length === 0) {\r\n          return res.status(400).json({ error: 'Nenhum campo para atualizar' })\r\n        }\r\n\r\n        updateFields.push(`updated_at = NOW()`)\r\n        updateValues.push(clinicId, entityId)\r\n\r\n        const result = await pool.query(\r\n          `UPDATE ${TABLE_NAME} \r\n           SET ${updateFields.join(', ')}\r\n           WHERE clinic_id = $${paramIndex++} AND id = $${paramIndex++}\r\n           RETURNING *`,\r\n          updateValues,\r\n        )\r\n\r\n        if (result.rows.length === 0) {\r\n          return res.status(404).json({ error: 'Entidade não encontrada' })\r\n        }\r\n\r\n        return res.status(200).json(result.rows[0])\r\n      }\r\n\r\n      if (method === 'DELETE' && entityId) {\r\n        const result = await pool.query(\r\n          `DELETE FROM ${TABLE_NAME} \r\n           WHERE id = $1 AND clinic_id = $2\r\n           RETURNING *`,\r\n          [entityId, clinicId],\r\n        )\r\n\r\n        if (result.rows.length === 0) {\r\n          return res.status(404).json({ error: 'Entidade não encontrada' })\r\n        }\r\n\r\n        return res.status(200).json({ message: 'Entidade excluída com sucesso' })\r\n      }\r\n\r\n      return res.status(405).json({ error: 'Método não permitido' })\r\n    } catch (error: any) {\r\n      console.error('Erro na API de roles:', error)\r\n      return res.status(500).json({ error: error.message || 'Erro interno do servidor' })\r\n    }\r\n  })\r\n}\r\n\r\n\r\n\r\n"],"names":[],"mappings":"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"}}]
}