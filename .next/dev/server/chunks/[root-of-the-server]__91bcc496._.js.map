{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 18, "column": 0}, "map": {"version":3,"sources":["file:///mnt/c/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/src/lib/api-shared/db.ts"],"sourcesContent":["// Módulo compartilhado para API routes\r\n// Este arquivo só roda no servidor (Node.js)\r\n\r\nimport { Pool } from 'pg'\r\n\r\n// Validar DATABASE_URL\r\nif (!process.env.DATABASE_URL) {\r\n  console.error('❌ DATABASE_URL não está configurada!')\r\n  console.error('❌ Configure DATABASE_URL no arquivo .env.local ou nas variáveis de ambiente')\r\n  throw new Error('DATABASE_URL não configurada. Configure no .env.local ou variáveis de ambiente.')\r\n}\r\n\r\n// Pool de conexões PostgreSQL\r\nconst pool = new Pool({\r\n  connectionString: process.env.DATABASE_URL,\r\n  ssl: {\r\n    rejectUnauthorized: false,\r\n  },\r\n  max: 20,\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 2000,\r\n})\r\n\r\npool.on('connect', () => {\r\n  console.log('✅ Conectado ao banco de dados Neon')\r\n})\r\n\r\npool.on('error', (err) => {\r\n  console.error('❌ Erro no pool de conexões:', err)\r\n})\r\n\r\nexport default pool\r\n\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA,uCAAuC;AACvC,6CAA6C;AAE7C;;;;;;AAEA,uBAAuB;AACvB,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,QAAQ,KAAK,CAAC;IACd,QAAQ,KAAK,CAAC;IACd,MAAM,IAAI,MAAM;AAClB;AAEA,8BAA8B;AAC9B,MAAM,OAAO,IAAI,qPAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK;QACH,oBAAoB;IACtB;IACA,KAAK;IACL,mBAAmB;IACnB,yBAAyB;AAC3B;AAEA,KAAK,EAAE,CAAC,WAAW;IACjB,QAAQ,GAAG,CAAC;AACd;AAEA,KAAK,EAAE,CAAC,SAAS,CAAC;IAChB,QAAQ,KAAK,CAAC,+BAA+B;AAC/C;uCAEe"}},
    {"offset": {"line": 60, "column": 0}, "map": {"version":3,"sources":["file:///mnt/c/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/pages/api/auth/login.ts"],"sourcesContent":["import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport jwt, { type SignOptions } from 'jsonwebtoken'\r\nimport bcrypt from 'bcryptjs'\r\nimport pool from '@/lib/api-shared/db'\r\n\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production'\r\nconst JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '7d'\r\n\r\nexport default async function handler(\r\n  req: VercelRequest,\r\n  res: VercelResponse,\r\n) {\r\n  // CORS headers\r\n  res.setHeader('Access-Control-Allow-Credentials', 'true')\r\n  res.setHeader('Access-Control-Allow-Origin', '*')\r\n  res.setHeader(\r\n    'Access-Control-Allow-Methods',\r\n    'GET,OPTIONS,PATCH,DELETE,POST,PUT',\r\n  )\r\n  res.setHeader(\r\n    'Access-Control-Allow-Headers',\r\n    'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization',\r\n  )\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    res.status(200).end()\r\n    return\r\n  }\r\n\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Método não permitido' })\r\n  }\r\n\r\n  try {\r\n    console.log('=== INÍCIO DO LOGIN ===')\r\n    console.log('Request method:', req.method)\r\n    console.log('Request body exists:', !!req.body)\r\n    console.log('Request body type:', typeof req.body)\r\n    console.log('Request body:', req.body)\r\n    \r\n    // Parse do body se necessário\r\n    let body = req.body\r\n    if (typeof body === 'string') {\r\n      try {\r\n        body = JSON.parse(body)\r\n      } catch (e) {\r\n        console.error('Erro ao parsear body:', e)\r\n        return res.status(400).json({ error: 'Body inválido' })\r\n      }\r\n    }\r\n    \r\n    const { email, password } = body || {}\r\n\r\n    if (!email || !password) {\r\n      console.log('Email ou senha faltando:', { hasEmail: !!email, hasPassword: !!password })\r\n      return res.status(400).json({ error: 'Email e senha são obrigatórios' })\r\n    }\r\n\r\n    console.log('Tentativa de login para:', email.toLowerCase())\r\n    console.log('DATABASE_URL exists:', !!process.env.DATABASE_URL)\r\n    console.log('DATABASE_URL length:', process.env.DATABASE_URL?.length || 0)\r\n    console.log('JWT_SECRET exists:', !!JWT_SECRET)\r\n\r\n    // Verificar se o pool está configurado\r\n    if (!pool) {\r\n      throw new Error('Pool de conexões não está inicializado')\r\n    }\r\n\r\n    // Buscar usuário\r\n    console.log('Executando query no banco...')\r\n    let userResult\r\n    try {\r\n      userResult = await pool.query(\r\n        'SELECT id, email, password_hash, name, role, clinic_id, is_active FROM users WHERE email = $1',\r\n        [email.toLowerCase()]\r\n      )\r\n      console.log('Query executada com sucesso')\r\n    } catch (dbError: any) {\r\n      console.error('❌ Erro na query do banco:', dbError)\r\n      console.error('❌ DB Error message:', dbError?.message)\r\n      console.error('❌ DB Error code:', dbError?.code)\r\n      console.error('❌ DB Error detail:', dbError?.detail)\r\n      console.error('❌ DB Error hint:', dbError?.hint)\r\n      throw new Error('Erro ao conectar com o banco de dados: ' + dbError?.message)\r\n    }\r\n\r\n    console.log('Usuários encontrados:', userResult.rows.length)\r\n\r\n    if (userResult.rows.length === 0) {\r\n      return res.status(401).json({ error: 'Credenciais inválidas' })\r\n    }\r\n\r\n    const user = userResult.rows[0]\r\n\r\n    if (!user.is_active) {\r\n      return res.status(403).json({ error: 'Conta desativada. Entre em contato com o administrador.' })\r\n    }\r\n\r\n    // Verificar senha\r\n    console.log('Verificando senha...')\r\n    console.log('Password hash length:', user.password_hash?.length)\r\n    \r\n    let isValidPassword = false\r\n    try {\r\n      console.log('Verificando senha com bcryptjs...')\r\n      isValidPassword = await bcrypt.compare(password, user.password_hash)\r\n      console.log('Senha válida:', isValidPassword)\r\n    } catch (bcryptError: any) {\r\n      console.error('❌ Erro ao verificar senha:', bcryptError)\r\n      console.error('❌ Bcrypt error message:', bcryptError?.message)\r\n      console.error('❌ Bcrypt error stack:', bcryptError?.stack)\r\n      throw new Error('Erro ao verificar senha: ' + bcryptError?.message)\r\n    }\r\n\r\n    if (!isValidPassword) {\r\n      return res.status(401).json({ error: 'Credenciais inválidas' })\r\n    }\r\n\r\n    // Atualizar último login\r\n    await pool.query(\r\n      'UPDATE users SET last_login = NOW() WHERE id = $1',\r\n      [user.id]\r\n    )\r\n\r\n    // Gerar token JWT\r\n    console.log('Gerando token JWT...')\r\n    const token = jwt.sign(\r\n      {\r\n        id: user.id,\r\n        email: user.email,\r\n        role: user.role,\r\n        clinicId: user.clinic_id,\r\n        name: user.name,\r\n      },\r\n      JWT_SECRET,\r\n      {\r\n        expiresIn: JWT_EXPIRES_IN as SignOptions['expiresIn'],\r\n      }\r\n    )\r\n\r\n    console.log('Token gerado com sucesso')\r\n    console.log('=== LOGIN CONCLUÍDO COM SUCESSO ===')\r\n\r\n    return res.status(200).json({\r\n      token,\r\n      user: {\r\n        id: user.id,\r\n        email: user.email,\r\n        name: user.name,\r\n        role: user.role,\r\n        clinicId: user.clinic_id,\r\n      },\r\n    })\r\n  } catch (error: any) {\r\n    console.error('❌ Erro no login:', error)\r\n    console.error('❌ Stack trace:', error?.stack)\r\n    console.error('❌ Error name:', error?.name)\r\n    console.error('❌ Error code:', error?.code)\r\n    \r\n    // Em desenvolvimento, retornar mais detalhes\r\n    const isDevelopment = process.env.NODE_ENV === 'development' || !process.env.NODE_ENV\r\n    \r\n    return res.status(500).json({ \r\n      error: 'Erro interno do servidor',\r\n      message: error?.message || 'Erro desconhecido',\r\n      ...(isDevelopment && {\r\n        details: error?.stack,\r\n        errorName: error?.name,\r\n        errorCode: error?.code,\r\n        hasDatabaseUrl: !!process.env.DATABASE_URL,\r\n      })\r\n    })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}