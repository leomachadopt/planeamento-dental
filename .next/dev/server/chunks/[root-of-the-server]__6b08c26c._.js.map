{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///mnt/c/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/src/lib/api-shared/auth.ts"],"sourcesContent":["import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport jwt from 'jsonwebtoken'\r\n\r\nexport interface AuthRequest extends VercelRequest {\r\n  user?: {\r\n    id: string\r\n    email: string\r\n    role: 'admin' | 'user'\r\n    clinicId?: string\r\n    name: string\r\n  }\r\n}\r\n\r\n// Usar variável de ambiente ou fallback\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production'\r\n\r\nif (!process.env.JWT_SECRET) {\r\n  console.warn('⚠️  JWT_SECRET não configurado! Usando valor padrão inseguro.')\r\n}\r\n\r\nexport function authenticateToken(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  const authHeader = req.headers['authorization']\r\n  const token = authHeader && authHeader.split(' ')[1]\r\n\r\n  if (!token) {\r\n    return res.status(401).json({ error: 'Token não fornecido' })\r\n  }\r\n\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_SECRET) as AuthRequest['user']\r\n    req.user = decoded\r\n    next()\r\n  } catch (error) {\r\n    return res.status(403).json({ error: 'Token inválido ou expirado' })\r\n  }\r\n}\r\n\r\nexport function requireAdmin(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  if (req.user?.role !== 'admin') {\r\n    return res.status(403).json({ error: 'Acesso negado. Admin necessário.' })\r\n  }\r\n  next()\r\n}\r\n\r\nexport function optionalAuth(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  const authHeader = req.headers['authorization']\r\n  const token = authHeader && authHeader.split(' ')[1]\r\n\r\n  if (token) {\r\n    try {\r\n      const decoded = jwt.verify(token, JWT_SECRET) as AuthRequest['user']\r\n      req.user = decoded\r\n    } catch (error) {\r\n      // Token inválido, mas continua sem autenticação\r\n    }\r\n  }\r\n  next()\r\n}\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;;;AACA;;AAYA,wCAAwC;AACxC,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAE7C,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;IAC3B,QAAQ,IAAI,CAAC;AACf;AAEO,SAAS,kBACd,GAAgB,EAChB,GAAmB,EACnB,IAAgB;IAEhB,MAAM,aAAa,IAAI,OAAO,CAAC,gBAAgB;IAC/C,MAAM,QAAQ,cAAc,WAAW,KAAK,CAAC,IAAI,CAAC,EAAE;IAEpD,IAAI,CAAC,OAAO;QACV,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAsB;IAC7D;IAEA,IAAI;QACF,MAAM,UAAU,wRAAG,CAAC,MAAM,CAAC,OAAO;QAClC,IAAI,IAAI,GAAG;QACX;IACF,EAAE,OAAO,OAAO;QACd,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA6B;IACpE;AACF;AAEO,SAAS,aACd,GAAgB,EAChB,GAAmB,EACnB,IAAgB;IAEhB,IAAI,IAAI,IAAI,EAAE,SAAS,SAAS;QAC9B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAmC;IAC1E;IACA;AACF;AAEO,SAAS,aACd,GAAgB,EAChB,GAAmB,EACnB,IAAgB;IAEhB,MAAM,aAAa,IAAI,OAAO,CAAC,gBAAgB;IAC/C,MAAM,QAAQ,cAAc,WAAW,KAAK,CAAC,IAAI,CAAC,EAAE;IAEpD,IAAI,OAAO;QACT,IAAI;YACF,MAAM,UAAU,wRAAG,CAAC,MAAM,CAAC,OAAO;YAClC,IAAI,IAAI,GAAG;QACb,EAAE,OAAO,OAAO;QACd,gDAAgD;QAClD;IACF;IACA;AACF"}},
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///mnt/c/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/src/lib/api-shared/db.ts"],"sourcesContent":["// Módulo compartilhado para API routes\r\n// Este arquivo só roda no servidor (Node.js)\r\n\r\nimport { Pool } from 'pg'\r\n\r\n// Validar DATABASE_URL\r\nif (!process.env.DATABASE_URL) {\r\n  console.error('❌ DATABASE_URL não está configurada!')\r\n  console.error('❌ Configure DATABASE_URL no arquivo .env.local ou nas variáveis de ambiente')\r\n  throw new Error('DATABASE_URL não configurada. Configure no .env.local ou variáveis de ambiente.')\r\n}\r\n\r\n// Pool de conexões PostgreSQL\r\nconst pool = new Pool({\r\n  connectionString: process.env.DATABASE_URL,\r\n  ssl: {\r\n    rejectUnauthorized: false,\r\n  },\r\n  max: 20,\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 2000,\r\n})\r\n\r\npool.on('connect', () => {\r\n  console.log('✅ Conectado ao banco de dados Neon')\r\n})\r\n\r\npool.on('error', (err) => {\r\n  console.error('❌ Erro no pool de conexões:', err)\r\n})\r\n\r\nexport default pool\r\n\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA,uCAAuC;AACvC,6CAA6C;AAE7C;;;;;;AAEA,uBAAuB;AACvB,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,QAAQ,KAAK,CAAC;IACd,QAAQ,KAAK,CAAC;IACd,MAAM,IAAI,MAAM;AAClB;AAEA,8BAA8B;AAC9B,MAAM,OAAO,IAAI,qPAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK;QACH,oBAAoB;IACtB;IACA,KAAK;IACL,mBAAmB;IACnB,yBAAyB;AAC3B;AAEA,KAAK,EAAE,CAAC,WAAW;IACjB,QAAQ,GAAG,CAAC;AACd;AAEA,KAAK,EAAE,CAAC,SAAS,CAAC;IAChB,QAAQ,KAAK,CAAC,+BAA+B;AAC/C;uCAEe"}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///mnt/c/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/pages/api/admin/prompts/%5Btype%5D.ts"],"sourcesContent":["import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { authenticateToken, requireAdmin, AuthRequest } from '@/lib/api-shared/auth'\r\nimport pool from '@/lib/api-shared/db'\r\n\r\nexport default async function handler(\r\n  req: VercelRequest,\r\n  res: VercelResponse,\r\n) {\r\n  res.setHeader('Access-Control-Allow-Credentials', 'true')\r\n  res.setHeader('Access-Control-Allow-Origin', '*')\r\n  res.setHeader(\r\n    'Access-Control-Allow-Methods',\r\n    'GET,PUT,OPTIONS',\r\n  )\r\n  res.setHeader(\r\n    'Access-Control-Allow-Headers',\r\n    'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization',\r\n  )\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    res.status(200).end()\r\n    return\r\n  }\r\n\r\n  return authenticateToken(req as AuthRequest, res, () => {\r\n    return requireAdmin(req as AuthRequest, res, async () => {\r\n      try {\r\n        const promptType = req.query.type as string\r\n\r\n        if (!promptType) {\r\n          return res.status(400).json({ error: 'Tipo de prompt é obrigatório' })\r\n        }\r\n\r\n        // Extrair section_code se for section_*\r\n        let sectionCode: string | null = null\r\n        if (promptType.startsWith('section_')) {\r\n          sectionCode = promptType.replace('section_', '')\r\n        }\r\n\r\n        if (req.method === 'GET') {\r\n          // Buscar prompt do banco\r\n          const result = await pool.query(\r\n            `SELECT \r\n              system_prompt,\r\n              user_prompt,\r\n              key,\r\n              version,\r\n              section_code,\r\n              is_active,\r\n              created_at,\r\n              updated_at\r\n            FROM ai_prompt_templates\r\n            WHERE key = $1 AND is_active = true\r\n            ORDER BY created_at DESC\r\n            LIMIT 1`,\r\n            [promptType],\r\n          )\r\n\r\n          if (result.rows.length > 0) {\r\n            return res.status(200).json({\r\n              key: result.rows[0].key,\r\n              section_code: result.rows[0].section_code,\r\n              system_prompt: result.rows[0].system_prompt || '',\r\n              user_prompt: result.rows[0].user_prompt || '',\r\n              version: result.rows[0].version,\r\n              is_active: result.rows[0].is_active,\r\n              created_at: result.rows[0].created_at,\r\n              updated_at: result.rows[0].updated_at,\r\n            })\r\n          }\r\n\r\n          // Se não encontrou, retornar vazio (frontend vai usar default do código)\r\n          return res.status(200).json({\r\n            key: promptType,\r\n            section_code: sectionCode,\r\n            system_prompt: '',\r\n            user_prompt: '',\r\n            version: '1.0.0',\r\n            is_active: false,\r\n            created_at: null,\r\n            updated_at: null,\r\n          })\r\n        }\r\n\r\n        if (req.method === 'PUT') {\r\n          const { system_prompt, user_prompt } = req.body\r\n\r\n          if (system_prompt === undefined && user_prompt === undefined) {\r\n            return res.status(400).json({ error: 'system_prompt ou user_prompt é obrigatório' })\r\n          }\r\n\r\n          // Verificar se já existe um prompt ativo\r\n          const existingResult = await pool.query(\r\n            `SELECT id, version FROM ai_prompt_templates\r\n             WHERE key = $1 AND is_active = true\r\n             ORDER BY created_at DESC\r\n             LIMIT 1`,\r\n            [promptType],\r\n          )\r\n\r\n          let newVersion = '1.0.0'\r\n          if (existingResult.rows.length > 0) {\r\n            // Desativar versão anterior\r\n            await pool.query(\r\n              `UPDATE ai_prompt_templates\r\n               SET is_active = false, updated_at = NOW()\r\n               WHERE id = $1`,\r\n              [existingResult.rows[0].id],\r\n            )\r\n            // Incrementar versão\r\n            const currentVersion = existingResult.rows[0].version\r\n            const versionParts = currentVersion.split('.')\r\n            const minor = parseInt(versionParts[1] || '0') + 1\r\n            newVersion = `${versionParts[0]}.${minor}.0`\r\n          }\r\n\r\n          // Buscar prompts atuais se não foram fornecidos\r\n          let finalSystemPrompt = system_prompt\r\n          let finalUserPrompt = user_prompt\r\n\r\n          if (existingResult.rows.length > 0 && (system_prompt === undefined || user_prompt === undefined)) {\r\n            const currentResult = await pool.query(\r\n              `SELECT system_prompt, user_prompt FROM ai_prompt_templates WHERE id = $1`,\r\n              [existingResult.rows[0].id],\r\n            )\r\n            if (currentResult.rows.length > 0) {\r\n              if (system_prompt === undefined) {\r\n                finalSystemPrompt = currentResult.rows[0].system_prompt\r\n              }\r\n              if (user_prompt === undefined) {\r\n                finalUserPrompt = currentResult.rows[0].user_prompt\r\n              }\r\n            }\r\n          }\r\n\r\n          // Inserir nova versão\r\n          const insertResult = await pool.query(\r\n            `INSERT INTO ai_prompt_templates (\r\n              key, version, template_text, system_prompt, user_prompt, section_code, is_active\r\n            ) VALUES ($1, $2, $3, $4, $5, $6, true)\r\n            RETURNING id, key, version, system_prompt, user_prompt, section_code, is_active, created_at, updated_at`,\r\n            [\r\n              promptType,\r\n              newVersion,\r\n              finalUserPrompt || '', // template_text mantido para compatibilidade\r\n              finalSystemPrompt || '',\r\n              finalUserPrompt || '',\r\n              sectionCode,\r\n            ],\r\n          )\r\n\r\n          return res.status(200).json({\r\n            id: insertResult.rows[0].id,\r\n            key: insertResult.rows[0].key,\r\n            section_code: insertResult.rows[0].section_code,\r\n            system_prompt: insertResult.rows[0].system_prompt,\r\n            user_prompt: insertResult.rows[0].user_prompt,\r\n            version: insertResult.rows[0].version,\r\n            is_active: insertResult.rows[0].is_active,\r\n            created_at: insertResult.rows[0].created_at,\r\n            updated_at: insertResult.rows[0].updated_at,\r\n          })\r\n        }\r\n\r\n        return res.status(405).json({ error: 'Método não permitido' })\r\n      } catch (error: any) {\r\n        console.error('Erro na API de prompts:', error)\r\n        return res.status(500).json({ error: error.message })\r\n      }\r\n    })\r\n  })\r\n}\r\n\r\n\r\n"],"names":[],"mappings":"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"}}]
}