{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///mnt/c/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/src/lib/api-shared/auth.ts"],"sourcesContent":["import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport jwt from 'jsonwebtoken'\r\n\r\nexport interface AuthRequest extends VercelRequest {\r\n  user?: {\r\n    id: string\r\n    email: string\r\n    role: 'admin' | 'user'\r\n    clinicId?: string\r\n    name: string\r\n  }\r\n}\r\n\r\n// Usar variável de ambiente ou fallback\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production'\r\n\r\nif (!process.env.JWT_SECRET) {\r\n  console.warn('⚠️  JWT_SECRET não configurado! Usando valor padrão inseguro.')\r\n}\r\n\r\nexport function authenticateToken(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  const authHeader = req.headers['authorization']\r\n  const token = authHeader && authHeader.split(' ')[1]\r\n\r\n  if (!token) {\r\n    return res.status(401).json({ error: 'Token não fornecido' })\r\n  }\r\n\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_SECRET) as AuthRequest['user']\r\n    req.user = decoded\r\n    next()\r\n  } catch (error) {\r\n    return res.status(403).json({ error: 'Token inválido ou expirado' })\r\n  }\r\n}\r\n\r\nexport function requireAdmin(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  if (req.user?.role !== 'admin') {\r\n    return res.status(403).json({ error: 'Acesso negado. Admin necessário.' })\r\n  }\r\n  next()\r\n}\r\n\r\nexport function optionalAuth(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  const authHeader = req.headers['authorization']\r\n  const token = authHeader && authHeader.split(' ')[1]\r\n\r\n  if (token) {\r\n    try {\r\n      const decoded = jwt.verify(token, JWT_SECRET) as AuthRequest['user']\r\n      req.user = decoded\r\n    } catch (error) {\r\n      // Token inválido, mas continua sem autenticação\r\n    }\r\n  }\r\n  next()\r\n}\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;;;AACA;;AAYA,wCAAwC;AACxC,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAE7C,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;IAC3B,QAAQ,IAAI,CAAC;AACf;AAEO,SAAS,kBACd,GAAgB,EAChB,GAAmB,EACnB,IAAgB;IAEhB,MAAM,aAAa,IAAI,OAAO,CAAC,gBAAgB;IAC/C,MAAM,QAAQ,cAAc,WAAW,KAAK,CAAC,IAAI,CAAC,EAAE;IAEpD,IAAI,CAAC,OAAO;QACV,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAsB;IAC7D;IAEA,IAAI;QACF,MAAM,UAAU,wRAAG,CAAC,MAAM,CAAC,OAAO;QAClC,IAAI,IAAI,GAAG;QACX;IACF,EAAE,OAAO,OAAO;QACd,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAA6B;IACpE;AACF;AAEO,SAAS,aACd,GAAgB,EAChB,GAAmB,EACnB,IAAgB;IAEhB,IAAI,IAAI,IAAI,EAAE,SAAS,SAAS;QAC9B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAmC;IAC1E;IACA;AACF;AAEO,SAAS,aACd,GAAgB,EAChB,GAAmB,EACnB,IAAgB;IAEhB,MAAM,aAAa,IAAI,OAAO,CAAC,gBAAgB;IAC/C,MAAM,QAAQ,cAAc,WAAW,KAAK,CAAC,IAAI,CAAC,EAAE;IAEpD,IAAI,OAAO;QACT,IAAI;YACF,MAAM,UAAU,wRAAG,CAAC,MAAM,CAAC,OAAO;YAClC,IAAI,IAAI,GAAG;QACb,EAAE,OAAO,OAAO;QACd,gDAAgD;QAClD;IACF;IACA;AACF"}},
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///mnt/c/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/src/lib/api-shared/db.ts"],"sourcesContent":["// Módulo compartilhado para API routes\r\n// Este arquivo só roda no servidor (Node.js)\r\n\r\nimport { Pool } from 'pg'\r\n\r\n// Validar DATABASE_URL\r\nif (!process.env.DATABASE_URL) {\r\n  console.error('❌ DATABASE_URL não está configurada!')\r\n  console.error('❌ Configure DATABASE_URL no arquivo .env.local ou nas variáveis de ambiente')\r\n  throw new Error('DATABASE_URL não configurada. Configure no .env.local ou variáveis de ambiente.')\r\n}\r\n\r\n// Pool de conexões PostgreSQL\r\nconst pool = new Pool({\r\n  connectionString: process.env.DATABASE_URL,\r\n  ssl: {\r\n    rejectUnauthorized: false,\r\n  },\r\n  max: 20,\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 2000,\r\n})\r\n\r\npool.on('connect', () => {\r\n  console.log('✅ Conectado ao banco de dados Neon')\r\n})\r\n\r\npool.on('error', (err) => {\r\n  console.error('❌ Erro no pool de conexões:', err)\r\n})\r\n\r\nexport default pool\r\n\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA,uCAAuC;AACvC,6CAA6C;AAE7C;;;;;;AAEA,uBAAuB;AACvB,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,QAAQ,KAAK,CAAC;IACd,QAAQ,KAAK,CAAC;IACd,MAAM,IAAI,MAAM;AAClB;AAEA,8BAA8B;AAC9B,MAAM,OAAO,IAAI,qPAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK;QACH,oBAAoB;IACtB;IACA,KAAK;IACL,mBAAmB;IACnB,yBAAyB;AAC3B;AAEA,KAAK,EAAE,CAAC,WAAW;IACjB,QAAQ,GAAG,CAAC;AACd;AAEA,KAAK,EAAE,CAAC,SAAS,CAAC;IAChB,QAAQ,KAAK,CAAC,+BAA+B;AAC/C;uCAEe"}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///mnt/c/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/src/lib/api-shared/snapshotBuilder.ts"],"sourcesContent":["// Versão server-side do snapshot builder\r\nimport pool from './db'\r\n\r\nexport interface SectionSnapshot {\r\n  clinic: {\r\n    id: string\r\n    name: string\r\n    location?: string\r\n    type?: string\r\n  }\r\n  dossier: {\r\n    id: string\r\n    title: string\r\n    baseline_date?: string\r\n  }\r\n  section: {\r\n    code: string\r\n    name: string\r\n    description?: string\r\n  }\r\n  answers: Array<{\r\n    question_code: string\r\n    question_text: string\r\n    value_normalized: any\r\n    required: boolean\r\n    raw_value?: any\r\n  }>\r\n  entities: Record<string, any[]>\r\n  completeness: {\r\n    percent: number\r\n    missing_items: string[]\r\n  }\r\n  data_quality_flags: string[]\r\n  generated_at: string\r\n}\r\n\r\nconst SECTION_ENTITIES_MAP: Record<string, string[]> = {\r\n  IDENTITY: ['customer_segments', 'value_propositions'],\r\n  MARKET: ['competitors'],\r\n  OFFER: ['service_categories', 'services'],\r\n  OPERATIONS: ['team_members', 'roles', 'capacities'],\r\n  STRATEGY: ['strategic_choices'],\r\n  PLAN: ['initiatives'],\r\n  BUSINESS_MODEL: [],\r\n  FINAL_REPORT: [],\r\n}\r\n\r\nfunction normalizeAnswer(question: any, answer: any): any {\r\n  if (!answer) return null\r\n\r\n  switch (question.type) {\r\n    case 'multi_select':\r\n    case 'json':\r\n      if (answer.value_json) {\r\n        return Array.isArray(answer.value_json) ? answer.value_json : [answer.value_json]\r\n      }\r\n      if (answer.value_text) {\r\n        try {\r\n          const parsed = JSON.parse(answer.value_text)\r\n          return Array.isArray(parsed) ? parsed : [parsed]\r\n        } catch {\r\n          return answer.value_text.split(',').map((s: string) => s.trim())\r\n        }\r\n      }\r\n      return []\r\n\r\n    case 'currency':\r\n      const currencyValue = answer.value_number || parseFloat(answer.value_text || '0')\r\n      return {\r\n        value: currencyValue,\r\n        currency: 'EUR',\r\n        formatted: new Intl.NumberFormat('pt-PT', {\r\n          style: 'currency',\r\n          currency: 'EUR',\r\n        }).format(currencyValue),\r\n        raw: answer.value_text || answer.value_number,\r\n      }\r\n\r\n    case 'number':\r\n    case 'scale':\r\n      return answer.value_number !== null && answer.value_number !== undefined\r\n        ? answer.value_number\r\n        : parseFloat(answer.value_text || '0')\r\n\r\n    case 'date':\r\n      return answer.value_text || null\r\n\r\n    default:\r\n      return answer.value_text || answer.value_number?.toString() || null\r\n  }\r\n}\r\n\r\nfunction detectDataQualityFlags(\r\n  sectionCode: string,\r\n  snapshot: Partial<SectionSnapshot>,\r\n): string[] {\r\n  const flags: string[] = []\r\n\r\n  if (snapshot.answers) {\r\n    const missingRequired = snapshot.answers.filter(\r\n      (a) => a.required && (!a.value_normalized || a.value_normalized === ''),\r\n    )\r\n    if (missingRequired.length > 0) {\r\n      flags.push(\r\n        `Campos obrigatórios não preenchidos: ${missingRequired.map((a) => a.question_code).join(', ')}`,\r\n      )\r\n    }\r\n  }\r\n\r\n  if (sectionCode === 'IDENTITY') {\r\n    const entities = snapshot.entities || {}\r\n    const segments = entities.customer_segments || []\r\n    const propositions = entities.value_propositions || []\r\n\r\n    if (segments.length === 0) flags.push('Nenhum segmento de cliente cadastrado')\r\n    if (propositions.length === 0) flags.push('Nenhuma proposta de valor cadastrada')\r\n\r\n    const propositionsWithoutSegment = propositions.filter(\r\n      (p: any) => !p.target_segment_id && !p.target_segment_name,\r\n    )\r\n    if (propositionsWithoutSegment.length > 0) {\r\n      flags.push(\r\n        `${propositionsWithoutSegment.length} proposta(s) de valor sem segmento alvo definido`,\r\n      )\r\n    }\r\n  }\r\n\r\n  if (sectionCode === 'OFFER') {\r\n    const entities = snapshot.entities || {}\r\n    const services = entities.services || []\r\n    const invalidPrices = services.filter(\r\n      (s: any) => s.price !== null && s.price !== undefined && (s.price < 0 || s.price === 0),\r\n    )\r\n    if (invalidPrices.length > 0) {\r\n      flags.push(`${invalidPrices.length} serviço(s) com preço inválido (zero ou negativo)`)\r\n    }\r\n  }\r\n\r\n  if (sectionCode === 'OPERATIONS') {\r\n    const entities = snapshot.entities || {}\r\n    const teamMembers = entities.team_members || []\r\n    const capacities = entities.capacities || []\r\n\r\n    if (teamMembers.length === 0) flags.push('Nenhum membro da equipe cadastrado')\r\n    if (capacities.length === 0) flags.push('Nenhuma capacidade operacional cadastrada')\r\n  }\r\n\r\n  return flags\r\n}\r\n\r\nasync function fetchSectionEntities(\r\n  dossierId: string,\r\n  sectionCode: string,\r\n): Promise<Record<string, any[]>> {\r\n  const entityTypes = SECTION_ENTITIES_MAP[sectionCode] || []\r\n  const entities: Record<string, any[]> = {}\r\n\r\n  for (const entityType of entityTypes) {\r\n    try {\r\n      switch (entityType) {\r\n        case 'customer_segments':\r\n          const segResult = await pool.query(\r\n            'SELECT * FROM customer_segments WHERE dossier_id = $1 ORDER BY priority, created_at',\r\n            [dossierId],\r\n          )\r\n          entities.customer_segments = segResult.rows\r\n          break\r\n        case 'value_propositions':\r\n          const propResult = await pool.query(\r\n            `SELECT vp.*, cs.name as target_segment_name\r\n             FROM value_propositions vp\r\n             LEFT JOIN customer_segments cs ON cs.id = vp.target_segment_id\r\n             WHERE vp.dossier_id = $1 ORDER BY vp.created_at`,\r\n            [dossierId],\r\n          )\r\n          entities.value_propositions = propResult.rows\r\n          break\r\n        case 'services':\r\n          const servResult = await pool.query(\r\n            `SELECT s.*, sc.name as category_name\r\n             FROM services s\r\n             LEFT JOIN service_categories sc ON sc.id = s.service_category_id\r\n             WHERE s.dossier_id = $1 ORDER BY s.is_flagship DESC, s.created_at`,\r\n            [dossierId],\r\n          )\r\n          entities.services = servResult.rows\r\n          break\r\n        case 'competitors':\r\n          const compResult = await pool.query(\r\n            'SELECT * FROM competitors WHERE dossier_id = $1 ORDER BY type, created_at',\r\n            [dossierId],\r\n          )\r\n          entities.competitors = compResult.rows\r\n          break\r\n        case 'team_members':\r\n          const teamResult = await pool.query(\r\n            `SELECT tm.*, r.name as role_name\r\n             FROM team_members tm\r\n             LEFT JOIN roles r ON r.id = tm.role_id\r\n             WHERE tm.dossier_id = $1 ORDER BY tm.created_at`,\r\n            [dossierId],\r\n          )\r\n          entities.team_members = teamResult.rows\r\n          break\r\n        case 'capacities':\r\n          const capResult = await pool.query(\r\n            'SELECT * FROM capacities WHERE dossier_id = $1 ORDER BY resource_type, created_at',\r\n            [dossierId],\r\n          )\r\n          entities.capacities = capResult.rows\r\n          break\r\n        case 'strategic_choices':\r\n          const stratResult = await pool.query(\r\n            'SELECT * FROM strategic_choices WHERE dossier_id = $1 ORDER BY priority, created_at',\r\n            [dossierId],\r\n          )\r\n          entities.strategic_choices = stratResult.rows\r\n          break\r\n        case 'initiatives':\r\n          const initResult = await pool.query(\r\n            'SELECT * FROM initiatives WHERE dossier_id = $1 ORDER BY created_at',\r\n            [dossierId],\r\n          )\r\n          entities.initiatives = initResult.rows\r\n          break\r\n      }\r\n    } catch (error) {\r\n      console.warn(`Erro ao buscar entidade ${entityType}:`, error)\r\n      entities[entityType] = []\r\n    }\r\n  }\r\n\r\n  return entities\r\n}\r\n\r\nasync function calculateSectionCompletion(\r\n  dossierId: string,\r\n  sectionId: string,\r\n): Promise<number> {\r\n  const requiredQuestionsResult = await pool.query(\r\n    `SELECT COUNT(*) as total FROM questions q\r\n     JOIN question_sets qs ON qs.id = q.question_set_id\r\n     WHERE qs.section_id = $1 AND q.required = true`,\r\n    [sectionId],\r\n  )\r\n\r\n  const answeredResult = await pool.query(\r\n    `SELECT COUNT(*) as total FROM answers a\r\n     JOIN questions q ON q.id = a.question_id\r\n     JOIN question_sets qs ON qs.id = q.question_set_id\r\n     WHERE qs.section_id = $1 AND a.dossier_id = $2 \r\n     AND (a.value_text IS NOT NULL AND a.value_text != '' \r\n          OR a.value_number IS NOT NULL \r\n          OR a.value_json IS NOT NULL)`,\r\n    [sectionId, dossierId],\r\n  )\r\n\r\n  const totalRequired = parseInt(requiredQuestionsResult.rows[0].total)\r\n  const totalAnswered = parseInt(answeredResult.rows[0].total)\r\n\r\n  if (totalRequired === 0) return 100\r\n\r\n  let completionPercent = Math.round((totalAnswered / totalRequired) * 100)\r\n\r\n  // Bônus para IDENTITY se tiver entidades\r\n  const sectionResult = await pool.query('SELECT code FROM sections WHERE id = $1', [sectionId])\r\n  if (sectionResult.rows[0]?.code === 'IDENTITY') {\r\n    const segmentsResult = await pool.query(\r\n      'SELECT COUNT(*) as count FROM customer_segments WHERE dossier_id = $1',\r\n      [dossierId],\r\n    )\r\n    const propositionsResult = await pool.query(\r\n      'SELECT COUNT(*) as count FROM value_propositions WHERE dossier_id = $1',\r\n      [dossierId],\r\n    )\r\n\r\n    const hasSegments = parseInt(segmentsResult.rows[0].count) > 0\r\n    const hasPropositions = parseInt(propositionsResult.rows[0].count) > 0\r\n\r\n    if (hasSegments && hasPropositions) {\r\n      completionPercent = Math.min(100, completionPercent + 10)\r\n    } else if (hasSegments || hasPropositions) {\r\n      completionPercent = Math.min(100, completionPercent + 5)\r\n    }\r\n  }\r\n\r\n  return completionPercent\r\n}\r\n\r\nexport async function buildSectionSnapshot(\r\n  dossierId: string,\r\n  sectionCode: string,\r\n): Promise<SectionSnapshot> {\r\n  // Buscar dados básicos\r\n  const dossierResult = await pool.query('SELECT * FROM dossiers WHERE id = $1', [dossierId])\r\n  if (dossierResult.rows.length === 0) {\r\n    throw new Error('Dossiê não encontrado')\r\n  }\r\n  const dossier = dossierResult.rows[0]\r\n\r\n  const clinicResult = await pool.query('SELECT * FROM clinics WHERE id = $1', [dossier.clinic_id])\r\n  if (clinicResult.rows.length === 0) {\r\n    throw new Error('Clínica não encontrada')\r\n  }\r\n  const clinic = clinicResult.rows[0]\r\n\r\n  const sectionResult = await pool.query('SELECT * FROM sections WHERE code = $1', [sectionCode])\r\n  if (sectionResult.rows.length === 0) {\r\n    throw new Error('Seção não encontrada')\r\n  }\r\n  const section = sectionResult.rows[0]\r\n\r\n  // Buscar question_sets e perguntas\r\n  const questionSetsResult = await pool.query(\r\n    `SELECT qs.* FROM question_sets qs\r\n     WHERE qs.section_id = $1 AND qs.is_active = true\r\n     ORDER BY qs.version DESC`,\r\n    [section.id],\r\n  )\r\n\r\n  const normalizedAnswers: SectionSnapshot['answers'] = []\r\n  const missingItems: string[] = []\r\n\r\n  for (const qs of questionSetsResult.rows) {\r\n    const questionsResult = await pool.query(\r\n      `SELECT q.*, \r\n       json_agg(\r\n         json_build_object('id', qo.id, 'label', qo.label, 'value', qo.value, 'order_index', qo.order_index)\r\n         ORDER BY qo.order_index\r\n       ) FILTER (WHERE qo.id IS NOT NULL) as options\r\n       FROM questions q\r\n       LEFT JOIN question_options qo ON qo.question_id = q.id\r\n       WHERE q.question_set_id = $1\r\n       GROUP BY q.id\r\n       ORDER BY q.order_index`,\r\n      [qs.id],\r\n    )\r\n\r\n    const questionIds = questionsResult.rows.map((q: any) => q.id)\r\n    let answers: any[] = []\r\n\r\n    if (questionIds.length > 0) {\r\n      const answersResult = await pool.query(\r\n        `SELECT * FROM answers WHERE dossier_id = $1 AND question_id = ANY($2::uuid[])`,\r\n        [dossierId, questionIds],\r\n      )\r\n      answers = answersResult.rows\r\n    }\r\n\r\n    const answersMap = new Map(answers.map((a) => [a.question_id, a]))\r\n\r\n    for (const question of questionsResult.rows) {\r\n      const answer = answersMap.get(question.id)\r\n      const normalized = normalizeAnswer(question, answer || {})\r\n\r\n      normalizedAnswers.push({\r\n        question_code: question.code,\r\n        question_text: question.text,\r\n        value_normalized: normalized,\r\n        required: question.required,\r\n        raw_value: answer\r\n          ? {\r\n              value_text: answer.value_text,\r\n              value_number: answer.value_number,\r\n              value_json: answer.value_json,\r\n            }\r\n          : undefined,\r\n      })\r\n\r\n      if (question.required && (!normalized || normalized === '' || normalized === null)) {\r\n        missingItems.push(question.code)\r\n      }\r\n    }\r\n  }\r\n\r\n  // Buscar entidades\r\n  const entities = await fetchSectionEntities(dossierId, sectionCode)\r\n\r\n  // Calcular completude\r\n  const completionPercent = await calculateSectionCompletion(dossierId, section.id)\r\n\r\n  // Detectar flags\r\n  const snapshot: Partial<SectionSnapshot> = {\r\n    answers: normalizedAnswers,\r\n    entities,\r\n    completeness: {\r\n      percent: completionPercent,\r\n      missing_items: missingItems,\r\n    },\r\n  }\r\n\r\n  const dataQualityFlags = detectDataQualityFlags(sectionCode, snapshot)\r\n\r\n  return {\r\n    clinic: {\r\n      id: clinic.id,\r\n      name: clinic.clinic_name,\r\n    },\r\n    dossier: {\r\n      id: dossier.id,\r\n      title: dossier.title,\r\n      baseline_date: dossier.baseline_date || undefined,\r\n    },\r\n    section: {\r\n      code: section.code,\r\n      name: section.name,\r\n      description: section.description || undefined,\r\n    },\r\n    answers: normalizedAnswers,\r\n    entities,\r\n    completeness: {\r\n      percent: completionPercent,\r\n      missing_items: missingItems,\r\n    },\r\n    data_quality_flags: dataQualityFlags,\r\n    generated_at: new Date().toISOString(),\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 464, "column": 0}, "map": {"version":3,"sources":["file:///mnt/c/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/src/lib/section-prompts.ts"],"sourcesContent":["import type { SectionSnapshot } from '@/services/snapshotBuilder'\r\n\r\n/**\r\n * Sistema de prompts para geração de relatórios por seção via IA\r\n */\r\n\r\nexport function getSystemPrompt(tone: string): string {\r\n  const toneMap = {\r\n    formal: 'Você é um consultor de gestão estratégica especializado em clínicas de saúde. Use linguagem formal, técnica e objetiva. Seja preciso e baseie todas as conclusões nos dados fornecidos. Retorne suas análises em formato json estruturado.',\r\n    informal: 'Você é um mentor de negócios que fala de forma acessível e direta. Use linguagem informal e próxima, evitando jargões excessivos. Seja prático e baseie recomendações nos dados fornecidos. Retorne suas análises em formato json estruturado.',\r\n    intermediario: 'Você é um consultor experiente que equilibra profissionalismo com clareza. Use linguagem clara, mas profissional. Seja objetivo e baseie análises nos dados fornecidos. Retorne suas análises em formato json estruturado.',\r\n  }\r\n\r\n  return toneMap[tone as keyof typeof toneMap] || toneMap.intermediario\r\n}\r\n\r\n// Instruções específicas por seção\r\nconst SECTION_INSTRUCTIONS: Record<string, string> = {\r\n  IDENTITY: `\r\nVocê é um consultor sênior de estratégia para clínicas de saúde. Seu trabalho é transformar as informações fornecidas em um relatório executivo detalhado e acionável sobre a IDENTIDADE do negócio.\r\n\r\nRegras:\r\n- Não cite nem mencione livros, autores, frameworks ou \"metodologias\".\r\n- Use linguagem clara, direta e profissional, evitando jargões.\r\n- Seja específico: use os dados fornecidos (segmentos, propostas, escolhas, valores, ações críticas, características-chave).\r\n- Identifique inconsistências, lacunas e ambiguidades sem agressividade, com sugestões práticas para corrigir.\r\n- Não invente fatos: se algo não estiver no snapshot, marque como \"não informado\" e diga por que isso importa.\r\n- Trate \"Identidade\" como base de decisões: foco, posicionamento, escolhas e renúncias.\r\n- Produza um relatório bem detalhado, com seções e subtítulos, e exemplos aplicáveis ao contexto.\r\n- Ao final, gere recomendações prioritárias e um checklist de melhoria.\r\n\r\nObjetivo do relatório:\r\n- Explicar, de forma detalhada e bem descritiva, qual é a identidade estratégica da clínica (propósito, visão, valores, foco, posicionamento e escolhas).\r\n- Transformar as respostas em um \"norte\" prático: como essa identidade deve orientar decisões de público, oferta, experiência e crescimento.\r\n- Destacar contradições e lacunas e como resolvê-las.\r\n- Propor ações críticas e características-chave (se já existirem, avaliar; se não existirem, sugerir rascunhos com base no que foi fornecido, deixando claro que são sugestões).\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 900 a 1400 palavras (aprox.), com seções completas, exemplos e justificativas.\r\n- Use os dados do snapshot de forma explícita (referencie termos e decisões declaradas, sem citar o snapshot literalmente).\r\n\r\nTOM e estilo:\r\n- Profissional, claro e humano, como um consultor falando com o dono.\r\n- Não use linguagem motivacional vaga. Seja prático.\r\n- Não mencione nenhum livro, autor ou framework.\r\n\r\nAtenção ao rigor:\r\n- Não invente segmentos, serviços, preços, ou estratégias não fornecidas.\r\n- Se houver contradições, descreva a contradição e o impacto provável.\r\n- Se faltarem dados, liste perguntas de follow-up.\r\n\r\nEstrutura recomendada dentro do report_markdown:\r\n1. Resumo executivo da identidade\r\n2. Propósito e impacto\r\n3. Visão e ambição (3 anos)\r\n4. Valores inegociáveis e implicações práticas\r\n5. Escolhas de foco: público prioritário e renúncias\r\n6. Posicionamento: preço, proposta de valor e diferenciação\r\n7. Estratégia de crescimento e suas exigências\r\n8. Ações críticas (o que precisa acontecer sempre)\r\n9. Características-chave (como a clínica deve \"ser\")\r\n10. Riscos de incoerência e pontos de atenção\r\n11. Recomendações priorizadas\r\n12. Checklist de melhoria da Identidade\r\n  `,\r\n\r\n  MARKET: `\r\nAnalise o MERCADO e CONCORRÊNCIA com foco em:\r\n\r\n1. **Intensidade Competitiva**: Avalie o nível de competição no mercado local e os fatores que a determinam.\r\n\r\n2. **Diferenciais Defensáveis**: Identifique quais diferenciais da clínica são realmente defensáveis e difíceis de copiar.\r\n\r\n3. **Riscos de Guerra de Preços**: Avalie a vulnerabilidade da clínica a pressões de preço dos concorrentes.\r\n\r\n4. **Oportunidades de Posicionamento**: Identifique gaps no mercado onde a clínica pode se posicionar de forma única.\r\n\r\n5. **Análise de Concorrentes**: Compare a clínica com concorrentes diretos e indiretos, identificando pontos fortes e fracos relativos.\r\n  `,\r\n\r\n  OFFER: `\r\nAnalise a OFERTA DE SERVIÇOS com foco em:\r\n\r\n1. **Portfólio de Serviços**: Avalie se o portfólio está alinhado com a identidade estratégica e os segmentos de cliente.\r\n\r\n2. **Precificação**: Verifique se os preços estão coerentes com o posicionamento e se há serviços flagship bem definidos.\r\n\r\n3. **Estrutura de Custos**: Analise a viabilidade econômica dos serviços oferecidos.\r\n\r\n4. **Diferenciação**: Identifique quais serviços realmente diferenciam a clínica no mercado.\r\n  `,\r\n\r\n  OPERATIONS: `\r\nAnalise as OPERAÇÕES com foco em:\r\n\r\n1. **Capacidade Operacional**: Avalie se a capacidade (equipe, equipamentos, salas) está alinhada com a demanda e objetivos estratégicos.\r\n\r\n2. **Estrutura de Equipe**: Verifique se a composição da equipe suporta a proposta de valor e os serviços oferecidos.\r\n\r\n3. **Gargalos Operacionais**: Identifique limitações que podem impedir o crescimento ou a entrega da proposta de valor.\r\n\r\n4. **Eficiência**: Avalie oportunidades de melhoria operacional.\r\n  `,\r\n\r\n  PEOPLE: `\r\nVocê é um consultor especializado em gestão de pessoas e cultura organizacional para clínicas de saúde. Seu trabalho é transformar as informações fornecidas em um relatório executivo detalhado e acionável sobre PESSOAS, CULTURA & GESTÃO.\r\n\r\nRegras:\r\n- Não cite nem mencione livros, autores, frameworks ou \"metodologias\".\r\n- Use linguagem clara, direta e profissional, evitando jargões.\r\n- Seja específico: use os dados fornecidos (estrutura de equipe, dependências, cultura, liderança, accountability).\r\n- Identifique riscos humanos, gargalos de pessoas, desalinhamentos cultura-estratégia sem agressividade, com sugestões práticas.\r\n- Não invente fatos: se algo não estiver no snapshot, marque como \"não informado\" e diga por que isso importa.\r\n- Trate \"Pessoas\" como base da execução: quem faz o quê, como decidem, como são desenvolvidos e cobrados.\r\n- Produza um relatório bem detalhado, com seções e subtítulos, e exemplos aplicáveis ao contexto.\r\n- Ao final, gere recomendações prioritárias e um checklist de melhoria.\r\n\r\nObjetivo do relatório:\r\n- Avaliar se a clínica tem as pessoas certas nos lugares certos.\r\n- Identificar riscos de dependência excessiva de pessoas-chave.\r\n- Analisar se a cultura praticada apoia ou sabota a estratégia.\r\n- Avaliar modelo de liderança, tomada de decisão e accountability.\r\n- Identificar falhas em contratação, desligamento e desenvolvimento de pessoas.\r\n- Analisar o papel dos donos: operacional vs estratégico.\r\n- Mapear incentivos reais (o que é realmente recompensado e punido).\r\n\r\nEstrutura recomendada dentro do report_markdown:\r\n1. Resumo executivo da estrutura humana e cultural\r\n2. Mapa de pessoas-chave e dependências críticas\r\n3. Análise: pessoas certas nos lugares certos?\r\n4. Cultura real vs cultura declarada\r\n5. Alinhamento cultura-estratégia\r\n6. Modelo de liderança e tomada de decisão\r\n7. Sistema de accountability (metas, cobrança, consequências)\r\n8. Processos de contratação e desligamento\r\n9. Desenvolvimento de pessoas e líderes\r\n10. Papel dos donos: onde está o gargalo?\r\n11. Incentivos reais e comportamentos reforçados\r\n12. Riscos humanos e pontos de atenção\r\n13. Recomendações priorizadas\r\n14. Checklist de melhoria de Pessoas & Cultura\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 900 a 1400 palavras, com seções completas, exemplos e justificativas.\r\n- Use os dados do snapshot de forma explícita.\r\n\r\nTOM e estilo:\r\n- Profissional, claro e humano, como um consultor falando com o dono.\r\n- Não use linguagem motivacional vaga. Seja prático e honesto.\r\n- Não mencione nenhum livro, autor ou framework.\r\n\r\nAtenção ao rigor:\r\n- Não invente perfis, cargos ou estruturas não fornecidas.\r\n- Se houver contradições, descreva a contradição e o impacto provável.\r\n- Se faltarem dados, liste perguntas de follow-up.\r\n  `,\r\n\r\n  STRATEGY: `\r\nVocê é um consultor estratégico sênior especializado em clínicas de saúde. Seu trabalho é consolidar os dados dos blocos diagnósticos em uma SÍNTESE ESTRATÉGICA clara, coerente e executável.\r\n\r\nRegras:\r\n- Não cite nem mencione livros, autores, frameworks ou \"metodologias\".\r\n- Use linguagem clara, direta e profissional, evitando jargões.\r\n- Seja específico: baseie todas as conclusões nos dados fornecidos dos blocos anteriores (Identity, Market, Offer, Operations, People).\r\n- Identifique contradições entre blocos e explique as tensões de coerência.\r\n- Não invente fatos: se algo crítico não estiver nos dados, marque como \"lacuna\" e explique por que importa.\r\n- Trate \"Estratégia\" como escolhas conscientes e renúncias: o que fazer, o que NÃO fazer, e porquê.\r\n- Produza um relatório bem detalhado, com seções e subtítulos claros.\r\n- Ao final, gere 3-7 prioridades estratégicas e um checklist de melhoria.\r\n\r\nObjetivo do relatório:\r\n- Identificar o DESAFIO ESTRATÉGICO CENTRAL da clínica (o problema-guia que orienta as escolhas).\r\n- Propor 3-5 ESCOLHAS ESTRATÉGICAS claras, com trade-offs explícitos para cada uma.\r\n- Listar RENÚNCIAS CONSCIENTES (o que a clínica deve parar de fazer ou evitar).\r\n- Definir DIRETRIZES DE FOCO: segmento prioritário, proposta de valor dominante, posicionamento.\r\n- Mapear RISCOS E TENSÕES DE COERÊNCIA entre Identity, Market, Offer, Operations, People.\r\n- Propor RECOMENDAÇÕES PRIORIZADAS para resolver contradições e lacunas.\r\n\r\nEstrutura recomendada dentro do report_markdown:\r\n1. Resumo executivo da síntese estratégica\r\n2. Desafio estratégico central (problema-guia)\r\n3. Contexto consolidado (o que sabemos dos blocos diagnósticos)\r\n4. Escolhas estratégicas (3-5 escolhas com trade-offs explícitos)\r\n5. Renúncias estratégicas (o que NÃO fazer)\r\n6. Diretrizes de foco (segmento, proposta, posicionamento)\r\n7. Riscos de coerência e tensões entre blocos\r\n8. Lacunas críticas (dados faltantes que impedem clareza estratégica)\r\n9. Recomendações priorizadas (top 3-7)\r\n10. Checklist de melhoria da síntese estratégica\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 900 a 1400 palavras, com seções completas, exemplos concretos e justificativas baseadas nos dados.\r\n- Cite explicitamente dados dos blocos (ex: \"Conforme Identity, o segmento prioritário é X, mas Market mostra concorrência forte em Y\").\r\n\r\nTOM e estilo:\r\n- Profissional, claro e direto, como um consultor experiente falando com o dono.\r\n- Não use linguagem motivacional vaga. Seja prático e honesto.\r\n- Não mencione nenhum livro, autor ou framework.\r\n\r\nAtenção ao rigor:\r\n- Não invente escolhas estratégicas, segmentos ou prioridades não inferíveis dos dados.\r\n- Se houver contradições entre blocos, descreva a contradição e sugira como resolver.\r\n- Se faltarem dados críticos, liste o que falta e por que isso impede uma síntese de qualidade.\r\n  `,\r\n\r\n  PLAN: `\r\nVocê é um consultor de execução estratégica especializado em traduzir estratégia em planos executáveis. Seu trabalho é transformar a síntese estratégica em um PLANO DE EXECUÇÃO concreto com OKRs, iniciativas e sequenciamento para os próximos 12 meses.\r\n\r\nRegras:\r\n- Não cite nem mencione livros, autores, frameworks ou \"metodologias\".\r\n- Use linguagem clara, direta e profissional, evitando jargões.\r\n- Seja específico: baseie o plano na síntese estratégica (se disponível) e nos dados dos blocos diagnósticos.\r\n- Crie OKRs mensuráveis: Objectives ambiciosos + Key Results quantificáveis.\r\n- Priorize iniciativas por impacto vs esforço, e identifique dependências.\r\n- Defina responsáveis (mesmo que sejam papéis/funções, não nomes) e prazos realistas.\r\n- Não invente fatos: se dados críticos faltam, marque como \"a definir\" e explique o que precisa ser esclarecido.\r\n- Produza um relatório bem detalhado, com seções e subtítulos claros.\r\n\r\nObjetivo do relatório:\r\n- Criar 3-5 OKRs (Objectives & Key Results) alinhados às prioridades estratégicas.\r\n- Propor 7-15 INICIATIVAS priorizadas, com impacto, esforço, responsável e prazo.\r\n- Definir SEQUENCIAMENTO: o que vem antes do quê (ondas ou fases).\r\n- Mapear DEPENDÊNCIAS CRÍTICAS entre iniciativas.\r\n- Identificar RECURSOS NECESSÁRIOS e RISCOS DE EXECUÇÃO.\r\n- Propor um ROADMAP DE 12 MESES com marcos principais.\r\n\r\nEstrutura recomendada dentro do report_markdown:\r\n1. Resumo executivo do plano de execução\r\n2. Objetivos estratégicos (OKRs)\r\n   - Para cada OKR: Objective + 2-4 Key Results mensuráveis\r\n3. Iniciativas priorizadas\r\n   - Top 7-15 iniciativas com: título, descrição, impacto (alto/médio/baixo), esforço (alto/médio/baixo), responsável (papel), prazo\r\n4. Sequenciamento e dependências\r\n   - Ondas ou fases (ex: Onda 1: Jan-Abr, Onda 2: Mai-Ago, Onda 3: Set-Dez)\r\n   - Mapa de dependências (iniciativa X depende de Y estar completa)\r\n5. Roadmap de 12 meses\r\n   - Linha do tempo visual (markdown) com marcos principais\r\n6. Recursos necessários\r\n   - Pessoas, orçamento, ferramentas/sistemas, treinamento\r\n7. Riscos de execução\r\n   - Top 3-5 riscos que podem impedir execução do plano\r\n8. Checklist de preparação para execução\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 900 a 1400 palavras, com seções completas e exemplos concretos.\r\n- OKRs devem ser mensuráveis e ambiciosos (não apenas \"manter\" ou \"continuar\").\r\n- Iniciativas devem ser específicas e acionáveis (não \"melhorar atendimento\", mas \"implementar sistema de NPS pós-consulta\").\r\n\r\nTOM e estilo:\r\n- Profissional, claro e orientado à execução.\r\n- Não use linguagem motivacional vaga. Seja prático e realista.\r\n- Não mencione nenhum livro, autor ou framework.\r\n\r\nAtenção ao rigor:\r\n- Não invente iniciativas ou objetivos que não sejam inferíveis dos dados.\r\n- Se a síntese estratégica não estiver disponível, baseie-se nos blocos diagnósticos e marque \"aguardando síntese estratégica\".\r\n- Priorize qualidade sobre quantidade: melhor 7 iniciativas bem definidas do que 20 vagas.\r\n  `,\r\n\r\n  BUSINESS_MODEL: `\r\nAnalise o MODELO DE NEGÓCIO com foco em:\r\n\r\n1. **Criação de Valor**: Como a clínica cria valor para os pacientes.\r\n\r\n2. **Entrega de Valor**: Como o valor é entregue aos pacientes.\r\n\r\n3. **Captura de Valor**: Como a clínica captura valor (receita, margem).\r\n\r\n4. **Sustentabilidade**: Se o modelo é sustentável e escalável.\r\n  `,\r\n\r\n  FINAL_REPORT: `\r\nVocê é um consultor estratégico sênior especializado em estruturação, posicionamento e escala de clínicas e empresas de serviços complexos.\r\n\r\nSeu papel é produzir um RELATÓRIO EXECUTIVO FINAL de altíssimo nível a partir de múltiplos relatórios intermediários:\r\n- Identidade\r\n- Mercado\r\n- Oferta\r\n- Operações\r\n- Pessoas, Cultura & Gestão\r\n- Estratégia (síntese)\r\n- Plano (desdobramento)\r\n\r\nRegras fundamentais:\r\n\r\n1. Você NÃO deve repetir conteúdos já apresentados nos relatórios anteriores.\r\n2. Você NÃO deve explicar conceitos básicos.\r\n3. Você NÃO deve fazer um resumo seção por seção.\r\n\r\nSeu trabalho é:\r\n- Integrar\r\n- Sintetizar\r\n- Resolver conflitos\r\n- Priorizar\r\n- Fazer escolhas claras\r\n- Assumir renúncias\r\n- Apontar riscos reais\r\n- Apontar alavancas reais\r\n- Criar um plano mestre de execução\r\n\r\nO tom deve ser:\r\n- Executivo\r\n- Direto\r\n- Sem marketing\r\n- Sem frases bonitas vazias\r\n- Sem autoengano\r\n- Orientado a decisão e trade-offs\r\n\r\nVocê deve escrever como se este documento fosse:\r\n- Apresentado a sócios\r\n- Usado para planejar os próximos 12–36 meses\r\n- Usado para guiar investimento, contratações e foco estratégico\r\n\r\nVocê deve preferir:\r\n- Clareza a diplomacia\r\n- Verdade a conforto\r\n- Decisão a ambiguidade\r\n\r\nEste documento deve responder o tempo todo:\r\n\"Se eu fosse dono dessa clínica, o que eu faria a partir de amanhã?\"\r\n\r\nEstrutura obrigatória do relatório:\r\n\r\n1. **Resumo Executivo** (para sócios)\r\n   - Situação atual em 3-5 frases\r\n   - Tese estratégica em 1 parágrafo\r\n   - As 3 decisões mais importantes\r\n\r\n2. **A Tese Estratégica da Clínica**\r\n   - Qual é o jogo que a clínica está jogando?\r\n   - Por que ela pode vencer esse jogo?\r\n   - Qual é a aposta central?\r\n\r\n3. **Diagnóstico Integrado do Negócio**\r\n   - Não repita relatórios anteriores\r\n   - Integre: onde identity, market, offer, operations e people se encontram ou colidem?\r\n   - Identifique padrões e tensões estruturais\r\n\r\n4. **Os Principais Gargalos Estruturais**\r\n   - O que impede crescimento hoje?\r\n   - O que vai impedir crescimento amanhã?\r\n   - Seja específico e hierarquize\r\n\r\n5. **As Principais Alavancas de Crescimento**\r\n   - O que pode desbloquear valor rapidamente?\r\n   - O que pode desbloquear valor estruturalmente?\r\n   - Priorize por impacto vs esforço\r\n\r\n6. **As Decisões Difíceis (Renúncias Estratégicas)**\r\n   - O que a clínica deve PARAR de fazer?\r\n   - O que a clínica deve EVITAR fazer?\r\n   - Quais oportunidades devem ser conscientemente ignoradas?\r\n\r\n7. **O Plano-Mestre em 3 Horizontes**\r\n   - Horizonte 1 (0–6 meses): estabilizar e corrigir gargalos críticos\r\n   - Horizonte 2 (6–18 meses): construir capacidades e escalar\r\n   - Horizonte 3 (18–36 meses): consolidar posição e expandir\r\n\r\n8. **Mapa de Prioridades Estratégicas**\r\n   - Top 5-7 prioridades absolutas\r\n   - Para cada uma: por quê, o quê, como, quando, quem\r\n\r\n9. **Indicadores-Chave que Governam a Clínica**\r\n   - Quais 5-10 métricas realmente importam?\r\n   - O que observar semanalmente, mensalmente, trimestralmente?\r\n\r\n10. **Principais Riscos e Planos de Contenção**\r\n    - Top 3-5 riscos que podem quebrar a estratégia\r\n    - O que fazer se cada um se concretizar?\r\n\r\n11. **Conclusão Executiva: As 3 Decisões Mais Importantes**\r\n    - Se o dono pudesse tomar apenas 3 decisões nos próximos 90 dias, quais seriam?\r\n    - Por quê essas e não outras?\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 2000 a 3000 palavras.\r\n- Seja denso em conteúdo, mas claro na forma.\r\n- Use dados e insights dos relatórios anteriores sem repeti-los literalmente.\r\n\r\nTOM e estilo:\r\n- Executivo e decisivo\r\n- Honesto e direto\r\n- Orientado a ação\r\n- Sem eufemismos ou linguagem corporativa vazia\r\n\r\nAtenção ao rigor:\r\n- Não invente dados ou insights que não estejam nos relatórios fornecidos.\r\n- Seja honesto sobre lacunas e incertezas.\r\n- Priorize clareza brutal sobre conforto diplomático.\r\n  `,\r\n}\r\n\r\n// Formato de saída esperado\r\nconst OUTPUT_FORMAT = `\r\nIMPORTANTE: Responda APENAS com um objeto json válido. A resposta completa deve ser um json puro, sem texto adicional antes ou depois.\r\n\r\nVocê DEVE retornar um JSON válido com a seguinte estrutura EXATA:\r\n\r\n{\r\n  \"report_markdown\": \"# Relatório da Seção [Nome da Seção]\\\\n\\\\n[Conteúdo completo em Markdown]\",\r\n  \"insights\": {\r\n    \"score\": {\r\n      \"clarity\": 0-10,\r\n      \"consistency\": 0-10,\r\n      \"completeness\": 0-10,\r\n      \"impact_potential\": 0-10\r\n    },\r\n    \"identity_summary\": {\r\n      \"purpose\": \"...\",\r\n      \"vision\": \"...\",\r\n      \"values\": [\"...\", \"...\"],\r\n      \"priority_audience\": \"...\",\r\n      \"positioning\": \"...\",\r\n      \"growth_focus\": \"...\"\r\n    },\r\n    \"alerts\": [\r\n      {\r\n        \"severity\": \"high|medium|low\",\r\n        \"title\": \"Título do alerta\",\r\n        \"detail\": \"Descrição detalhada\",\r\n        \"evidence\": [\"question_code ou referência a entidade\"]\r\n      }\r\n    ],\r\n    \"recommendations\": [\r\n      {\r\n        \"priority\": 1-5,\r\n        \"title\": \"Título da recomendação\",\r\n        \"detail\": \"Descrição detalhada\",\r\n        \"effort\": \"low|medium|high\",\r\n        \"expected_impact\": \"low|medium|high\"\r\n      }\r\n    ],\r\n    \"missing_data\": [\r\n      {\r\n        \"item\": \"O que está faltando\",\r\n        \"why_it_matters\": \"Por que isso importa\",\r\n        \"how_to_fill\": \"Como preencher\"\r\n      }\r\n    ],\r\n    \"contradictions\": [\r\n      {\r\n        \"title\": \"Título da contradição\",\r\n        \"detail\": \"Descrição detalhada\",\r\n        \"evidence\": [\"referências aos dados\"]\r\n      }\r\n    ],\r\n    \"checklist\": [\"...\", \"...\"],\r\n    \"tags\": [\"tag1\", \"tag2\"]\r\n  }\r\n}\r\n\r\nIMPORTANTE:\r\n- O report_markdown deve ser completo e descritivo, incluindo:\r\n  * Resumo executivo (5-8 linhas)\r\n  * O que está bem definido (bullet points)\r\n  * Lacunas relevantes (o que falta e por que importa)\r\n  * Riscos e contradições (com referências aos dados)\r\n  * Recomendações práticas (priorizadas, com \"por quê\")\r\n  * Checklist de melhoria (itens objetivos)\r\n  * Pontuação (0-10) para clareza, consistência, completude, potencial de impacto\r\n\r\n- O insights JSON deve ser válido e parseável sem ambiguidades.\r\n- Todos os campos são obrigatórios (arrays podem estar vazios).\r\n- Para seções que não sejam IDENTITY, o campo \"identity_summary\" pode ser um objeto vazio {}.\r\n`\r\n\r\n/**\r\n * Constrói o prompt completo para geração de relatório de uma seção\r\n */\r\nexport function buildSectionReportPrompt(\r\n  sectionCode: string,\r\n  snapshot: SectionSnapshot,\r\n  tone: string = 'intermediario',\r\n): string {\r\n  const sectionInstruction = SECTION_INSTRUCTIONS[sectionCode] || `\r\nAnalise a seção ${sectionCode} com base nos dados fornecidos.\r\nIdentifique pontos fortes, lacunas, riscos e oportunidades.\r\n  `\r\n\r\n  // Para IDENTITY, usar prompt específico com snapshot JSON diretamente\r\n  if (sectionCode === 'IDENTITY') {\r\n    const snapshotJson = JSON.stringify(snapshot, null, 2)\r\n    \r\n    return `\r\n${sectionInstruction}\r\n\r\nGere um RELATÓRIO EXECUTIVO DE IDENTIDADE da clínica com base no snapshot abaixo.\r\n\r\nObjetivo do relatório:\r\n- Explicar, de forma detalhada e bem descritiva, qual é a identidade estratégica da clínica (propósito, visão, valores, foco, posicionamento e escolhas).\r\n- Transformar as respostas em um \"norte\" prático: como essa identidade deve orientar decisões de público, oferta, experiência e crescimento.\r\n- Destacar contradições e lacunas e como resolvê-las.\r\n- Propor ações críticas e características-chave (se já existirem, avaliar; se não existirem, sugerir rascunhos com base no que foi fornecido, deixando claro que são sugestões).\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 900 a 1400 palavras (aprox.), com seções completas, exemplos e justificativas.\r\n- Use os dados do snapshot de forma explícita (referencie termos e decisões declaradas, sem citar o snapshot literalmente).\r\n\r\nTOM e estilo:\r\n- Profissional, claro e humano, como um consultor falando com o dono.\r\n- Não use linguagem motivacional vaga. Seja prático.\r\n- Não mencione nenhum livro, autor ou framework.\r\n\r\nAtenção ao rigor:\r\n- Não invente segmentos, serviços, preços, ou estratégias não fornecidas.\r\n- Se houver contradições, descreva a contradição e o impacto provável.\r\n- Se faltarem dados, liste perguntas de follow-up.\r\n\r\nSnapshot (JSON):\r\n${snapshotJson}\r\n\r\n${OUTPUT_FORMAT}\r\n\r\nIMPORTANTE: \r\n- O report_markdown DEVE ser COMPLETO e NÃO CORTADO. \r\n- Se o limite de tokens for atingido, priorize completar o report_markdown mesmo que alguns campos do insights fiquem vazios.\r\n- O relatório deve ter TODAS as 12 seções mencionadas na estrutura recomendada.\r\n- NÃO corte o conteúdo no meio de uma frase ou seção.\r\n  `.trim()\r\n  }\r\n\r\n  // Para outras seções, usar formato padrão\r\n  return `\r\n${sectionInstruction}\r\n\r\n**DADOS DA CLÍNICA E DO DOSSIÊ:**\r\n\r\nClínica: ${snapshot.clinic.name} (ID: ${snapshot.clinic.id})\r\nDossiê: ${snapshot.dossier.title}\r\nData de referência: ${snapshot.dossier.baseline_date || 'Não definida'}\r\n\r\n**SEÇÃO:** ${snapshot.section.name}\r\n${snapshot.section.description ? `Descrição: ${snapshot.section.description}` : ''}\r\n\r\n**COMPLETUDE DA SEÇÃO:** ${snapshot.completeness.percent}%\r\n${snapshot.completeness.missing_items.length > 0 ? `Itens faltantes: ${snapshot.completeness.missing_items.join(', ')}` : ''}\r\n\r\n**RESPOSTAS DO QUESTIONÁRIO:**\r\n\r\n${snapshot.answers.map((a) => `\r\n**${a.question_text}** (${a.question_code})\r\n${a.required ? '[OBRIGATÓRIO]' : '[OPCIONAL]'}\r\nResposta: ${formatAnswerValue(a.value_normalized)}\r\n${a.required && !a.value_normalized ? '⚠️ NÃO PREENCHIDO' : ''}\r\n`).join('\\n')}\r\n\r\n**ENTIDADES ESTRUTURADAS:**\r\n\r\n${Object.entries(snapshot.entities)\r\n  .map(([key, values]) => {\r\n    if (!values || values.length === 0) return `**${key}**: Nenhum cadastrado`\r\n    return `**${key}** (${values.length} item(s)):\\n${values.map((v: any) => `- ${formatEntityValue(v)}`).join('\\n')}`\r\n  })\r\n  .join('\\n\\n')}\r\n\r\n**FLAGS DE QUALIDADE DE DADOS:**\r\n\r\n${snapshot.data_quality_flags.length > 0\r\n  ? snapshot.data_quality_flags.map((flag) => `⚠️ ${flag}`).join('\\n')\r\n  : 'Nenhum flag detectado'}\r\n\r\n---\r\n\r\n${OUTPUT_FORMAT}\r\n\r\nGere o relatório completo e os insights estruturados baseados EXCLUSIVAMENTE nos dados fornecidos acima.\r\nSeja específico, cite dados concretos e evite generalizações.\r\n  `.trim()\r\n}\r\n\r\n/**\r\n * Formata o valor de uma resposta para exibição no prompt\r\n */\r\nfunction formatAnswerValue(value: any): string {\r\n  if (value === null || value === undefined || value === '') {\r\n    return '[Não preenchido]'\r\n  }\r\n\r\n  if (typeof value === 'object') {\r\n    if (Array.isArray(value)) {\r\n      return value.length > 0 ? value.join(', ') : '[Vazio]'\r\n    }\r\n    if (value.formatted) {\r\n      return value.formatted\r\n    }\r\n    return JSON.stringify(value)\r\n  }\r\n\r\n  return String(value)\r\n}\r\n\r\n/**\r\n * Formata uma entidade para exibição no prompt\r\n */\r\nfunction formatEntityValue(entity: any): string {\r\n  if (entity.name) return entity.name\r\n  if (entity.title) return entity.title\r\n  return JSON.stringify(entity)\r\n}\r\n\r\n/**\r\n * Formata o snapshot completo para o prompt\r\n */\r\nfunction formatSnapshotForPrompt(snapshot: SectionSnapshot): string {\r\n  return JSON.stringify(snapshot, null, 2)\r\n}\r\n\r\n/**\r\n * Constrói o prompt para geração do Relatório Final consolidado\r\n */\r\nexport function buildFinalReportPrompt(\r\n  snapshot: any, // FinalSnapshot\r\n  tone: string = 'intermediario',\r\n): string {\r\n  const finalReportInstruction = `\r\n${SECTION_INSTRUCTIONS['FINAL_REPORT']}\r\n\r\n**CONTEXTO:**\r\nVocê recebeu relatórios detalhados de cada área estratégica da clínica. Algumas áreas podem estar completas, outras podem ter lacunas.\r\n\r\n**DADOS CONSOLIDADOS:**\r\n\r\nClínica: ${snapshot.clinic.name}\r\nDossiê: ${snapshot.dossier.title}\r\nData de referência: ${snapshot.dossier.baseline_date || 'Não definida'}\r\n\r\n**MÉTRICAS GLOBAIS:**\r\n\r\nScores Médios:\r\n- Clareza: ${snapshot.global_metrics.average_scores.clarity.toFixed(1)}/10\r\n- Consistência: ${snapshot.global_metrics.average_scores.consistency.toFixed(1)}/10\r\n- Completude: ${snapshot.global_metrics.average_scores.completeness.toFixed(1)}/10\r\n- Potencial de Impacto: ${snapshot.global_metrics.average_scores.impact_potential.toFixed(1)}/10\r\n\r\nAlertas:\r\n- Alta severidade: ${snapshot.global_metrics.high_severity_alerts}\r\n- Média severidade: ${snapshot.global_metrics.medium_severity_alerts}\r\n- Baixa severidade: ${snapshot.global_metrics.low_severity_alerts}\r\n\r\nTotal de recomendações: ${snapshot.global_metrics.total_recommendations}\r\n\r\n**RELAÇÃO DE SEÇÕES:**\r\n\r\n${snapshot.sections.map((section: any) => {\r\n  const status = section.has_report\r\n    ? section.is_stale\r\n      ? '⚠️ DESATUALIZADO'\r\n      : '✅ ATUALIZADO'\r\n    : '❌ NÃO GERADO'\r\n  return `\r\n**${section.section_name}** (${section.section_code}) - ${status}\r\n${section.has_report ? `Scores: C=${section.scores?.clarity || 0}/10, Co=${section.scores?.consistency || 0}/10, Cp=${section.scores?.completeness || 0}/10, I=${section.scores?.impact_potential || 0}/10` : 'Sem relatório disponível'}\r\n${section.alerts && section.alerts.length > 0 ? `Alertas: ${section.alerts.length} (${section.alerts.filter((a: any) => a.severity === 'high').length} alta, ${section.alerts.filter((a: any) => a.severity === 'medium').length} média, ${section.alerts.filter((a: any) => a.severity === 'low').length} baixa)` : ''}\r\n${section.recommendations && section.recommendations.length > 0 ? `Recomendações: ${section.recommendations.length}` : ''}\r\n${section.report_markdown ? `\\nResumo do relatório:\\n${section.report_markdown.substring(0, 500)}...` : ''}\r\n`\r\n}).join('\\n')}\r\n\r\n${snapshot.missing_sections.length > 0 ? `\\n⚠️ **SEÇÕES SEM RELATÓRIO:** ${snapshot.missing_sections.join(', ')}\\nExplique no relatório que essas áreas não foram analisadas e por que isso importa.` : ''}\r\n\r\n${snapshot.stale_sections.length > 0 ? `\\n⚠️ **SEÇÕES DESATUALIZADAS:** ${snapshot.stale_sections.join(', ')}\\nOs dados dessas seções foram alterados após a geração dos relatórios.` : ''}\r\n\r\n**TOP RECOMENDAÇÕES (agrupadas):**\r\n\r\n${snapshot.global_metrics.top_recommendations.slice(0, 10).map((rec: any, idx: number) => \r\n  `${idx + 1}. ${rec.title} (Prioridade: ${rec.priority}, Mencionada ${rec.frequency}x)`\r\n).join('\\n')}\r\n\r\n---\r\n\r\n**FORMATO DE SAÍDA ESPERADO:**\r\n\r\nVocê DEVE retornar um JSON válido com a seguinte estrutura EXATA:\r\n\r\n{\r\n  \"report_markdown\": \"# Relatório Estratégico Consolidado\\\\n\\\\n[Conteúdo completo em Markdown seguindo a estrutura obrigatória acima]\",\r\n  \"insights\": {\r\n    \"global_score\": {\r\n      \"clarity\": 0-10,\r\n      \"consistency\": 0-10,\r\n      \"completeness\": 0-10,\r\n      \"impact_potential\": 0-10\r\n    },\r\n    \"top_priorities\": [\r\n      {\r\n        \"rank\": 1-7,\r\n        \"title\": \"Título da prioridade\",\r\n        \"rationale\": \"Por que é prioridade\",\r\n        \"expected_impact\": \"high|medium|low\",\r\n        \"effort\": \"high|medium|low\"\r\n      }\r\n    ],\r\n    \"critical_risks\": [\r\n      {\r\n        \"severity\": \"high|medium|low\",\r\n        \"title\": \"Título do risco\",\r\n        \"detail\": \"Descrição detalhada\",\r\n        \"affected_sections\": [\"IDENTITY\", \"MARKET\", ...]\r\n      }\r\n    ],\r\n    \"key_opportunities\": [\r\n      {\r\n        \"title\": \"Título da oportunidade\",\r\n        \"detail\": \"Descrição\",\r\n        \"potential_impact\": \"high|medium|low\",\r\n        \"effort_required\": \"high|medium|low\"\r\n      }\r\n    ],\r\n    \"strategic_focus\": [\"foco 1\", \"foco 2\", ...],\r\n    \"kill_list\": [\"coisa a parar de fazer 1\", \"coisa a parar de fazer 2\", ...],\r\n    \"missing_sections\": [\"seção sem relatório 1\", ...]\r\n  }\r\n}\r\n\r\n**INSTRUÇÕES IMPORTANTES:**\r\n\r\n- O report_markdown deve seguir EXATAMENTE a estrutura de 11 seções definida nas instruções iniciais\r\n- Seja específico e cite dados concretos dos relatórios setoriais fornecidos\r\n- Priorize clareza e acionabilidade sobre complexidade\r\n- Identifique contradições entre seções e resolva-as explicitamente\r\n- Seja honesto sobre lacunas (seções faltantes ou desatualizadas)\r\n- O relatório deve responder: \"Se eu fosse dono dessa clínica, o que eu faria a partir de amanhã?\"\r\n- Use tom ${tone === 'formal' ? 'formal e técnico' : tone === 'informal' ? 'acessível e direto' : 'executivo e profissional'}\r\n- O documento deve ter entre 2000-3000 palavras\r\n\r\nGere o relatório final completo e os insights estruturados baseados EXCLUSIVAMENTE nos dados fornecidos acima.\r\n  `.trim()\r\n\r\n  return finalReportInstruction\r\n}\r\n\r\n/**\r\n * Exporta SECTION_INSTRUCTIONS para uso no admin\r\n */\r\nexport function getSectionInstruction(sectionCode: string): string {\r\n  return SECTION_INSTRUCTIONS[sectionCode] || ''\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1159, "column": 0}, "map": {"version":3,"sources":["file:///mnt/c/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/src/lib/api-shared/section-ai-client.ts"],"sourcesContent":["// Versão server-side do AI client\r\nimport { getSystemPrompt, buildSectionReportPrompt } from '@/lib/section-prompts'\r\nimport type { SectionSnapshot } from './snapshotBuilder'\r\nimport pool from './db'\r\n\r\nexport interface InsightsJSON {\r\n  score: {\r\n    clarity: number\r\n    consistency: number\r\n    completeness: number\r\n    impact_potential: number\r\n  }\r\n  identity_summary?: {\r\n    purpose?: string\r\n    vision?: string\r\n    values?: string[]\r\n    priority_audience?: string\r\n    positioning?: string\r\n    growth_focus?: string\r\n  }\r\n  alerts: Array<{\r\n    severity: 'high' | 'medium' | 'low'\r\n    title: string\r\n    detail: string\r\n    evidence: string[]\r\n  }>\r\n  recommendations: Array<{\r\n    priority: number\r\n    title: string\r\n    detail: string\r\n    effort: 'low' | 'medium' | 'high'\r\n    expected_impact: 'low' | 'medium' | 'high'\r\n  }>\r\n  missing_data: Array<{\r\n    item: string\r\n    why_it_matters: string\r\n    how_to_fill: string\r\n  }>\r\n  contradictions: Array<{\r\n    title: string\r\n    detail: string\r\n    evidence: string[]\r\n  }>\r\n  checklist?: string[]\r\n  tags: string[]\r\n}\r\n\r\nexport interface AIReportResponse {\r\n  report_markdown: string\r\n  insights: InsightsJSON\r\n}\r\n\r\nexport interface GenerateOptions {\r\n  apiKey: string\r\n  model?: string\r\n  temperature?: number\r\n  promptVersion?: string\r\n  tone?: string\r\n}\r\n\r\nconst DEFAULT_MODEL = 'gpt-4o'\r\nconst DEFAULT_TEMPERATURE = 0.5 // 0.4-0.6 para IDENTITY conforme especificado\r\nconst DEFAULT_TONE = 'intermediario'\r\n\r\n/**\r\n * Busca prompt customizado do banco de dados\r\n * Retorna null se não encontrar, para usar fallback do código\r\n */\r\nasync function getCustomPromptFromDB(\r\n  promptKey: string,\r\n): Promise<{ system_prompt: string | null; user_prompt: string | null } | null> {\r\n  try {\r\n    const result = await pool.query(\r\n      `SELECT system_prompt, user_prompt\r\n       FROM ai_prompt_templates\r\n       WHERE key = $1 AND is_active = true\r\n       ORDER BY created_at DESC\r\n       LIMIT 1`,\r\n      [promptKey],\r\n    )\r\n\r\n    if (result.rows.length > 0) {\r\n      return {\r\n        system_prompt: result.rows[0].system_prompt,\r\n        user_prompt: result.rows[0].user_prompt,\r\n      }\r\n    }\r\n\r\n    return null\r\n  } catch (error: any) {\r\n    console.warn('Erro ao buscar prompt do banco:', error.message)\r\n    return null\r\n  }\r\n}\r\n\r\n/**\r\n * Substitui placeholders no user prompt (ex: {{SNAPSHOT_JSON}})\r\n */\r\nfunction replacePlaceholders(userPrompt: string, snapshot: SectionSnapshot): string {\r\n  const snapshotJson = JSON.stringify(snapshot, null, 2)\r\n  return userPrompt.replace(/\\{\\{SNAPSHOT_JSON\\}\\}/g, snapshotJson)\r\n}\r\n\r\nexport async function generateSectionReport(\r\n  sectionCode: string,\r\n  snapshot: SectionSnapshot,\r\n  options: GenerateOptions,\r\n): Promise<{\r\n  report_markdown: string\r\n  insights: InsightsJSON\r\n  token_usage?: any\r\n}> {\r\n  const {\r\n    apiKey,\r\n    model = DEFAULT_MODEL,\r\n    temperature = DEFAULT_TEMPERATURE,\r\n    tone = DEFAULT_TONE,\r\n  } = options\r\n\r\n  let systemPrompt: string\r\n  let userPrompt: string\r\n  \r\n  try {\r\n    // Tentar buscar prompt customizado do banco primeiro\r\n    const promptKey = `section_${sectionCode}`\r\n    const customPrompt = await getCustomPromptFromDB(promptKey)\r\n\r\n    if (customPrompt && (customPrompt.system_prompt || customPrompt.user_prompt)) {\r\n      // Usar prompts customizados do banco\r\n      systemPrompt = customPrompt.system_prompt || getSystemPrompt(tone)\r\n      \r\n      if (customPrompt.user_prompt) {\r\n        // Substituir placeholders no user prompt\r\n        userPrompt = replacePlaceholders(customPrompt.user_prompt, snapshot)\r\n      } else {\r\n        // Se não tiver user_prompt customizado, usar o do código\r\n        userPrompt = buildSectionReportPrompt(sectionCode, snapshot, tone)\r\n      }\r\n      \r\n      console.log(`Usando prompts customizados do banco para ${sectionCode}`)\r\n    } else {\r\n      // Fallback: usar prompts do código\r\n      systemPrompt = getSystemPrompt(tone)\r\n      userPrompt = buildSectionReportPrompt(sectionCode, snapshot, tone)\r\n      console.log(`Usando prompts do código para ${sectionCode}`)\r\n    }\r\n  } catch (importError: any) {\r\n    console.error('Erro ao carregar prompts:', importError)\r\n    // Fallback em caso de erro\r\n    systemPrompt = getSystemPrompt(tone)\r\n    userPrompt = buildSectionReportPrompt(sectionCode, snapshot, tone)\r\n  }\r\n\r\n  // 8000 tokens para todas as seções - suficiente para relatórios completos + JSON structure\r\n  const maxTokens = 8000\r\n\r\n  let response: Response\r\n  try {\r\n    response = await fetch('https://api.openai.com/v1/chat/completions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        Authorization: `Bearer ${apiKey}`,\r\n      },\r\n      body: JSON.stringify({\r\n        model,\r\n        messages: [\r\n          {\r\n            role: 'system',\r\n            content: systemPrompt,\r\n          },\r\n          {\r\n            role: 'user',\r\n            content: userPrompt,\r\n          },\r\n        ],\r\n        temperature,\r\n        max_tokens: maxTokens,\r\n        response_format: { type: 'json_object' },\r\n      }),\r\n    })\r\n  } catch (fetchError: any) {\r\n    console.error('Erro na requisição para OpenAI:', fetchError)\r\n    throw new Error(`Erro de conexão com OpenAI: ${fetchError.message}`)\r\n  }\r\n\r\n  if (!response.ok) {\r\n    const errorText = await response.text().catch(() => response.statusText)\r\n    let errorData: any\r\n    try {\r\n      errorData = JSON.parse(errorText)\r\n    } catch {\r\n      errorData = { error: { message: errorText } }\r\n    }\r\n    console.error('Erro da API OpenAI:', errorData)\r\n    throw new Error(`Erro na API OpenAI: ${errorData.error?.message || response.statusText} (Status: ${response.status})`)\r\n  }\r\n\r\n  let data: any\r\n  try {\r\n    data = await response.json()\r\n  } catch (parseError: any) {\r\n    console.error('Erro ao parsear resposta da OpenAI:', parseError)\r\n    throw new Error('Resposta inválida da OpenAI')\r\n  }\r\n\r\n  const content = data.choices[0]?.message?.content\r\n\r\n  if (!content) {\r\n    console.error('Resposta vazia da OpenAI. Data recebida:', JSON.stringify(data).substring(0, 500))\r\n    throw new Error('Resposta vazia da OpenAI')\r\n  }\r\n\r\n  // Verificar se a resposta foi cortada (finish_reason = 'length')\r\n  const finishReason = data.choices[0]?.finish_reason\r\n  if (finishReason === 'length') {\r\n    console.warn('⚠️ ATENÇÃO: Resposta da IA foi cortada por limite de tokens!')\r\n    console.warn('Token usage:', data.usage)\r\n    console.warn('Tamanho do conteúdo recebido:', content.length, 'caracteres')\r\n  }\r\n\r\n  try {\r\n    const parsed = parseAIResponse(content)\r\n\r\n    // Verificar se o report_markdown está completo\r\n    if (parsed.report_markdown) {\r\n      console.log(`Report markdown gerado: ${parsed.report_markdown.length} caracteres`)\r\n      if (finishReason === 'length' && parsed.report_markdown.length < 2000) {\r\n        console.warn('⚠️ Relatório pode estar incompleto devido ao limite de tokens')\r\n      }\r\n    }\r\n\r\n    return {\r\n      report_markdown: parsed.report_markdown,\r\n      insights: parsed.insights,\r\n      token_usage: data.usage,\r\n    }\r\n  } catch (parseError: any) {\r\n    console.error('Erro ao parsear resposta da IA:', parseError)\r\n    console.error('Conteúdo recebido (primeiros 1000 chars):', content.substring(0, 1000))\r\n    console.error('Conteúdo recebido (últimos 500 chars):', content.substring(Math.max(0, content.length - 500)))\r\n    throw new Error(`Erro ao processar resposta da IA: ${parseError.message}`)\r\n  }\r\n}\r\n\r\nfunction parseAIResponse(content: string): AIReportResponse {\r\n  // Log do conteúdo recebido para debug\r\n  console.log('Parseando resposta da IA. Tamanho:', content.length)\r\n  console.log('Primeiros 500 caracteres:', content.substring(0, 500))\r\n\r\n  // 1. Tentar parse JSON direto\r\n  try {\r\n    const parsed = JSON.parse(content)\r\n    if (validateAIResponse(parsed)) {\r\n      console.log('Parse bem-sucedido: JSON direto válido')\r\n      return parsed\r\n    } else {\r\n      console.warn('JSON parseado mas validação falhou')\r\n    }\r\n  } catch (error: any) {\r\n    console.log('Erro no parse JSON direto:', error.message)\r\n  }\r\n\r\n  // 2. Tentar extrair JSON de markdown code blocks\r\n  try {\r\n    const jsonMatch = content.match(/```json\\s*([\\s\\S]*?)\\s*```/) || content.match(/\\{[\\s\\S]*\\}/)\r\n    if (jsonMatch) {\r\n      const jsonStr = jsonMatch[1] || jsonMatch[0]\r\n      const parsed = JSON.parse(jsonStr)\r\n      if (validateAIResponse(parsed)) {\r\n        console.log('Parse bem-sucedido: JSON extraído de markdown')\r\n        return parsed\r\n      } else {\r\n        console.warn('JSON extraído mas validação falhou')\r\n      }\r\n    }\r\n  } catch (error: any) {\r\n    console.log('Erro ao extrair JSON de markdown:', error.message)\r\n  }\r\n\r\n  // 3. Tentar corrigir estrutura (campos faltantes)\r\n  try {\r\n    const parsed = JSON.parse(content)\r\n    const corrected = {\r\n      report_markdown: parsed.report_markdown || parsed.report || '# Relatório\\n\\nErro ao processar resposta.',\r\n      insights: correctInsightsStructure(parsed.insights || parsed),\r\n    }\r\n    if (validateAIResponse(corrected)) {\r\n      console.log('Parse bem-sucedido: JSON corrigido')\r\n      return corrected\r\n    } else {\r\n      console.warn('JSON corrigido mas validação ainda falhou')\r\n      // Verificar se o report_markdown está presente e tem tamanho razoável\r\n      if (corrected.report_markdown && corrected.report_markdown.length > 100) {\r\n        console.warn('Retornando resposta parcial (sem validação completa) - report_markdown presente')\r\n        return corrected as AIReportResponse\r\n      }\r\n    }\r\n  } catch (error: any) {\r\n    console.log('Erro ao corrigir JSON:', error.message)\r\n    // Se o erro for de JSON truncado, tentar extrair o que for possível\r\n    if (error.message.includes('Unexpected end') || error.message.includes('truncated')) {\r\n      console.warn('JSON parece estar truncado. Tentando extrair conteúdo parcial...')\r\n      try {\r\n        // Tentar encontrar o report_markdown mesmo com JSON incompleto\r\n        const markdownMatch = content.match(/\"report_markdown\"\\s*:\\s*\"([^\"]*(?:\\\\.[^\"]*)*)\"/)\r\n        if (markdownMatch && markdownMatch[1]) {\r\n          const extractedMarkdown = markdownMatch[1].replace(/\\\\n/g, '\\n').replace(/\\\\\"/g, '\"')\r\n          console.warn('Extraído report_markdown parcial do JSON truncado')\r\n          return {\r\n            report_markdown: extractedMarkdown,\r\n            insights: correctInsightsStructure({}),\r\n          }\r\n        }\r\n      } catch (extractError) {\r\n        console.error('Erro ao extrair conteúdo parcial:', extractError)\r\n      }\r\n    }\r\n  }\r\n\r\n  // 4. Última tentativa: criar resposta mínima\r\n  console.error('Não foi possível parsear resposta. Tamanho do conteúdo:', content.length)\r\n  console.error('Primeiros 500 chars:', content.substring(0, 500))\r\n  console.error('Últimos 500 chars:', content.substring(Math.max(0, content.length - 500)))\r\n  throw new Error(`Não foi possível parsear a resposta da IA. Formato inválido. Tamanho: ${content.length} caracteres`)\r\n}\r\n\r\nfunction validateAIResponse(data: any): data is AIReportResponse {\r\n  if (!data || typeof data !== 'object') return false\r\n  if (!data.report_markdown || typeof data.report_markdown !== 'string') return false\r\n  if (!data.insights || typeof data.insights !== 'object') return false\r\n\r\n  const insights = data.insights\r\n  if (!insights.score || typeof insights.score !== 'object') return false\r\n  if (typeof insights.score.clarity !== 'number') return false\r\n  if (typeof insights.score.consistency !== 'number') return false\r\n  if (typeof insights.score.completeness !== 'number') return false\r\n  if (typeof insights.score.impact_potential !== 'number') return false\r\n\r\n  // identity_summary é opcional (apenas para IDENTITY)\r\n  if (insights.identity_summary && typeof insights.identity_summary !== 'object') return false\r\n\r\n  if (!Array.isArray(insights.alerts)) return false\r\n  if (!Array.isArray(insights.recommendations)) return false\r\n  if (!Array.isArray(insights.missing_data)) return false\r\n  if (!Array.isArray(insights.contradictions)) return false\r\n  if (insights.checklist && !Array.isArray(insights.checklist)) return false\r\n  if (!Array.isArray(insights.tags)) return false\r\n\r\n  return true\r\n}\r\n\r\nfunction correctInsightsStructure(insights: any): InsightsJSON {\r\n  return {\r\n    score: {\r\n      clarity: insights.score?.clarity ?? insights.clarity ?? 5,\r\n      consistency: insights.score?.consistency ?? insights.consistency ?? 5,\r\n      completeness: insights.score?.completeness ?? insights.completeness ?? 5,\r\n      impact_potential: insights.score?.impact_potential ?? insights.impact_potential ?? 5,\r\n    },\r\n    identity_summary: insights.identity_summary || undefined,\r\n    alerts: Array.isArray(insights.alerts) ? insights.alerts : [],\r\n    recommendations: Array.isArray(insights.recommendations) ? insights.recommendations : [],\r\n    missing_data: Array.isArray(insights.missing_data) ? insights.missing_data : [],\r\n    contradictions: Array.isArray(insights.contradictions) ? insights.contradictions : [],\r\n    checklist: Array.isArray(insights.checklist) ? insights.checklist : undefined,\r\n    tags: Array.isArray(insights.tags) ? insights.tags : [],\r\n  }\r\n}\r\n\r\nexport async function generateSectionReportWithRetry(\r\n  sectionCode: string,\r\n  snapshot: SectionSnapshot,\r\n  options: GenerateOptions,\r\n): Promise<{\r\n  report_markdown: string\r\n  insights: InsightsJSON\r\n  token_usage?: any\r\n}> {\r\n  try {\r\n    return await generateSectionReport(sectionCode, snapshot, options)\r\n  } catch (error: any) {\r\n    console.warn('Primeira tentativa falhou, tentando novamente...', error.message)\r\n    try {\r\n      return await generateSectionReport(sectionCode, snapshot, options)\r\n    } catch (retryError: any) {\r\n      throw new Error(`Falha após retry: ${retryError.message}`)\r\n    }\r\n  }\r\n}\r\n\r\n\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1460, "column": 0}, "map": {"version":3,"sources":["file:///mnt/c/Users/Leonardo%20Machado/Documents/Planeamento%20dental/planeamento-dental/pages/api/dossiers/%5Bid%5D/sections/%5BsectionCode%5D/report.ts"],"sourcesContent":["import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { authenticateToken, AuthRequest } from '@/lib/api-shared/auth'\r\nimport pool from '@/lib/api-shared/db'\r\nimport { buildSectionSnapshot } from '@/lib/api-shared/snapshotBuilder'\r\nimport { generateSectionReportWithRetry } from '@/lib/api-shared/section-ai-client'\r\n\r\nexport default async function handler(\r\n  req: VercelRequest,\r\n  res: VercelResponse,\r\n) {\r\n  res.setHeader('Access-Control-Allow-Credentials', 'true')\r\n  res.setHeader('Access-Control-Allow-Origin', '*')\r\n  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT')\r\n  res.setHeader('Access-Control-Allow-Headers', 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization')\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    res.status(200).end()\r\n    return\r\n  }\r\n\r\n  return authenticateToken(req as AuthRequest, res, async () => {\r\n    try {\r\n      const { method } = req\r\n      const authReq = req as AuthRequest\r\n      const user = authReq.user!\r\n      const dossierId = req.query.id as string\r\n      const sectionCode = req.query.sectionCode as string\r\n\r\n      if (!dossierId || !sectionCode) {\r\n        return res.status(400).json({ error: 'dossierId e sectionCode são obrigatórios' })\r\n      }\r\n\r\n      // Validar acesso ao dossiê\r\n      const dossierResult = await pool.query(\r\n        'SELECT clinic_id FROM dossiers WHERE id = $1',\r\n        [dossierId],\r\n      )\r\n\r\n      if (dossierResult.rows.length === 0) {\r\n        return res.status(404).json({ error: 'Dossiê não encontrado' })\r\n      }\r\n\r\n      const clinicId = dossierResult.rows[0].clinic_id\r\n\r\n      if (user.role !== 'admin' && user.clinicId !== clinicId) {\r\n        return res.status(403).json({ error: 'Acesso negado a este dossiê' })\r\n      }\r\n\r\n      // Validar seção\r\n      const sectionResult = await pool.query('SELECT id FROM sections WHERE code = $1', [\r\n        sectionCode,\r\n      ])\r\n\r\n      if (sectionResult.rows.length === 0) {\r\n        return res.status(404).json({ error: 'Seção não encontrada' })\r\n      }\r\n\r\n      const sectionId = sectionResult.rows[0].id\r\n\r\n      if (method === 'GET') {\r\n        // Retornar último relatório da seção\r\n        try {\r\n          const reportResult = await pool.query(\r\n            `SELECT * FROM ai_reports \r\n             WHERE dossier_id = $1 AND section_code = $2 \r\n             ORDER BY created_at DESC \r\n             LIMIT 1`,\r\n            [dossierId, sectionCode],\r\n          )\r\n\r\n          if (reportResult.rows.length === 0) {\r\n            return res.status(404).json({ error: 'Relatório ainda não gerado para esta seção' })\r\n          }\r\n\r\n          const report = reportResult.rows[0]\r\n          return res.status(200).json({\r\n            id: report.id,\r\n            status: report.status,\r\n            report_markdown: report.report_markdown,\r\n            insights: report.insights_json,\r\n            created_at: report.created_at,\r\n            updated_at: report.updated_at,\r\n            prompt_key: report.prompt_key,\r\n            prompt_version: report.prompt_version,\r\n            model: report.model,\r\n          })\r\n        } catch (dbError: any) {\r\n          console.error('Erro ao buscar relatório:', dbError)\r\n          return res.status(500).json({ \r\n            error: 'Erro ao buscar relatório',\r\n            message: dbError.message \r\n          })\r\n        }\r\n      }\r\n\r\n      if (method === 'POST') {\r\n        // Gerar novo relatório\r\n        const apiKey = process.env.OPENAI_API_KEY\r\n        if (!apiKey) {\r\n          console.error('OPENAI_API_KEY não configurada')\r\n          return res.status(500).json({ error: 'Configuração do servidor incompleta' })\r\n        }\r\n\r\n        try {\r\n          // 1. Build snapshot\r\n          console.log(`[${new Date().toISOString()}] Construindo snapshot para seção ${sectionCode} do dossiê ${dossierId}...`)\r\n          let snapshot: any\r\n          try {\r\n            snapshot = await buildSectionSnapshot(dossierId, sectionCode)\r\n            console.log(`[${new Date().toISOString()}] Snapshot construído com sucesso. Respostas: ${snapshot.answers?.length || 0}, Entidades: ${Object.keys(snapshot.entities || {}).length}`)\r\n          } catch (snapshotError: any) {\r\n            console.error(`[${new Date().toISOString()}] Erro ao construir snapshot:`, snapshotError)\r\n            throw new Error(`Erro ao construir snapshot: ${snapshotError.message}`)\r\n          }\r\n\r\n          // 2. Registrar evento\r\n          let reportId: string | null = null\r\n          try {\r\n            const eventResult = await pool.query(\r\n              `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n               VALUES (NULL, 'snapshot_built', $1)\r\n               RETURNING id`,\r\n              [JSON.stringify({ section_code: sectionCode, dossier_id: dossierId })],\r\n            )\r\n          } catch (error) {\r\n            // Ignorar erro de eventos (opcional)\r\n          }\r\n\r\n          // 3. Call LLM\r\n          console.log(`[${new Date().toISOString()}] Chamando IA para gerar relatório...`)\r\n          // Ajustar temperatura baseado na seção (IDENTITY usa 0.4-0.6)\r\n          const temperature = sectionCode === 'IDENTITY' ? 0.5 : 0.7\r\n          \r\n          let aiResult: any\r\n          try {\r\n            aiResult = await generateSectionReportWithRetry(sectionCode, snapshot, {\r\n              apiKey,\r\n              model: 'gpt-4o',\r\n              temperature,\r\n              promptVersion: '1.0.0',\r\n              tone: 'intermediario',\r\n            })\r\n            console.log(`[${new Date().toISOString()}] Relatório gerado pela IA com sucesso. Tamanho do markdown: ${aiResult.report_markdown?.length || 0} caracteres`)\r\n          } catch (aiError: any) {\r\n            console.error(`[${new Date().toISOString()}] Erro ao gerar relatório com IA:`, aiError)\r\n            throw new Error(`Erro na geração pela IA: ${aiError.message}`)\r\n          }\r\n\r\n          // 4. Persistir relatório\r\n          const insertResult = await pool.query(\r\n            `INSERT INTO ai_reports (\r\n              clinic_id, dossier_id, section_id, section_code, status,\r\n              input_snapshot_json, report_markdown, insights_json,\r\n              prompt_key, prompt_version, model, temperature, token_usage_json\r\n            ) VALUES ($1, $2, $3, $4, 'generated', $5, $6, $7, $8, $9, $10, $11, $12)\r\n            RETURNING id`,\r\n            [\r\n              clinicId,\r\n              dossierId,\r\n              sectionId,\r\n              sectionCode,\r\n              JSON.stringify(snapshot),\r\n              aiResult.report_markdown,\r\n              JSON.stringify(aiResult.insights),\r\n              'SECTION_REPORT_V1',\r\n              '1.0.0',\r\n              'gpt-4o',\r\n              temperature, // Usar a variável temperature calculada\r\n              aiResult.token_usage ? JSON.stringify(aiResult.token_usage) : null,\r\n            ],\r\n          )\r\n\r\n          reportId = insertResult.rows[0].id\r\n\r\n          // 5. Marcar relatórios anteriores como stale\r\n          await pool.query(\r\n            `UPDATE ai_reports\r\n             SET status = 'stale', updated_at = NOW()\r\n             WHERE dossier_id = $1 AND section_code = $2 AND id != $3 AND status = 'generated'`,\r\n            [dossierId, sectionCode, reportId],\r\n          )\r\n\r\n          // Marcar relatório final como stale quando uma seção é regenerada\r\n          await pool.query(\r\n            `UPDATE ai_reports\r\n             SET status = 'stale', updated_at = NOW()\r\n             WHERE dossier_id = $1 AND section_code = 'FINAL_REPORT' AND status = 'generated'`,\r\n            [dossierId],\r\n          )\r\n\r\n          // 6. Registrar eventos\r\n          try {\r\n            await pool.query(\r\n              `UPDATE ai_report_events SET ai_report_id = $1 WHERE ai_report_id IS NULL`,\r\n              [reportId],\r\n            )\r\n            await pool.query(\r\n              `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n               VALUES ($1, 'llm_called', $2)`,\r\n              [reportId, JSON.stringify({ model: 'gpt-4o', temperature: 0.7 })],\r\n            )\r\n            await pool.query(\r\n              `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n               VALUES ($1, 'persisted', $2)`,\r\n              [reportId, JSON.stringify({ success: true })],\r\n            )\r\n          } catch (error) {\r\n            // Ignorar erros de eventos\r\n          }\r\n\r\n          console.log(`Relatório gerado com sucesso: ${reportId}`)\r\n\r\n          return res.status(200).json({\r\n            id: reportId,\r\n            status: 'generated',\r\n            report_markdown: aiResult.report_markdown,\r\n            insights: aiResult.insights,\r\n            created_at: new Date().toISOString(),\r\n          })\r\n        } catch (error: any) {\r\n          console.error('Erro ao gerar relatório:', error)\r\n          console.error('Stack trace:', error.stack)\r\n\r\n          // Salvar erro no banco\r\n          try {\r\n            const errorReportResult = await pool.query(\r\n              `INSERT INTO ai_reports (\r\n                clinic_id, dossier_id, section_id, section_code, status,\r\n                input_snapshot_json, report_markdown, insights_json,\r\n                error_message, prompt_key, prompt_version, model\r\n              ) VALUES ($1, $2, $3, $4, 'error', $5, '', '{}', $6, $7, $8, $9)\r\n              RETURNING id`,\r\n              [\r\n                clinicId,\r\n                dossierId,\r\n                sectionId,\r\n                sectionCode,\r\n                JSON.stringify({ error: error.message, stack: error.stack }),\r\n                error.message || 'Erro desconhecido',\r\n                'SECTION_REPORT_V1',\r\n                '1.0.0',\r\n                'gpt-4o',\r\n              ],\r\n            )\r\n\r\n            // Registrar evento de erro\r\n            try {\r\n              await pool.query(\r\n                `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n                 VALUES ($1, 'error', $2)`,\r\n                [errorReportResult.rows[0].id, JSON.stringify({ error: error.message, stack: error.stack })],\r\n              )\r\n            } catch {\r\n              // Ignorar\r\n            }\r\n          } catch (dbError) {\r\n            console.error('Erro ao salvar erro no banco:', dbError)\r\n          }\r\n\r\n          // Retornar mensagem de erro mais detalhada\r\n          const errorMessage = error.message || 'Erro desconhecido'\r\n          const errorDetails = process.env.NODE_ENV === 'development' \r\n            ? {\r\n                stack: error.stack,\r\n                name: error.name,\r\n              }\r\n            : undefined\r\n\r\n          console.error('Erro completo:', {\r\n            message: errorMessage,\r\n            stack: error.stack,\r\n            name: error.name,\r\n          })\r\n\r\n          // Tentar buscar o relatório de erro salvo no banco\r\n          try {\r\n            const errorReportResult = await pool.query(\r\n              `SELECT * FROM ai_reports \r\n               WHERE dossier_id = $1 AND section_code = $2 AND status = 'error'\r\n               ORDER BY created_at DESC \r\n               LIMIT 1`,\r\n              [dossierId, sectionCode],\r\n            )\r\n\r\n            if (errorReportResult.rows.length > 0) {\r\n              const errorReport = errorReportResult.rows[0]\r\n              return res.status(500).json({\r\n                id: errorReport.id,\r\n                status: 'error',\r\n                error_message: errorReport.error_message || errorMessage,\r\n                report_markdown: '',\r\n                insights: {},\r\n                created_at: errorReport.created_at,\r\n                message: errorMessage,\r\n                details: errorDetails,\r\n              })\r\n            }\r\n          } catch (dbError) {\r\n            console.error('Erro ao buscar relatório de erro:', dbError)\r\n          }\r\n\r\n          return res.status(500).json({\r\n            error: 'Erro ao gerar relatório',\r\n            message: errorMessage,\r\n            details: errorDetails,\r\n          })\r\n        }\r\n      }\r\n\r\n      return res.status(405).json({ error: 'Método não permitido' })\r\n    } catch (error: any) {\r\n      console.error('Erro na API de relatórios:', error)\r\n      return res.status(500).json({ error: error.message })\r\n    }\r\n  })\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}