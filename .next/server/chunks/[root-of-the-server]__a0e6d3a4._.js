module.exports=[70406,(e,t,s)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},47044,(e,t,s)=>{t.exports=e.x("jsonwebtoken-cc89c121a8bdfb14",()=>require("jsonwebtoken-cc89c121a8bdfb14"))},21503,e=>e.a(async(t,s)=>{try{let t=await e.y("pg-519b72043f8edc04");e.n(t),s()}catch(e){s(e)}},!0),64104,e=>e.a(async(t,s)=>{try{var a=e.i(21503),r=t([a]);if([a]=r.then?(await r)():r,!process.env.DATABASE_URL)throw console.error("❌ DATABASE_URL não está configurada!"),console.error("❌ Configure DATABASE_URL no arquivo .env.local ou nas variáveis de ambiente"),Error("DATABASE_URL não configurada. Configure no .env.local ou variáveis de ambiente.");let i=new a.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});i.on("connect",()=>{console.log("✅ Conectado ao banco de dados Neon")}),i.on("error",e=>{console.error("❌ Erro no pool de conexões:",e)}),e.s(["default",0,i]),s()}catch(e){s(e)}},!1),63963,e=>{"use strict";var t=e.i(47044);let s=process.env.JWT_SECRET||"your-secret-key-change-in-production";function a(e,a,r){let i=e.headers.authorization,o=i&&i.split(" ")[1];if(!o)return a.status(401).json({error:"Token não fornecido"});try{e.user=t.default.verify(o,s),r()}catch(e){return a.status(403).json({error:"Token inválido ou expirado"})}}function r(e,t,s){if(e.user?.role!=="admin")return t.status(403).json({error:"Acesso negado. Admin necessário."});s()}process.env.JWT_SECRET||console.warn("⚠️  JWT_SECRET não configurado! Usando valor padrão inseguro."),e.s(["authenticateToken",()=>a,"requireAdmin",()=>r])},40987,e=>e.a(async(t,s)=>{try{var a=e.i(64104),r=t([a]);async function i(e,t){try{await a.default.query(`UPDATE ai_reports 
       SET status = 'stale', updated_at = NOW()
       WHERE dossier_id = $1 AND section_code = $2 AND status = 'generated'`,[e,t])}catch(e){console.error("Erro ao marcar relatórios como stale:",e)}}function o(e){return({customer_segments:"IDENTITY",value_propositions:"IDENTITY",competitors:"MARKET",service_categories:"OFFER",services:"OFFER",team_members:"OPERATIONS",roles:"OPERATIONS",capacities:"OPERATIONS",strategic_choices:"STRATEGY",initiatives:"PLAN"})[e]||null}async function n(e){try{let t=await a.default.query(`SELECT s.code 
       FROM sections s
       JOIN question_sets qs ON qs.section_id = s.id
       JOIN questions q ON q.question_set_id = qs.id
       WHERE q.id = $1`,[e]);if(t.rows.length>0)return t.rows[0].code}catch(e){console.error("Erro ao buscar seção da pergunta:",e)}return null}async function u(e){try{await a.default.query(`UPDATE ai_reports 
       SET status = 'stale', updated_at = NOW()
       WHERE dossier_id = $1 AND section_code = 'FINAL_REPORT' AND status = 'generated'`,[e])}catch(e){console.error("Erro ao marcar relatório final como stale:",e)}}[a]=r.then?(await r)():r,e.s(["getSectionForEntity",()=>o,"getSectionForQuestion",()=>n,"markFinalReportAsStale",()=>u,"markSectionReportsAsStale",()=>i]),s()}catch(e){s(e)}},!1),23103,e=>e.a(async(t,s)=>{try{var a=e.i(64104),r=t([a]);async function i(e,t){let s,r=await a.default.query("SELECT id FROM sections WHERE code = $1",[t]);if(0===r.rows.length)return void console.warn(`Se\xe7\xe3o ${t} n\xe3o encontrada`);let i=r.rows[0].id,o=await a.default.query(`SELECT COUNT(*) as total FROM questions q
     JOIN question_sets qs ON qs.id = q.question_set_id
     WHERE qs.section_id = $1 AND q.required = true`,[i]),n=await a.default.query(`SELECT COUNT(*) as total FROM answers a
     JOIN questions q ON q.id = a.question_id
     JOIN question_sets qs ON qs.id = q.question_set_id
     WHERE qs.section_id = $1 AND a.dossier_id = $2 
     AND (a.value_text IS NOT NULL AND a.value_text != '' 
          OR a.value_number IS NOT NULL 
          OR a.value_json IS NOT NULL)`,[i,e]),u=parseInt(o.rows[0].total),d=parseInt(n.rows[0].total),c=0;if(0===u){let e=await a.default.query(`SELECT COUNT(*) as total FROM questions q
       JOIN question_sets qs ON qs.id = q.question_set_id
       WHERE qs.section_id = $1`,[i]),t=parseInt(e.rows[0].total);c=100*(0===t)}else c=Math.round(d/u*100);if("IDENTITY"===t){let t=await a.default.query("SELECT COUNT(*) as count FROM customer_segments WHERE dossier_id = $1 AND status = $2",[e,"active"]),s=await a.default.query("SELECT COUNT(*) as count FROM value_propositions WHERE dossier_id = $1 AND status = $2",[e,"active"]),r=parseInt(t.rows[0].count)>=1,i=parseInt(s.rows[0].count)>=1;r&&i?c=Math.min(100,c+10):(r||i)&&(c=Math.min(100,c+5))}else if("MARKET"===t){let t=await a.default.query("SELECT COUNT(*) as count FROM competitors WHERE dossier_id = $1 AND status = $2",[e,"active"]);parseInt(t.rows[0].count)>=1&&(c=Math.min(100,c+10))}else if("OFFER"===t){let t=await a.default.query("SELECT COUNT(*) as count FROM services WHERE dossier_id = $1 AND status = $2",[e,"active"]);parseInt(t.rows[0].count)>=1&&(c=Math.min(100,c+10))}else if("OPERATIONS"===t){let t=await a.default.query("SELECT COUNT(*) as count FROM team_members WHERE dossier_id = $1 AND status = $2",[e,"active"]),s=await a.default.query("SELECT COUNT(*) as count FROM capacities WHERE dossier_id = $1 AND status = $2",[e,"active"]),r=parseInt(t.rows[0].count)>=1,i=parseInt(s.rows[0].count)>=1;(r||i)&&(c=Math.min(100,c+10))}else if("STRATEGY"===t){let t=await a.default.query("SELECT COUNT(*) as count FROM strategic_choices WHERE dossier_id = $1 AND status = $2",[e,"active"]);parseInt(t.rows[0].count)>=1&&(c=Math.min(100,c+10))}else if("PLAN"===t){let t=await a.default.query("SELECT COUNT(*) as count FROM initiatives WHERE dossier_id = $1 AND status = $2",[e,"active"]);parseInt(t.rows[0].count)>=1&&(c=Math.min(100,c+10))}s=0===c?"not_started":100===c?"complete":"in_progress",await a.default.query(`INSERT INTO dossier_sections_status (dossier_id, section_id, completion_percent, status, last_updated_at)
     VALUES ($1, $2, $3, $4, NOW())
     ON CONFLICT (dossier_id, section_id)
     DO UPDATE SET 
       completion_percent = EXCLUDED.completion_percent,
       status = EXCLUDED.status,
       last_updated_at = NOW()`,[e,i,c,s])}[a]=r.then?(await r)():r,e.s(["updateSectionCompletion",()=>i]),s()}catch(e){s(e)}},!1),62028,e=>e.a(async(t,s)=>{try{var a=e.i(63963),r=e.i(64104),i=e.i(40987),o=e.i(23103),n=t([r,i,o]);[r,i,o]=n.then?(await n)():n;let d="value_propositions";async function u(e,t){return(t.setHeader("Access-Control-Allow-Credentials","true"),t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET,OPTIONS,PATCH,DELETE,POST,PUT"),t.setHeader("Access-Control-Allow-Headers","X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization"),"OPTIONS"===e.method)?void t.status(200).end():(0,a.authenticateToken)(e,t,async()=>{try{let{method:s}=e,a=e.user,n=e.query.id,u=e.query.entityId;if(!n)return t.status(400).json({error:"ID do dossiê é obrigatório"});let c=await r.default.query("SELECT clinic_id FROM dossiers WHERE id = $1",[n]);if(0===c.rows.length)return t.status(404).json({error:"Dossiê não encontrado"});let l=c.rows[0].clinic_id;if("admin"!==a.role&&a.clinicId!==l)return t.status(403).json({error:"Acesso negado"});if("GET"===s)if(u){let e=await r.default.query(`SELECT vp.*, cs.name as target_segment_name
             FROM ${d} vp
             LEFT JOIN customer_segments cs ON cs.id = vp.target_segment_id
             WHERE vp.id = $1 AND vp.clinic_id = $2 AND vp.dossier_id = $3`,[u,l,n]);if(0===e.rows.length)return t.status(404).json({error:"Entidade não encontrada"});return t.status(200).json(e.rows[0])}else{let e=await r.default.query(`SELECT vp.*, cs.name as target_segment_name
             FROM ${d} vp
             LEFT JOIN customer_segments cs ON cs.id = vp.target_segment_id
             WHERE vp.clinic_id = $1 AND vp.dossier_id = $2
             ORDER BY vp.created_at`,[l,n]);return t.status(200).json(e.rows)}if("POST"===s){let{title:s,description:a,targetSegmentId:u,notes:c}=e.body;if(!s)return t.status(400).json({error:"title é obrigatório"});let p=await r.default.query(`INSERT INTO ${d} (clinic_id, dossier_id, title, description, target_segment_id, notes, status)
           VALUES ($1, $2, $3, $4, $5, $6, 'active')
           RETURNING *`,[l,n,s,a||null,u||null,c||null]),E=(0,i.getSectionForEntity)("value_propositions");return E&&(await (0,i.markSectionReportsAsStale)(n,E),await (0,o.updateSectionCompletion)(n,E)),t.status(201).json(p.rows[0])}if("PUT"===s&&u){let{title:s,description:a,targetSegmentId:c,notes:p,status:E}=e.body,_=[],T=[],R=1;if(void 0!==s&&(_.push(`title = $${R++}`),T.push(s)),void 0!==a&&(_.push(`description = $${R++}`),T.push(a)),void 0!==c&&(_.push(`target_segment_id = $${R++}`),T.push(c)),void 0!==p&&(_.push(`notes = $${R++}`),T.push(p)),void 0!==E&&(_.push(`status = $${R++}`),T.push(E)),0===_.length)return t.status(400).json({error:"Nenhum campo para atualizar"});_.push("updated_at = NOW()"),T.push(u,l,n);let N=await r.default.query(`UPDATE ${d} SET ${_.join(", ")} 
           WHERE id = $${R} AND clinic_id = $${R+1} AND dossier_id = $${R+2}
           RETURNING *`,T);if(0===N.rows.length)return t.status(404).json({error:"Entidade não encontrada"});let m=(0,i.getSectionForEntity)("value_propositions");return m&&(await (0,i.markSectionReportsAsStale)(n,m),await (0,i.markFinalReportAsStale)(n),await (0,o.updateSectionCompletion)(n,m)),t.status(200).json(N.rows[0])}if("DELETE"===s&&u){let e=await r.default.query(`DELETE FROM ${d} 
           WHERE id = $1 AND clinic_id = $2 AND dossier_id = $3
           RETURNING *`,[u,l,n]);if(0===e.rows.length)return t.status(404).json({error:"Entidade não encontrada"});let s=(0,i.getSectionForEntity)("value_propositions");return s&&(await (0,i.markSectionReportsAsStale)(n,s),await (0,i.markFinalReportAsStale)(n),await (0,o.updateSectionCompletion)(n,s)),t.status(200).json({message:"Entidade deletada",id:u})}return t.status(405).json({error:"Método não permitido"})}catch(e){return console.error(`Erro na API de ${d}:`,e),t.status(500).json({error:e.message})}})}e.s(["default",()=>u]),s()}catch(e){s(e)}},!1),38522,e=>e.a(async(t,s)=>{try{var a=e.i(93957),r=e.i(72664),i=e.i(61471),o=e.i(65751),n=e.i(62028),u=e.i(90078),d=e.i(57218),c=e.i(2576),l=t([n]);[n]=l.then?(await l)():l;let E=(0,o.hoist)(n,"default"),_=(0,o.hoist)(n,"config"),T=new i.PagesAPIRouteModule({definition:{kind:r.RouteKind.PAGES_API,page:"/api/dossiers/[id]/entities/value-propositions",pathname:"/api/dossiers/[id]/entities/value-propositions",bundlePath:"",filename:""},userland:n,distDir:".next",relativeProjectDir:""});async function p(e,t,s){T.isDev&&(0,c.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/dossiers/[id]/entities/value-propositions";r=r.replace(/\/index$/,"")||"/";let i=await T.prepare(e,t,{srcPage:r});if(!i){t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve());return}let{query:o,params:n,prerenderManifest:l,routerServerContext:p}=i;try{let s=e.method||"GET",a=(0,u.getTracer)(),i=a.getActiveScopeSpan(),c=T.instrumentationOnRequestError.bind(T),E=async i=>T.render(e,t,{query:{...o,...n},params:n,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:l.preview,propagateError:!1,dev:T.isDev,page:"/api/dossiers/[id]/entities/value-propositions",internalRevalidate:null==p?void 0:p.revalidate,onError:(...t)=>c(e,...t)}).finally(()=>{if(!i)return;i.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=a.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=e.get("next.route");if(o){let e=`${s} ${o}`;i.setAttributes({"next.route":o,"http.route":o,"next.span_name":e}),i.updateName(e)}else i.updateName(`${s} ${r}`)});i?await E(i):await a.withPropagatedContext(e.headers,()=>a.trace(d.BaseServerSpan.handleRequest,{spanName:`${s} ${r}`,kind:u.SpanKind.SERVER,attributes:{"http.method":s,"http.target":e.url}},E))}catch(e){if(T.isDev)throw e;(0,a.sendError)(t,500,"Internal Server Error")}finally{null==s.waitUntil||s.waitUntil.call(s,Promise.resolve())}}e.s(["config",0,_,"default",0,E,"handler",()=>p]),s()}catch(e){s(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__a0e6d3a4._.js.map