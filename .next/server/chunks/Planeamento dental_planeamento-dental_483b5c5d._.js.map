{"version":3,"sources":["../../../../../Planeamento%20dental/planeamento-dental/src/lib/api-shared/snapshotBuilder.ts","../../../../../Planeamento%20dental/planeamento-dental/src/lib/section-prompts.ts","../../../../../Planeamento%20dental/planeamento-dental/src/lib/api-shared/section-ai-client.ts","../../../../../Planeamento%20dental/planeamento-dental/pages/api/dossiers/%5Bid%5D/sections/%5BsectionCode%5D/report.ts","../../../../../Planeamento%20dental/planeamento-dental/node_modules/next/src/build/templates/pages-api.ts"],"sourcesContent":["// Versão server-side do snapshot builder\r\nimport pool from './db'\r\n\r\nexport interface SectionSnapshot {\r\n  clinic: {\r\n    id: string\r\n    name: string\r\n    location?: string\r\n    type?: string\r\n  }\r\n  dossier: {\r\n    id: string\r\n    title: string\r\n    baseline_date?: string\r\n  }\r\n  section: {\r\n    code: string\r\n    name: string\r\n    description?: string\r\n  }\r\n  answers: Array<{\r\n    question_code: string\r\n    question_text: string\r\n    value_normalized: any\r\n    required: boolean\r\n    raw_value?: any\r\n  }>\r\n  entities: Record<string, any[]>\r\n  completeness: {\r\n    percent: number\r\n    missing_items: string[]\r\n  }\r\n  data_quality_flags: string[]\r\n  generated_at: string\r\n}\r\n\r\nconst SECTION_ENTITIES_MAP: Record<string, string[]> = {\r\n  IDENTITY: ['customer_segments', 'value_propositions'],\r\n  MARKET: ['competitors'],\r\n  OFFER: ['service_categories', 'services'],\r\n  OPERATIONS: ['team_members', 'roles', 'capacities'],\r\n  STRATEGY: ['strategic_choices'],\r\n  PLAN: ['initiatives'],\r\n  BUSINESS_MODEL: [],\r\n  FINAL_REPORT: [],\r\n}\r\n\r\nfunction normalizeAnswer(question: any, answer: any): any {\r\n  if (!answer) return null\r\n\r\n  switch (question.type) {\r\n    case 'multi_select':\r\n    case 'json':\r\n      if (answer.value_json) {\r\n        return Array.isArray(answer.value_json) ? answer.value_json : [answer.value_json]\r\n      }\r\n      if (answer.value_text) {\r\n        try {\r\n          const parsed = JSON.parse(answer.value_text)\r\n          return Array.isArray(parsed) ? parsed : [parsed]\r\n        } catch {\r\n          return answer.value_text.split(',').map((s: string) => s.trim())\r\n        }\r\n      }\r\n      return []\r\n\r\n    case 'currency':\r\n      const currencyValue = answer.value_number || parseFloat(answer.value_text || '0')\r\n      return {\r\n        value: currencyValue,\r\n        currency: 'EUR',\r\n        formatted: new Intl.NumberFormat('pt-PT', {\r\n          style: 'currency',\r\n          currency: 'EUR',\r\n        }).format(currencyValue),\r\n        raw: answer.value_text || answer.value_number,\r\n      }\r\n\r\n    case 'number':\r\n    case 'scale':\r\n      return answer.value_number !== null && answer.value_number !== undefined\r\n        ? answer.value_number\r\n        : parseFloat(answer.value_text || '0')\r\n\r\n    case 'date':\r\n      return answer.value_text || null\r\n\r\n    default:\r\n      return answer.value_text || answer.value_number?.toString() || null\r\n  }\r\n}\r\n\r\nfunction detectDataQualityFlags(\r\n  sectionCode: string,\r\n  snapshot: Partial<SectionSnapshot>,\r\n): string[] {\r\n  const flags: string[] = []\r\n\r\n  if (snapshot.answers) {\r\n    const missingRequired = snapshot.answers.filter(\r\n      (a) => a.required && (!a.value_normalized || a.value_normalized === ''),\r\n    )\r\n    if (missingRequired.length > 0) {\r\n      flags.push(\r\n        `Campos obrigatórios não preenchidos: ${missingRequired.map((a) => a.question_code).join(', ')}`,\r\n      )\r\n    }\r\n  }\r\n\r\n  if (sectionCode === 'IDENTITY') {\r\n    const entities = snapshot.entities || {}\r\n    const segments = entities.customer_segments || []\r\n    const propositions = entities.value_propositions || []\r\n\r\n    if (segments.length === 0) flags.push('Nenhum segmento de cliente cadastrado')\r\n    if (propositions.length === 0) flags.push('Nenhuma proposta de valor cadastrada')\r\n\r\n    const propositionsWithoutSegment = propositions.filter(\r\n      (p: any) => !p.target_segment_id && !p.target_segment_name,\r\n    )\r\n    if (propositionsWithoutSegment.length > 0) {\r\n      flags.push(\r\n        `${propositionsWithoutSegment.length} proposta(s) de valor sem segmento alvo definido`,\r\n      )\r\n    }\r\n  }\r\n\r\n  if (sectionCode === 'OFFER') {\r\n    const entities = snapshot.entities || {}\r\n    const services = entities.services || []\r\n    const invalidPrices = services.filter(\r\n      (s: any) => s.price !== null && s.price !== undefined && (s.price < 0 || s.price === 0),\r\n    )\r\n    if (invalidPrices.length > 0) {\r\n      flags.push(`${invalidPrices.length} serviço(s) com preço inválido (zero ou negativo)`)\r\n    }\r\n  }\r\n\r\n  if (sectionCode === 'OPERATIONS') {\r\n    const entities = snapshot.entities || {}\r\n    const teamMembers = entities.team_members || []\r\n    const capacities = entities.capacities || []\r\n\r\n    if (teamMembers.length === 0) flags.push('Nenhum membro da equipe cadastrado')\r\n    if (capacities.length === 0) flags.push('Nenhuma capacidade operacional cadastrada')\r\n  }\r\n\r\n  return flags\r\n}\r\n\r\nasync function fetchSectionEntities(\r\n  dossierId: string,\r\n  sectionCode: string,\r\n): Promise<Record<string, any[]>> {\r\n  const entityTypes = SECTION_ENTITIES_MAP[sectionCode] || []\r\n  const entities: Record<string, any[]> = {}\r\n\r\n  for (const entityType of entityTypes) {\r\n    try {\r\n      switch (entityType) {\r\n        case 'customer_segments':\r\n          const segResult = await pool.query(\r\n            'SELECT * FROM customer_segments WHERE dossier_id = $1 ORDER BY priority, created_at',\r\n            [dossierId],\r\n          )\r\n          entities.customer_segments = segResult.rows\r\n          break\r\n        case 'value_propositions':\r\n          const propResult = await pool.query(\r\n            `SELECT vp.*, cs.name as target_segment_name\r\n             FROM value_propositions vp\r\n             LEFT JOIN customer_segments cs ON cs.id = vp.target_segment_id\r\n             WHERE vp.dossier_id = $1 ORDER BY vp.created_at`,\r\n            [dossierId],\r\n          )\r\n          entities.value_propositions = propResult.rows\r\n          break\r\n        case 'services':\r\n          const servResult = await pool.query(\r\n            `SELECT s.*, sc.name as category_name\r\n             FROM services s\r\n             LEFT JOIN service_categories sc ON sc.id = s.service_category_id\r\n             WHERE s.dossier_id = $1 ORDER BY s.is_flagship DESC, s.created_at`,\r\n            [dossierId],\r\n          )\r\n          entities.services = servResult.rows\r\n          break\r\n        case 'competitors':\r\n          const compResult = await pool.query(\r\n            'SELECT * FROM competitors WHERE dossier_id = $1 ORDER BY type, created_at',\r\n            [dossierId],\r\n          )\r\n          entities.competitors = compResult.rows\r\n          break\r\n        case 'team_members':\r\n          const teamResult = await pool.query(\r\n            `SELECT tm.*, r.name as role_name\r\n             FROM team_members tm\r\n             LEFT JOIN roles r ON r.id = tm.role_id\r\n             WHERE tm.dossier_id = $1 ORDER BY tm.created_at`,\r\n            [dossierId],\r\n          )\r\n          entities.team_members = teamResult.rows\r\n          break\r\n        case 'capacities':\r\n          const capResult = await pool.query(\r\n            'SELECT * FROM capacities WHERE dossier_id = $1 ORDER BY resource_type, created_at',\r\n            [dossierId],\r\n          )\r\n          entities.capacities = capResult.rows\r\n          break\r\n        case 'strategic_choices':\r\n          const stratResult = await pool.query(\r\n            'SELECT * FROM strategic_choices WHERE dossier_id = $1 ORDER BY priority, created_at',\r\n            [dossierId],\r\n          )\r\n          entities.strategic_choices = stratResult.rows\r\n          break\r\n        case 'initiatives':\r\n          const initResult = await pool.query(\r\n            'SELECT * FROM initiatives WHERE dossier_id = $1 ORDER BY created_at',\r\n            [dossierId],\r\n          )\r\n          entities.initiatives = initResult.rows\r\n          break\r\n      }\r\n    } catch (error) {\r\n      console.warn(`Erro ao buscar entidade ${entityType}:`, error)\r\n      entities[entityType] = []\r\n    }\r\n  }\r\n\r\n  return entities\r\n}\r\n\r\nasync function calculateSectionCompletion(\r\n  dossierId: string,\r\n  sectionId: string,\r\n): Promise<number> {\r\n  const requiredQuestionsResult = await pool.query(\r\n    `SELECT COUNT(*) as total FROM questions q\r\n     JOIN question_sets qs ON qs.id = q.question_set_id\r\n     WHERE qs.section_id = $1 AND q.required = true`,\r\n    [sectionId],\r\n  )\r\n\r\n  const answeredResult = await pool.query(\r\n    `SELECT COUNT(*) as total FROM answers a\r\n     JOIN questions q ON q.id = a.question_id\r\n     JOIN question_sets qs ON qs.id = q.question_set_id\r\n     WHERE qs.section_id = $1 AND a.dossier_id = $2 \r\n     AND (a.value_text IS NOT NULL AND a.value_text != '' \r\n          OR a.value_number IS NOT NULL \r\n          OR a.value_json IS NOT NULL)`,\r\n    [sectionId, dossierId],\r\n  )\r\n\r\n  const totalRequired = parseInt(requiredQuestionsResult.rows[0].total)\r\n  const totalAnswered = parseInt(answeredResult.rows[0].total)\r\n\r\n  if (totalRequired === 0) return 100\r\n\r\n  let completionPercent = Math.round((totalAnswered / totalRequired) * 100)\r\n\r\n  // Bônus para IDENTITY se tiver entidades\r\n  const sectionResult = await pool.query('SELECT code FROM sections WHERE id = $1', [sectionId])\r\n  if (sectionResult.rows[0]?.code === 'IDENTITY') {\r\n    const segmentsResult = await pool.query(\r\n      'SELECT COUNT(*) as count FROM customer_segments WHERE dossier_id = $1',\r\n      [dossierId],\r\n    )\r\n    const propositionsResult = await pool.query(\r\n      'SELECT COUNT(*) as count FROM value_propositions WHERE dossier_id = $1',\r\n      [dossierId],\r\n    )\r\n\r\n    const hasSegments = parseInt(segmentsResult.rows[0].count) > 0\r\n    const hasPropositions = parseInt(propositionsResult.rows[0].count) > 0\r\n\r\n    if (hasSegments && hasPropositions) {\r\n      completionPercent = Math.min(100, completionPercent + 10)\r\n    } else if (hasSegments || hasPropositions) {\r\n      completionPercent = Math.min(100, completionPercent + 5)\r\n    }\r\n  }\r\n\r\n  return completionPercent\r\n}\r\n\r\nexport async function buildSectionSnapshot(\r\n  dossierId: string,\r\n  sectionCode: string,\r\n): Promise<SectionSnapshot> {\r\n  // Buscar dados básicos\r\n  const dossierResult = await pool.query('SELECT * FROM dossiers WHERE id = $1', [dossierId])\r\n  if (dossierResult.rows.length === 0) {\r\n    throw new Error('Dossiê não encontrado')\r\n  }\r\n  const dossier = dossierResult.rows[0]\r\n\r\n  const clinicResult = await pool.query('SELECT * FROM clinics WHERE id = $1', [dossier.clinic_id])\r\n  if (clinicResult.rows.length === 0) {\r\n    throw new Error('Clínica não encontrada')\r\n  }\r\n  const clinic = clinicResult.rows[0]\r\n\r\n  const sectionResult = await pool.query('SELECT * FROM sections WHERE code = $1', [sectionCode])\r\n  if (sectionResult.rows.length === 0) {\r\n    throw new Error('Seção não encontrada')\r\n  }\r\n  const section = sectionResult.rows[0]\r\n\r\n  // Buscar question_sets e perguntas\r\n  const questionSetsResult = await pool.query(\r\n    `SELECT qs.* FROM question_sets qs\r\n     WHERE qs.section_id = $1 AND qs.is_active = true\r\n     ORDER BY qs.version DESC`,\r\n    [section.id],\r\n  )\r\n\r\n  const normalizedAnswers: SectionSnapshot['answers'] = []\r\n  const missingItems: string[] = []\r\n\r\n  for (const qs of questionSetsResult.rows) {\r\n    const questionsResult = await pool.query(\r\n      `SELECT q.*, \r\n       json_agg(\r\n         json_build_object('id', qo.id, 'label', qo.label, 'value', qo.value, 'order_index', qo.order_index)\r\n         ORDER BY qo.order_index\r\n       ) FILTER (WHERE qo.id IS NOT NULL) as options\r\n       FROM questions q\r\n       LEFT JOIN question_options qo ON qo.question_id = q.id\r\n       WHERE q.question_set_id = $1\r\n       GROUP BY q.id\r\n       ORDER BY q.order_index`,\r\n      [qs.id],\r\n    )\r\n\r\n    const questionIds = questionsResult.rows.map((q: any) => q.id)\r\n    let answers: any[] = []\r\n\r\n    if (questionIds.length > 0) {\r\n      const answersResult = await pool.query(\r\n        `SELECT * FROM answers WHERE dossier_id = $1 AND question_id = ANY($2::uuid[])`,\r\n        [dossierId, questionIds],\r\n      )\r\n      answers = answersResult.rows\r\n    }\r\n\r\n    const answersMap = new Map(answers.map((a) => [a.question_id, a]))\r\n\r\n    for (const question of questionsResult.rows) {\r\n      const answer = answersMap.get(question.id)\r\n      const normalized = normalizeAnswer(question, answer || {})\r\n\r\n      normalizedAnswers.push({\r\n        question_code: question.code,\r\n        question_text: question.text,\r\n        value_normalized: normalized,\r\n        required: question.required,\r\n        raw_value: answer\r\n          ? {\r\n              value_text: answer.value_text,\r\n              value_number: answer.value_number,\r\n              value_json: answer.value_json,\r\n            }\r\n          : undefined,\r\n      })\r\n\r\n      if (question.required && (!normalized || normalized === '' || normalized === null)) {\r\n        missingItems.push(question.code)\r\n      }\r\n    }\r\n  }\r\n\r\n  // Buscar entidades\r\n  const entities = await fetchSectionEntities(dossierId, sectionCode)\r\n\r\n  // Calcular completude\r\n  const completionPercent = await calculateSectionCompletion(dossierId, section.id)\r\n\r\n  // Detectar flags\r\n  const snapshot: Partial<SectionSnapshot> = {\r\n    answers: normalizedAnswers,\r\n    entities,\r\n    completeness: {\r\n      percent: completionPercent,\r\n      missing_items: missingItems,\r\n    },\r\n  }\r\n\r\n  const dataQualityFlags = detectDataQualityFlags(sectionCode, snapshot)\r\n\r\n  return {\r\n    clinic: {\r\n      id: clinic.id,\r\n      name: clinic.clinic_name,\r\n    },\r\n    dossier: {\r\n      id: dossier.id,\r\n      title: dossier.title,\r\n      baseline_date: dossier.baseline_date || undefined,\r\n    },\r\n    section: {\r\n      code: section.code,\r\n      name: section.name,\r\n      description: section.description || undefined,\r\n    },\r\n    answers: normalizedAnswers,\r\n    entities,\r\n    completeness: {\r\n      percent: completionPercent,\r\n      missing_items: missingItems,\r\n    },\r\n    data_quality_flags: dataQualityFlags,\r\n    generated_at: new Date().toISOString(),\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n","import type { SectionSnapshot } from '@/services/snapshotBuilder'\r\n\r\n/**\r\n * Sistema de prompts para geração de relatórios por seção via IA\r\n */\r\n\r\nexport function getSystemPrompt(tone: string): string {\r\n  const toneMap = {\r\n    formal: 'Você é um consultor de gestão estratégica especializado em clínicas de saúde. Use linguagem formal, técnica e objetiva. Seja preciso e baseie todas as conclusões nos dados fornecidos. Retorne suas análises em formato json estruturado.',\r\n    informal: 'Você é um mentor de negócios que fala de forma acessível e direta. Use linguagem informal e próxima, evitando jargões excessivos. Seja prático e baseie recomendações nos dados fornecidos. Retorne suas análises em formato json estruturado.',\r\n    intermediario: 'Você é um consultor experiente que equilibra profissionalismo com clareza. Use linguagem clara, mas profissional. Seja objetivo e baseie análises nos dados fornecidos. Retorne suas análises em formato json estruturado.',\r\n  }\r\n\r\n  return toneMap[tone as keyof typeof toneMap] || toneMap.intermediario\r\n}\r\n\r\n// Instruções específicas por seção\r\nconst SECTION_INSTRUCTIONS: Record<string, string> = {\r\n  IDENTITY: `\r\nVocê é um consultor sênior de estratégia para clínicas de saúde. Seu trabalho é transformar as informações fornecidas em um relatório executivo detalhado e acionável sobre a IDENTIDADE do negócio.\r\n\r\nRegras:\r\n- Não cite nem mencione livros, autores, frameworks ou \"metodologias\".\r\n- Use linguagem clara, direta e profissional, evitando jargões.\r\n- Seja específico: use os dados fornecidos (segmentos, propostas, escolhas, valores, ações críticas, características-chave).\r\n- Identifique inconsistências, lacunas e ambiguidades sem agressividade, com sugestões práticas para corrigir.\r\n- Não invente fatos: se algo não estiver no snapshot, marque como \"não informado\" e diga por que isso importa.\r\n- Trate \"Identidade\" como base de decisões: foco, posicionamento, escolhas e renúncias.\r\n- Produza um relatório bem detalhado, com seções e subtítulos, e exemplos aplicáveis ao contexto.\r\n- Ao final, gere recomendações prioritárias e um checklist de melhoria.\r\n\r\nObjetivo do relatório:\r\n- Explicar, de forma detalhada e bem descritiva, qual é a identidade estratégica da clínica (propósito, visão, valores, foco, posicionamento e escolhas).\r\n- Transformar as respostas em um \"norte\" prático: como essa identidade deve orientar decisões de público, oferta, experiência e crescimento.\r\n- Destacar contradições e lacunas e como resolvê-las.\r\n- Propor ações críticas e características-chave (se já existirem, avaliar; se não existirem, sugerir rascunhos com base no que foi fornecido, deixando claro que são sugestões).\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 900 a 1400 palavras (aprox.), com seções completas, exemplos e justificativas.\r\n- Use os dados do snapshot de forma explícita (referencie termos e decisões declaradas, sem citar o snapshot literalmente).\r\n\r\nTOM e estilo:\r\n- Profissional, claro e humano, como um consultor falando com o dono.\r\n- Não use linguagem motivacional vaga. Seja prático.\r\n- Não mencione nenhum livro, autor ou framework.\r\n\r\nAtenção ao rigor:\r\n- Não invente segmentos, serviços, preços, ou estratégias não fornecidas.\r\n- Se houver contradições, descreva a contradição e o impacto provável.\r\n- Se faltarem dados, liste perguntas de follow-up.\r\n\r\nEstrutura recomendada dentro do report_markdown:\r\n1. Resumo executivo da identidade\r\n2. Propósito e impacto\r\n3. Visão e ambição (3 anos)\r\n4. Valores inegociáveis e implicações práticas\r\n5. Escolhas de foco: público prioritário e renúncias\r\n6. Posicionamento: preço, proposta de valor e diferenciação\r\n7. Estratégia de crescimento e suas exigências\r\n8. Ações críticas (o que precisa acontecer sempre)\r\n9. Características-chave (como a clínica deve \"ser\")\r\n10. Riscos de incoerência e pontos de atenção\r\n11. Recomendações priorizadas\r\n12. Checklist de melhoria da Identidade\r\n  `,\r\n\r\n  MARKET: `\r\nAnalise o MERCADO e CONCORRÊNCIA com foco em:\r\n\r\n1. **Intensidade Competitiva**: Avalie o nível de competição no mercado local e os fatores que a determinam.\r\n\r\n2. **Diferenciais Defensáveis**: Identifique quais diferenciais da clínica são realmente defensáveis e difíceis de copiar.\r\n\r\n3. **Riscos de Guerra de Preços**: Avalie a vulnerabilidade da clínica a pressões de preço dos concorrentes.\r\n\r\n4. **Oportunidades de Posicionamento**: Identifique gaps no mercado onde a clínica pode se posicionar de forma única.\r\n\r\n5. **Análise de Concorrentes**: Compare a clínica com concorrentes diretos e indiretos, identificando pontos fortes e fracos relativos.\r\n  `,\r\n\r\n  OFFER: `\r\nAnalise a OFERTA DE SERVIÇOS com foco em:\r\n\r\n1. **Portfólio de Serviços**: Avalie se o portfólio está alinhado com a identidade estratégica e os segmentos de cliente.\r\n\r\n2. **Precificação**: Verifique se os preços estão coerentes com o posicionamento e se há serviços flagship bem definidos.\r\n\r\n3. **Estrutura de Custos**: Analise a viabilidade econômica dos serviços oferecidos.\r\n\r\n4. **Diferenciação**: Identifique quais serviços realmente diferenciam a clínica no mercado.\r\n  `,\r\n\r\n  OPERATIONS: `\r\nAnalise as OPERAÇÕES com foco em:\r\n\r\n1. **Capacidade Operacional**: Avalie se a capacidade (equipe, equipamentos, salas) está alinhada com a demanda e objetivos estratégicos.\r\n\r\n2. **Estrutura de Equipe**: Verifique se a composição da equipe suporta a proposta de valor e os serviços oferecidos.\r\n\r\n3. **Gargalos Operacionais**: Identifique limitações que podem impedir o crescimento ou a entrega da proposta de valor.\r\n\r\n4. **Eficiência**: Avalie oportunidades de melhoria operacional.\r\n  `,\r\n\r\n  PEOPLE: `\r\nVocê é um consultor especializado em gestão de pessoas e cultura organizacional para clínicas de saúde. Seu trabalho é transformar as informações fornecidas em um relatório executivo detalhado e acionável sobre PESSOAS, CULTURA & GESTÃO.\r\n\r\nRegras:\r\n- Não cite nem mencione livros, autores, frameworks ou \"metodologias\".\r\n- Use linguagem clara, direta e profissional, evitando jargões.\r\n- Seja específico: use os dados fornecidos (estrutura de equipe, dependências, cultura, liderança, accountability).\r\n- Identifique riscos humanos, gargalos de pessoas, desalinhamentos cultura-estratégia sem agressividade, com sugestões práticas.\r\n- Não invente fatos: se algo não estiver no snapshot, marque como \"não informado\" e diga por que isso importa.\r\n- Trate \"Pessoas\" como base da execução: quem faz o quê, como decidem, como são desenvolvidos e cobrados.\r\n- Produza um relatório bem detalhado, com seções e subtítulos, e exemplos aplicáveis ao contexto.\r\n- Ao final, gere recomendações prioritárias e um checklist de melhoria.\r\n\r\nObjetivo do relatório:\r\n- Avaliar se a clínica tem as pessoas certas nos lugares certos.\r\n- Identificar riscos de dependência excessiva de pessoas-chave.\r\n- Analisar se a cultura praticada apoia ou sabota a estratégia.\r\n- Avaliar modelo de liderança, tomada de decisão e accountability.\r\n- Identificar falhas em contratação, desligamento e desenvolvimento de pessoas.\r\n- Analisar o papel dos donos: operacional vs estratégico.\r\n- Mapear incentivos reais (o que é realmente recompensado e punido).\r\n\r\nEstrutura recomendada dentro do report_markdown:\r\n1. Resumo executivo da estrutura humana e cultural\r\n2. Mapa de pessoas-chave e dependências críticas\r\n3. Análise: pessoas certas nos lugares certos?\r\n4. Cultura real vs cultura declarada\r\n5. Alinhamento cultura-estratégia\r\n6. Modelo de liderança e tomada de decisão\r\n7. Sistema de accountability (metas, cobrança, consequências)\r\n8. Processos de contratação e desligamento\r\n9. Desenvolvimento de pessoas e líderes\r\n10. Papel dos donos: onde está o gargalo?\r\n11. Incentivos reais e comportamentos reforçados\r\n12. Riscos humanos e pontos de atenção\r\n13. Recomendações priorizadas\r\n14. Checklist de melhoria de Pessoas & Cultura\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 900 a 1400 palavras, com seções completas, exemplos e justificativas.\r\n- Use os dados do snapshot de forma explícita.\r\n\r\nTOM e estilo:\r\n- Profissional, claro e humano, como um consultor falando com o dono.\r\n- Não use linguagem motivacional vaga. Seja prático e honesto.\r\n- Não mencione nenhum livro, autor ou framework.\r\n\r\nAtenção ao rigor:\r\n- Não invente perfis, cargos ou estruturas não fornecidas.\r\n- Se houver contradições, descreva a contradição e o impacto provável.\r\n- Se faltarem dados, liste perguntas de follow-up.\r\n  `,\r\n\r\n  STRATEGY: `\r\nVocê é um consultor estratégico sênior especializado em clínicas de saúde. Seu trabalho é consolidar os dados dos blocos diagnósticos em uma SÍNTESE ESTRATÉGICA clara, coerente e executável.\r\n\r\nRegras:\r\n- Não cite nem mencione livros, autores, frameworks ou \"metodologias\".\r\n- Use linguagem clara, direta e profissional, evitando jargões.\r\n- Seja específico: baseie todas as conclusões nos dados fornecidos dos blocos anteriores (Identity, Market, Offer, Operations, People).\r\n- Identifique contradições entre blocos e explique as tensões de coerência.\r\n- Não invente fatos: se algo crítico não estiver nos dados, marque como \"lacuna\" e explique por que importa.\r\n- Trate \"Estratégia\" como escolhas conscientes e renúncias: o que fazer, o que NÃO fazer, e porquê.\r\n- Produza um relatório bem detalhado, com seções e subtítulos claros.\r\n- Ao final, gere 3-7 prioridades estratégicas e um checklist de melhoria.\r\n\r\nObjetivo do relatório:\r\n- Identificar o DESAFIO ESTRATÉGICO CENTRAL da clínica (o problema-guia que orienta as escolhas).\r\n- Propor 3-5 ESCOLHAS ESTRATÉGICAS claras, com trade-offs explícitos para cada uma.\r\n- Listar RENÚNCIAS CONSCIENTES (o que a clínica deve parar de fazer ou evitar).\r\n- Definir DIRETRIZES DE FOCO: segmento prioritário, proposta de valor dominante, posicionamento.\r\n- Mapear RISCOS E TENSÕES DE COERÊNCIA entre Identity, Market, Offer, Operations, People.\r\n- Propor RECOMENDAÇÕES PRIORIZADAS para resolver contradições e lacunas.\r\n\r\nEstrutura recomendada dentro do report_markdown:\r\n1. Resumo executivo da síntese estratégica\r\n2. Desafio estratégico central (problema-guia)\r\n3. Contexto consolidado (o que sabemos dos blocos diagnósticos)\r\n4. Escolhas estratégicas (3-5 escolhas com trade-offs explícitos)\r\n5. Renúncias estratégicas (o que NÃO fazer)\r\n6. Diretrizes de foco (segmento, proposta, posicionamento)\r\n7. Riscos de coerência e tensões entre blocos\r\n8. Lacunas críticas (dados faltantes que impedem clareza estratégica)\r\n9. Recomendações priorizadas (top 3-7)\r\n10. Checklist de melhoria da síntese estratégica\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 900 a 1400 palavras, com seções completas, exemplos concretos e justificativas baseadas nos dados.\r\n- Cite explicitamente dados dos blocos (ex: \"Conforme Identity, o segmento prioritário é X, mas Market mostra concorrência forte em Y\").\r\n\r\nTOM e estilo:\r\n- Profissional, claro e direto, como um consultor experiente falando com o dono.\r\n- Não use linguagem motivacional vaga. Seja prático e honesto.\r\n- Não mencione nenhum livro, autor ou framework.\r\n\r\nAtenção ao rigor:\r\n- Não invente escolhas estratégicas, segmentos ou prioridades não inferíveis dos dados.\r\n- Se houver contradições entre blocos, descreva a contradição e sugira como resolver.\r\n- Se faltarem dados críticos, liste o que falta e por que isso impede uma síntese de qualidade.\r\n  `,\r\n\r\n  PLAN: `\r\nVocê é um consultor de execução estratégica especializado em traduzir estratégia em planos executáveis. Seu trabalho é transformar a síntese estratégica em um PLANO DE EXECUÇÃO concreto com OKRs, iniciativas e sequenciamento para os próximos 12 meses.\r\n\r\nRegras:\r\n- Não cite nem mencione livros, autores, frameworks ou \"metodologias\".\r\n- Use linguagem clara, direta e profissional, evitando jargões.\r\n- Seja específico: baseie o plano na síntese estratégica (se disponível) e nos dados dos blocos diagnósticos.\r\n- Crie OKRs mensuráveis: Objectives ambiciosos + Key Results quantificáveis.\r\n- Priorize iniciativas por impacto vs esforço, e identifique dependências.\r\n- Defina responsáveis (mesmo que sejam papéis/funções, não nomes) e prazos realistas.\r\n- Não invente fatos: se dados críticos faltam, marque como \"a definir\" e explique o que precisa ser esclarecido.\r\n- Produza um relatório bem detalhado, com seções e subtítulos claros.\r\n\r\nObjetivo do relatório:\r\n- Criar 3-5 OKRs (Objectives & Key Results) alinhados às prioridades estratégicas.\r\n- Propor 7-15 INICIATIVAS priorizadas, com impacto, esforço, responsável e prazo.\r\n- Definir SEQUENCIAMENTO: o que vem antes do quê (ondas ou fases).\r\n- Mapear DEPENDÊNCIAS CRÍTICAS entre iniciativas.\r\n- Identificar RECURSOS NECESSÁRIOS e RISCOS DE EXECUÇÃO.\r\n- Propor um ROADMAP DE 12 MESES com marcos principais.\r\n\r\nEstrutura recomendada dentro do report_markdown:\r\n1. Resumo executivo do plano de execução\r\n2. Objetivos estratégicos (OKRs)\r\n   - Para cada OKR: Objective + 2-4 Key Results mensuráveis\r\n3. Iniciativas priorizadas\r\n   - Top 7-15 iniciativas com: título, descrição, impacto (alto/médio/baixo), esforço (alto/médio/baixo), responsável (papel), prazo\r\n4. Sequenciamento e dependências\r\n   - Ondas ou fases (ex: Onda 1: Jan-Abr, Onda 2: Mai-Ago, Onda 3: Set-Dez)\r\n   - Mapa de dependências (iniciativa X depende de Y estar completa)\r\n5. Roadmap de 12 meses\r\n   - Linha do tempo visual (markdown) com marcos principais\r\n6. Recursos necessários\r\n   - Pessoas, orçamento, ferramentas/sistemas, treinamento\r\n7. Riscos de execução\r\n   - Top 3-5 riscos que podem impedir execução do plano\r\n8. Checklist de preparação para execução\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 900 a 1400 palavras, com seções completas e exemplos concretos.\r\n- OKRs devem ser mensuráveis e ambiciosos (não apenas \"manter\" ou \"continuar\").\r\n- Iniciativas devem ser específicas e acionáveis (não \"melhorar atendimento\", mas \"implementar sistema de NPS pós-consulta\").\r\n\r\nTOM e estilo:\r\n- Profissional, claro e orientado à execução.\r\n- Não use linguagem motivacional vaga. Seja prático e realista.\r\n- Não mencione nenhum livro, autor ou framework.\r\n\r\nAtenção ao rigor:\r\n- Não invente iniciativas ou objetivos que não sejam inferíveis dos dados.\r\n- Se a síntese estratégica não estiver disponível, baseie-se nos blocos diagnósticos e marque \"aguardando síntese estratégica\".\r\n- Priorize qualidade sobre quantidade: melhor 7 iniciativas bem definidas do que 20 vagas.\r\n  `,\r\n\r\n  BUSINESS_MODEL: `\r\nAnalise o MODELO DE NEGÓCIO com foco em:\r\n\r\n1. **Criação de Valor**: Como a clínica cria valor para os pacientes.\r\n\r\n2. **Entrega de Valor**: Como o valor é entregue aos pacientes.\r\n\r\n3. **Captura de Valor**: Como a clínica captura valor (receita, margem).\r\n\r\n4. **Sustentabilidade**: Se o modelo é sustentável e escalável.\r\n  `,\r\n\r\n  FINAL_REPORT: `\r\nVocê é um consultor estratégico sênior especializado em estruturação, posicionamento e escala de clínicas e empresas de serviços complexos.\r\n\r\nSeu papel é produzir um RELATÓRIO EXECUTIVO FINAL de altíssimo nível a partir de múltiplos relatórios intermediários:\r\n- Identidade\r\n- Mercado\r\n- Oferta\r\n- Operações\r\n- Pessoas, Cultura & Gestão\r\n- Estratégia (síntese)\r\n- Plano (desdobramento)\r\n\r\nRegras fundamentais:\r\n\r\n1. Você NÃO deve repetir conteúdos já apresentados nos relatórios anteriores.\r\n2. Você NÃO deve explicar conceitos básicos.\r\n3. Você NÃO deve fazer um resumo seção por seção.\r\n\r\nSeu trabalho é:\r\n- Integrar\r\n- Sintetizar\r\n- Resolver conflitos\r\n- Priorizar\r\n- Fazer escolhas claras\r\n- Assumir renúncias\r\n- Apontar riscos reais\r\n- Apontar alavancas reais\r\n- Criar um plano mestre de execução\r\n\r\nO tom deve ser:\r\n- Executivo\r\n- Direto\r\n- Sem marketing\r\n- Sem frases bonitas vazias\r\n- Sem autoengano\r\n- Orientado a decisão e trade-offs\r\n\r\nVocê deve escrever como se este documento fosse:\r\n- Apresentado a sócios\r\n- Usado para planejar os próximos 12–36 meses\r\n- Usado para guiar investimento, contratações e foco estratégico\r\n\r\nVocê deve preferir:\r\n- Clareza a diplomacia\r\n- Verdade a conforto\r\n- Decisão a ambiguidade\r\n\r\nEste documento deve responder o tempo todo:\r\n\"Se eu fosse dono dessa clínica, o que eu faria a partir de amanhã?\"\r\n\r\nEstrutura obrigatória do relatório:\r\n\r\n1. **Resumo Executivo** (para sócios)\r\n   - Situação atual em 3-5 frases\r\n   - Tese estratégica em 1 parágrafo\r\n   - As 3 decisões mais importantes\r\n\r\n2. **A Tese Estratégica da Clínica**\r\n   - Qual é o jogo que a clínica está jogando?\r\n   - Por que ela pode vencer esse jogo?\r\n   - Qual é a aposta central?\r\n\r\n3. **Diagnóstico Integrado do Negócio**\r\n   - Não repita relatórios anteriores\r\n   - Integre: onde identity, market, offer, operations e people se encontram ou colidem?\r\n   - Identifique padrões e tensões estruturais\r\n\r\n4. **Os Principais Gargalos Estruturais**\r\n   - O que impede crescimento hoje?\r\n   - O que vai impedir crescimento amanhã?\r\n   - Seja específico e hierarquize\r\n\r\n5. **As Principais Alavancas de Crescimento**\r\n   - O que pode desbloquear valor rapidamente?\r\n   - O que pode desbloquear valor estruturalmente?\r\n   - Priorize por impacto vs esforço\r\n\r\n6. **As Decisões Difíceis (Renúncias Estratégicas)**\r\n   - O que a clínica deve PARAR de fazer?\r\n   - O que a clínica deve EVITAR fazer?\r\n   - Quais oportunidades devem ser conscientemente ignoradas?\r\n\r\n7. **O Plano-Mestre em 3 Horizontes**\r\n   - Horizonte 1 (0–6 meses): estabilizar e corrigir gargalos críticos\r\n   - Horizonte 2 (6–18 meses): construir capacidades e escalar\r\n   - Horizonte 3 (18–36 meses): consolidar posição e expandir\r\n\r\n8. **Mapa de Prioridades Estratégicas**\r\n   - Top 5-7 prioridades absolutas\r\n   - Para cada uma: por quê, o quê, como, quando, quem\r\n\r\n9. **Indicadores-Chave que Governam a Clínica**\r\n   - Quais 5-10 métricas realmente importam?\r\n   - O que observar semanalmente, mensalmente, trimestralmente?\r\n\r\n10. **Principais Riscos e Planos de Contenção**\r\n    - Top 3-5 riscos que podem quebrar a estratégia\r\n    - O que fazer se cada um se concretizar?\r\n\r\n11. **Conclusão Executiva: As 3 Decisões Mais Importantes**\r\n    - Se o dono pudesse tomar apenas 3 decisões nos próximos 90 dias, quais seriam?\r\n    - Por quê essas e não outras?\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 2000 a 3000 palavras.\r\n- Seja denso em conteúdo, mas claro na forma.\r\n- Use dados e insights dos relatórios anteriores sem repeti-los literalmente.\r\n\r\nTOM e estilo:\r\n- Executivo e decisivo\r\n- Honesto e direto\r\n- Orientado a ação\r\n- Sem eufemismos ou linguagem corporativa vazia\r\n\r\nAtenção ao rigor:\r\n- Não invente dados ou insights que não estejam nos relatórios fornecidos.\r\n- Seja honesto sobre lacunas e incertezas.\r\n- Priorize clareza brutal sobre conforto diplomático.\r\n  `,\r\n}\r\n\r\n// Formato de saída esperado\r\nconst OUTPUT_FORMAT = `\r\nIMPORTANTE: Responda APENAS com um objeto json válido. A resposta completa deve ser um json puro, sem texto adicional antes ou depois.\r\n\r\nVocê DEVE retornar um JSON válido com a seguinte estrutura EXATA:\r\n\r\n{\r\n  \"report_markdown\": \"# Relatório da Seção [Nome da Seção]\\\\n\\\\n[Conteúdo completo em Markdown]\",\r\n  \"insights\": {\r\n    \"score\": {\r\n      \"clarity\": 0-10,\r\n      \"consistency\": 0-10,\r\n      \"completeness\": 0-10,\r\n      \"impact_potential\": 0-10\r\n    },\r\n    \"identity_summary\": {\r\n      \"purpose\": \"...\",\r\n      \"vision\": \"...\",\r\n      \"values\": [\"...\", \"...\"],\r\n      \"priority_audience\": \"...\",\r\n      \"positioning\": \"...\",\r\n      \"growth_focus\": \"...\"\r\n    },\r\n    \"alerts\": [\r\n      {\r\n        \"severity\": \"high|medium|low\",\r\n        \"title\": \"Título do alerta\",\r\n        \"detail\": \"Descrição detalhada\",\r\n        \"evidence\": [\"question_code ou referência a entidade\"]\r\n      }\r\n    ],\r\n    \"recommendations\": [\r\n      {\r\n        \"priority\": 1-5,\r\n        \"title\": \"Título da recomendação\",\r\n        \"detail\": \"Descrição detalhada\",\r\n        \"effort\": \"low|medium|high\",\r\n        \"expected_impact\": \"low|medium|high\"\r\n      }\r\n    ],\r\n    \"missing_data\": [\r\n      {\r\n        \"item\": \"O que está faltando\",\r\n        \"why_it_matters\": \"Por que isso importa\",\r\n        \"how_to_fill\": \"Como preencher\"\r\n      }\r\n    ],\r\n    \"contradictions\": [\r\n      {\r\n        \"title\": \"Título da contradição\",\r\n        \"detail\": \"Descrição detalhada\",\r\n        \"evidence\": [\"referências aos dados\"]\r\n      }\r\n    ],\r\n    \"checklist\": [\"...\", \"...\"],\r\n    \"tags\": [\"tag1\", \"tag2\"]\r\n  }\r\n}\r\n\r\nIMPORTANTE:\r\n- O report_markdown deve ser completo e descritivo, incluindo:\r\n  * Resumo executivo (5-8 linhas)\r\n  * O que está bem definido (bullet points)\r\n  * Lacunas relevantes (o que falta e por que importa)\r\n  * Riscos e contradições (com referências aos dados)\r\n  * Recomendações práticas (priorizadas, com \"por quê\")\r\n  * Checklist de melhoria (itens objetivos)\r\n  * Pontuação (0-10) para clareza, consistência, completude, potencial de impacto\r\n\r\n- O insights JSON deve ser válido e parseável sem ambiguidades.\r\n- Todos os campos são obrigatórios (arrays podem estar vazios).\r\n- Para seções que não sejam IDENTITY, o campo \"identity_summary\" pode ser um objeto vazio {}.\r\n`\r\n\r\n/**\r\n * Constrói o prompt completo para geração de relatório de uma seção\r\n */\r\nexport function buildSectionReportPrompt(\r\n  sectionCode: string,\r\n  snapshot: SectionSnapshot,\r\n  tone: string = 'intermediario',\r\n): string {\r\n  const sectionInstruction = SECTION_INSTRUCTIONS[sectionCode] || `\r\nAnalise a seção ${sectionCode} com base nos dados fornecidos.\r\nIdentifique pontos fortes, lacunas, riscos e oportunidades.\r\n  `\r\n\r\n  // Para IDENTITY, usar prompt específico com snapshot JSON diretamente\r\n  if (sectionCode === 'IDENTITY') {\r\n    const snapshotJson = JSON.stringify(snapshot, null, 2)\r\n    \r\n    return `\r\n${sectionInstruction}\r\n\r\nGere um RELATÓRIO EXECUTIVO DE IDENTIDADE da clínica com base no snapshot abaixo.\r\n\r\nObjetivo do relatório:\r\n- Explicar, de forma detalhada e bem descritiva, qual é a identidade estratégica da clínica (propósito, visão, valores, foco, posicionamento e escolhas).\r\n- Transformar as respostas em um \"norte\" prático: como essa identidade deve orientar decisões de público, oferta, experiência e crescimento.\r\n- Destacar contradições e lacunas e como resolvê-las.\r\n- Propor ações críticas e características-chave (se já existirem, avaliar; se não existirem, sugerir rascunhos com base no que foi fornecido, deixando claro que são sugestões).\r\n\r\nRequisitos de profundidade:\r\n- O relatório deve ter pelo menos 900 a 1400 palavras (aprox.), com seções completas, exemplos e justificativas.\r\n- Use os dados do snapshot de forma explícita (referencie termos e decisões declaradas, sem citar o snapshot literalmente).\r\n\r\nTOM e estilo:\r\n- Profissional, claro e humano, como um consultor falando com o dono.\r\n- Não use linguagem motivacional vaga. Seja prático.\r\n- Não mencione nenhum livro, autor ou framework.\r\n\r\nAtenção ao rigor:\r\n- Não invente segmentos, serviços, preços, ou estratégias não fornecidas.\r\n- Se houver contradições, descreva a contradição e o impacto provável.\r\n- Se faltarem dados, liste perguntas de follow-up.\r\n\r\nSnapshot (JSON):\r\n${snapshotJson}\r\n\r\n${OUTPUT_FORMAT}\r\n\r\nIMPORTANTE: \r\n- O report_markdown DEVE ser COMPLETO e NÃO CORTADO. \r\n- Se o limite de tokens for atingido, priorize completar o report_markdown mesmo que alguns campos do insights fiquem vazios.\r\n- O relatório deve ter TODAS as 12 seções mencionadas na estrutura recomendada.\r\n- NÃO corte o conteúdo no meio de uma frase ou seção.\r\n  `.trim()\r\n  }\r\n\r\n  // Para outras seções, usar formato padrão\r\n  return `\r\n${sectionInstruction}\r\n\r\n**DADOS DA CLÍNICA E DO DOSSIÊ:**\r\n\r\nClínica: ${snapshot.clinic.name} (ID: ${snapshot.clinic.id})\r\nDossiê: ${snapshot.dossier.title}\r\nData de referência: ${snapshot.dossier.baseline_date || 'Não definida'}\r\n\r\n**SEÇÃO:** ${snapshot.section.name}\r\n${snapshot.section.description ? `Descrição: ${snapshot.section.description}` : ''}\r\n\r\n**COMPLETUDE DA SEÇÃO:** ${snapshot.completeness.percent}%\r\n${snapshot.completeness.missing_items.length > 0 ? `Itens faltantes: ${snapshot.completeness.missing_items.join(', ')}` : ''}\r\n\r\n**RESPOSTAS DO QUESTIONÁRIO:**\r\n\r\n${snapshot.answers.map((a) => `\r\n**${a.question_text}** (${a.question_code})\r\n${a.required ? '[OBRIGATÓRIO]' : '[OPCIONAL]'}\r\nResposta: ${formatAnswerValue(a.value_normalized)}\r\n${a.required && !a.value_normalized ? '⚠️ NÃO PREENCHIDO' : ''}\r\n`).join('\\n')}\r\n\r\n**ENTIDADES ESTRUTURADAS:**\r\n\r\n${Object.entries(snapshot.entities)\r\n  .map(([key, values]) => {\r\n    if (!values || values.length === 0) return `**${key}**: Nenhum cadastrado`\r\n    return `**${key}** (${values.length} item(s)):\\n${values.map((v: any) => `- ${formatEntityValue(v)}`).join('\\n')}`\r\n  })\r\n  .join('\\n\\n')}\r\n\r\n**FLAGS DE QUALIDADE DE DADOS:**\r\n\r\n${snapshot.data_quality_flags.length > 0\r\n  ? snapshot.data_quality_flags.map((flag) => `⚠️ ${flag}`).join('\\n')\r\n  : 'Nenhum flag detectado'}\r\n\r\n---\r\n\r\n${OUTPUT_FORMAT}\r\n\r\nGere o relatório completo e os insights estruturados baseados EXCLUSIVAMENTE nos dados fornecidos acima.\r\nSeja específico, cite dados concretos e evite generalizações.\r\n  `.trim()\r\n}\r\n\r\n/**\r\n * Formata o valor de uma resposta para exibição no prompt\r\n */\r\nfunction formatAnswerValue(value: any): string {\r\n  if (value === null || value === undefined || value === '') {\r\n    return '[Não preenchido]'\r\n  }\r\n\r\n  if (typeof value === 'object') {\r\n    if (Array.isArray(value)) {\r\n      return value.length > 0 ? value.join(', ') : '[Vazio]'\r\n    }\r\n    if (value.formatted) {\r\n      return value.formatted\r\n    }\r\n    return JSON.stringify(value)\r\n  }\r\n\r\n  return String(value)\r\n}\r\n\r\n/**\r\n * Formata uma entidade para exibição no prompt\r\n */\r\nfunction formatEntityValue(entity: any): string {\r\n  if (entity.name) return entity.name\r\n  if (entity.title) return entity.title\r\n  return JSON.stringify(entity)\r\n}\r\n\r\n/**\r\n * Formata o snapshot completo para o prompt\r\n */\r\nfunction formatSnapshotForPrompt(snapshot: SectionSnapshot): string {\r\n  return JSON.stringify(snapshot, null, 2)\r\n}\r\n\r\n/**\r\n * Constrói o prompt para geração do Relatório Final consolidado\r\n */\r\nexport function buildFinalReportPrompt(\r\n  snapshot: any, // FinalSnapshot\r\n  tone: string = 'intermediario',\r\n): string {\r\n  const finalReportInstruction = `\r\n${SECTION_INSTRUCTIONS['FINAL_REPORT']}\r\n\r\n**CONTEXTO:**\r\nVocê recebeu relatórios detalhados de cada área estratégica da clínica. Algumas áreas podem estar completas, outras podem ter lacunas.\r\n\r\n**DADOS CONSOLIDADOS:**\r\n\r\nClínica: ${snapshot.clinic.name}\r\nDossiê: ${snapshot.dossier.title}\r\nData de referência: ${snapshot.dossier.baseline_date || 'Não definida'}\r\n\r\n**MÉTRICAS GLOBAIS:**\r\n\r\nScores Médios:\r\n- Clareza: ${snapshot.global_metrics.average_scores.clarity.toFixed(1)}/10\r\n- Consistência: ${snapshot.global_metrics.average_scores.consistency.toFixed(1)}/10\r\n- Completude: ${snapshot.global_metrics.average_scores.completeness.toFixed(1)}/10\r\n- Potencial de Impacto: ${snapshot.global_metrics.average_scores.impact_potential.toFixed(1)}/10\r\n\r\nAlertas:\r\n- Alta severidade: ${snapshot.global_metrics.high_severity_alerts}\r\n- Média severidade: ${snapshot.global_metrics.medium_severity_alerts}\r\n- Baixa severidade: ${snapshot.global_metrics.low_severity_alerts}\r\n\r\nTotal de recomendações: ${snapshot.global_metrics.total_recommendations}\r\n\r\n**RELAÇÃO DE SEÇÕES:**\r\n\r\n${snapshot.sections.map((section: any) => {\r\n  const status = section.has_report\r\n    ? section.is_stale\r\n      ? '⚠️ DESATUALIZADO'\r\n      : '✅ ATUALIZADO'\r\n    : '❌ NÃO GERADO'\r\n  return `\r\n**${section.section_name}** (${section.section_code}) - ${status}\r\n${section.has_report ? `Scores: C=${section.scores?.clarity || 0}/10, Co=${section.scores?.consistency || 0}/10, Cp=${section.scores?.completeness || 0}/10, I=${section.scores?.impact_potential || 0}/10` : 'Sem relatório disponível'}\r\n${section.alerts && section.alerts.length > 0 ? `Alertas: ${section.alerts.length} (${section.alerts.filter((a: any) => a.severity === 'high').length} alta, ${section.alerts.filter((a: any) => a.severity === 'medium').length} média, ${section.alerts.filter((a: any) => a.severity === 'low').length} baixa)` : ''}\r\n${section.recommendations && section.recommendations.length > 0 ? `Recomendações: ${section.recommendations.length}` : ''}\r\n${section.report_markdown ? `\\nResumo do relatório:\\n${section.report_markdown.substring(0, 500)}...` : ''}\r\n`\r\n}).join('\\n')}\r\n\r\n${snapshot.missing_sections.length > 0 ? `\\n⚠️ **SEÇÕES SEM RELATÓRIO:** ${snapshot.missing_sections.join(', ')}\\nExplique no relatório que essas áreas não foram analisadas e por que isso importa.` : ''}\r\n\r\n${snapshot.stale_sections.length > 0 ? `\\n⚠️ **SEÇÕES DESATUALIZADAS:** ${snapshot.stale_sections.join(', ')}\\nOs dados dessas seções foram alterados após a geração dos relatórios.` : ''}\r\n\r\n**TOP RECOMENDAÇÕES (agrupadas):**\r\n\r\n${snapshot.global_metrics.top_recommendations.slice(0, 10).map((rec: any, idx: number) => \r\n  `${idx + 1}. ${rec.title} (Prioridade: ${rec.priority}, Mencionada ${rec.frequency}x)`\r\n).join('\\n')}\r\n\r\n---\r\n\r\n**FORMATO DE SAÍDA ESPERADO:**\r\n\r\nVocê DEVE retornar um JSON válido com a seguinte estrutura EXATA:\r\n\r\n{\r\n  \"report_markdown\": \"# Relatório Estratégico Consolidado\\\\n\\\\n[Conteúdo completo em Markdown seguindo a estrutura obrigatória acima]\",\r\n  \"insights\": {\r\n    \"global_score\": {\r\n      \"clarity\": 0-10,\r\n      \"consistency\": 0-10,\r\n      \"completeness\": 0-10,\r\n      \"impact_potential\": 0-10\r\n    },\r\n    \"top_priorities\": [\r\n      {\r\n        \"rank\": 1-7,\r\n        \"title\": \"Título da prioridade\",\r\n        \"rationale\": \"Por que é prioridade\",\r\n        \"expected_impact\": \"high|medium|low\",\r\n        \"effort\": \"high|medium|low\"\r\n      }\r\n    ],\r\n    \"critical_risks\": [\r\n      {\r\n        \"severity\": \"high|medium|low\",\r\n        \"title\": \"Título do risco\",\r\n        \"detail\": \"Descrição detalhada\",\r\n        \"affected_sections\": [\"IDENTITY\", \"MARKET\", ...]\r\n      }\r\n    ],\r\n    \"key_opportunities\": [\r\n      {\r\n        \"title\": \"Título da oportunidade\",\r\n        \"detail\": \"Descrição\",\r\n        \"potential_impact\": \"high|medium|low\",\r\n        \"effort_required\": \"high|medium|low\"\r\n      }\r\n    ],\r\n    \"strategic_focus\": [\"foco 1\", \"foco 2\", ...],\r\n    \"kill_list\": [\"coisa a parar de fazer 1\", \"coisa a parar de fazer 2\", ...],\r\n    \"missing_sections\": [\"seção sem relatório 1\", ...]\r\n  }\r\n}\r\n\r\n**INSTRUÇÕES IMPORTANTES:**\r\n\r\n- O report_markdown deve seguir EXATAMENTE a estrutura de 11 seções definida nas instruções iniciais\r\n- Seja específico e cite dados concretos dos relatórios setoriais fornecidos\r\n- Priorize clareza e acionabilidade sobre complexidade\r\n- Identifique contradições entre seções e resolva-as explicitamente\r\n- Seja honesto sobre lacunas (seções faltantes ou desatualizadas)\r\n- O relatório deve responder: \"Se eu fosse dono dessa clínica, o que eu faria a partir de amanhã?\"\r\n- Use tom ${tone === 'formal' ? 'formal e técnico' : tone === 'informal' ? 'acessível e direto' : 'executivo e profissional'}\r\n- O documento deve ter entre 2000-3000 palavras\r\n\r\nGere o relatório final completo e os insights estruturados baseados EXCLUSIVAMENTE nos dados fornecidos acima.\r\n  `.trim()\r\n\r\n  return finalReportInstruction\r\n}\r\n\r\n/**\r\n * Exporta SECTION_INSTRUCTIONS para uso no admin\r\n */\r\nexport function getSectionInstruction(sectionCode: string): string {\r\n  return SECTION_INSTRUCTIONS[sectionCode] || ''\r\n}\r\n\r\n","// Versão server-side do AI client\r\nimport { getSystemPrompt, buildSectionReportPrompt } from '@/lib/section-prompts'\r\nimport type { SectionSnapshot } from './snapshotBuilder'\r\nimport pool from './db'\r\n\r\nexport interface InsightsJSON {\r\n  score: {\r\n    clarity: number\r\n    consistency: number\r\n    completeness: number\r\n    impact_potential: number\r\n  }\r\n  identity_summary?: {\r\n    purpose?: string\r\n    vision?: string\r\n    values?: string[]\r\n    priority_audience?: string\r\n    positioning?: string\r\n    growth_focus?: string\r\n  }\r\n  alerts: Array<{\r\n    severity: 'high' | 'medium' | 'low'\r\n    title: string\r\n    detail: string\r\n    evidence: string[]\r\n  }>\r\n  recommendations: Array<{\r\n    priority: number\r\n    title: string\r\n    detail: string\r\n    effort: 'low' | 'medium' | 'high'\r\n    expected_impact: 'low' | 'medium' | 'high'\r\n  }>\r\n  missing_data: Array<{\r\n    item: string\r\n    why_it_matters: string\r\n    how_to_fill: string\r\n  }>\r\n  contradictions: Array<{\r\n    title: string\r\n    detail: string\r\n    evidence: string[]\r\n  }>\r\n  checklist?: string[]\r\n  tags: string[]\r\n}\r\n\r\nexport interface AIReportResponse {\r\n  report_markdown: string\r\n  insights: InsightsJSON\r\n}\r\n\r\nexport interface GenerateOptions {\r\n  apiKey: string\r\n  model?: string\r\n  temperature?: number\r\n  promptVersion?: string\r\n  tone?: string\r\n}\r\n\r\nconst DEFAULT_MODEL = 'gpt-4o'\r\nconst DEFAULT_TEMPERATURE = 0.5 // 0.4-0.6 para IDENTITY conforme especificado\r\nconst DEFAULT_TONE = 'intermediario'\r\n\r\n/**\r\n * Busca prompt customizado do banco de dados\r\n * Retorna null se não encontrar, para usar fallback do código\r\n */\r\nasync function getCustomPromptFromDB(\r\n  promptKey: string,\r\n): Promise<{ system_prompt: string | null; user_prompt: string | null } | null> {\r\n  try {\r\n    const result = await pool.query(\r\n      `SELECT system_prompt, user_prompt\r\n       FROM ai_prompt_templates\r\n       WHERE key = $1 AND is_active = true\r\n       ORDER BY created_at DESC\r\n       LIMIT 1`,\r\n      [promptKey],\r\n    )\r\n\r\n    if (result.rows.length > 0) {\r\n      return {\r\n        system_prompt: result.rows[0].system_prompt,\r\n        user_prompt: result.rows[0].user_prompt,\r\n      }\r\n    }\r\n\r\n    return null\r\n  } catch (error: any) {\r\n    console.warn('Erro ao buscar prompt do banco:', error.message)\r\n    return null\r\n  }\r\n}\r\n\r\n/**\r\n * Substitui placeholders no user prompt (ex: {{SNAPSHOT_JSON}})\r\n */\r\nfunction replacePlaceholders(userPrompt: string, snapshot: SectionSnapshot): string {\r\n  const snapshotJson = JSON.stringify(snapshot, null, 2)\r\n  return userPrompt.replace(/\\{\\{SNAPSHOT_JSON\\}\\}/g, snapshotJson)\r\n}\r\n\r\nexport async function generateSectionReport(\r\n  sectionCode: string,\r\n  snapshot: SectionSnapshot,\r\n  options: GenerateOptions,\r\n): Promise<{\r\n  report_markdown: string\r\n  insights: InsightsJSON\r\n  token_usage?: any\r\n}> {\r\n  const {\r\n    apiKey,\r\n    model = DEFAULT_MODEL,\r\n    temperature = DEFAULT_TEMPERATURE,\r\n    tone = DEFAULT_TONE,\r\n  } = options\r\n\r\n  let systemPrompt: string\r\n  let userPrompt: string\r\n  \r\n  try {\r\n    // Tentar buscar prompt customizado do banco primeiro\r\n    const promptKey = `section_${sectionCode}`\r\n    const customPrompt = await getCustomPromptFromDB(promptKey)\r\n\r\n    if (customPrompt && (customPrompt.system_prompt || customPrompt.user_prompt)) {\r\n      // Usar prompts customizados do banco\r\n      systemPrompt = customPrompt.system_prompt || getSystemPrompt(tone)\r\n      \r\n      if (customPrompt.user_prompt) {\r\n        // Substituir placeholders no user prompt\r\n        userPrompt = replacePlaceholders(customPrompt.user_prompt, snapshot)\r\n      } else {\r\n        // Se não tiver user_prompt customizado, usar o do código\r\n        userPrompt = buildSectionReportPrompt(sectionCode, snapshot, tone)\r\n      }\r\n      \r\n      console.log(`Usando prompts customizados do banco para ${sectionCode}`)\r\n    } else {\r\n      // Fallback: usar prompts do código\r\n      systemPrompt = getSystemPrompt(tone)\r\n      userPrompt = buildSectionReportPrompt(sectionCode, snapshot, tone)\r\n      console.log(`Usando prompts do código para ${sectionCode}`)\r\n    }\r\n  } catch (importError: any) {\r\n    console.error('Erro ao carregar prompts:', importError)\r\n    // Fallback em caso de erro\r\n    systemPrompt = getSystemPrompt(tone)\r\n    userPrompt = buildSectionReportPrompt(sectionCode, snapshot, tone)\r\n  }\r\n\r\n  // 8000 tokens para todas as seções - suficiente para relatórios completos + JSON structure\r\n  const maxTokens = 8000\r\n\r\n  let response: Response\r\n  try {\r\n    response = await fetch('https://api.openai.com/v1/chat/completions', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        Authorization: `Bearer ${apiKey}`,\r\n      },\r\n      body: JSON.stringify({\r\n        model,\r\n        messages: [\r\n          {\r\n            role: 'system',\r\n            content: systemPrompt,\r\n          },\r\n          {\r\n            role: 'user',\r\n            content: userPrompt,\r\n          },\r\n        ],\r\n        temperature,\r\n        max_tokens: maxTokens,\r\n        response_format: { type: 'json_object' },\r\n      }),\r\n    })\r\n  } catch (fetchError: any) {\r\n    console.error('Erro na requisição para OpenAI:', fetchError)\r\n    throw new Error(`Erro de conexão com OpenAI: ${fetchError.message}`)\r\n  }\r\n\r\n  if (!response.ok) {\r\n    const errorText = await response.text().catch(() => response.statusText)\r\n    let errorData: any\r\n    try {\r\n      errorData = JSON.parse(errorText)\r\n    } catch {\r\n      errorData = { error: { message: errorText } }\r\n    }\r\n    console.error('Erro da API OpenAI:', errorData)\r\n    throw new Error(`Erro na API OpenAI: ${errorData.error?.message || response.statusText} (Status: ${response.status})`)\r\n  }\r\n\r\n  let data: any\r\n  try {\r\n    data = await response.json()\r\n  } catch (parseError: any) {\r\n    console.error('Erro ao parsear resposta da OpenAI:', parseError)\r\n    throw new Error('Resposta inválida da OpenAI')\r\n  }\r\n\r\n  const content = data.choices[0]?.message?.content\r\n\r\n  if (!content) {\r\n    console.error('Resposta vazia da OpenAI. Data recebida:', JSON.stringify(data).substring(0, 500))\r\n    throw new Error('Resposta vazia da OpenAI')\r\n  }\r\n\r\n  // Verificar se a resposta foi cortada (finish_reason = 'length')\r\n  const finishReason = data.choices[0]?.finish_reason\r\n  if (finishReason === 'length') {\r\n    console.warn('⚠️ ATENÇÃO: Resposta da IA foi cortada por limite de tokens!')\r\n    console.warn('Token usage:', data.usage)\r\n    console.warn('Tamanho do conteúdo recebido:', content.length, 'caracteres')\r\n  }\r\n\r\n  try {\r\n    const parsed = parseAIResponse(content)\r\n\r\n    // Verificar se o report_markdown está completo\r\n    if (parsed.report_markdown) {\r\n      console.log(`Report markdown gerado: ${parsed.report_markdown.length} caracteres`)\r\n      if (finishReason === 'length' && parsed.report_markdown.length < 2000) {\r\n        console.warn('⚠️ Relatório pode estar incompleto devido ao limite de tokens')\r\n      }\r\n    }\r\n\r\n    return {\r\n      report_markdown: parsed.report_markdown,\r\n      insights: parsed.insights,\r\n      token_usage: data.usage,\r\n    }\r\n  } catch (parseError: any) {\r\n    console.error('Erro ao parsear resposta da IA:', parseError)\r\n    console.error('Conteúdo recebido (primeiros 1000 chars):', content.substring(0, 1000))\r\n    console.error('Conteúdo recebido (últimos 500 chars):', content.substring(Math.max(0, content.length - 500)))\r\n    throw new Error(`Erro ao processar resposta da IA: ${parseError.message}`)\r\n  }\r\n}\r\n\r\nfunction parseAIResponse(content: string): AIReportResponse {\r\n  // Log do conteúdo recebido para debug\r\n  console.log('Parseando resposta da IA. Tamanho:', content.length)\r\n  console.log('Primeiros 500 caracteres:', content.substring(0, 500))\r\n\r\n  // 1. Tentar parse JSON direto\r\n  try {\r\n    const parsed = JSON.parse(content)\r\n    if (validateAIResponse(parsed)) {\r\n      console.log('Parse bem-sucedido: JSON direto válido')\r\n      return parsed\r\n    } else {\r\n      console.warn('JSON parseado mas validação falhou')\r\n    }\r\n  } catch (error: any) {\r\n    console.log('Erro no parse JSON direto:', error.message)\r\n  }\r\n\r\n  // 2. Tentar extrair JSON de markdown code blocks\r\n  try {\r\n    const jsonMatch = content.match(/```json\\s*([\\s\\S]*?)\\s*```/) || content.match(/\\{[\\s\\S]*\\}/)\r\n    if (jsonMatch) {\r\n      const jsonStr = jsonMatch[1] || jsonMatch[0]\r\n      const parsed = JSON.parse(jsonStr)\r\n      if (validateAIResponse(parsed)) {\r\n        console.log('Parse bem-sucedido: JSON extraído de markdown')\r\n        return parsed\r\n      } else {\r\n        console.warn('JSON extraído mas validação falhou')\r\n      }\r\n    }\r\n  } catch (error: any) {\r\n    console.log('Erro ao extrair JSON de markdown:', error.message)\r\n  }\r\n\r\n  // 3. Tentar corrigir estrutura (campos faltantes)\r\n  try {\r\n    const parsed = JSON.parse(content)\r\n    const corrected = {\r\n      report_markdown: parsed.report_markdown || parsed.report || '# Relatório\\n\\nErro ao processar resposta.',\r\n      insights: correctInsightsStructure(parsed.insights || parsed),\r\n    }\r\n    if (validateAIResponse(corrected)) {\r\n      console.log('Parse bem-sucedido: JSON corrigido')\r\n      return corrected\r\n    } else {\r\n      console.warn('JSON corrigido mas validação ainda falhou')\r\n      // Verificar se o report_markdown está presente e tem tamanho razoável\r\n      if (corrected.report_markdown && corrected.report_markdown.length > 100) {\r\n        console.warn('Retornando resposta parcial (sem validação completa) - report_markdown presente')\r\n        return corrected as AIReportResponse\r\n      }\r\n    }\r\n  } catch (error: any) {\r\n    console.log('Erro ao corrigir JSON:', error.message)\r\n    // Se o erro for de JSON truncado, tentar extrair o que for possível\r\n    if (error.message.includes('Unexpected end') || error.message.includes('truncated')) {\r\n      console.warn('JSON parece estar truncado. Tentando extrair conteúdo parcial...')\r\n      try {\r\n        // Tentar encontrar o report_markdown mesmo com JSON incompleto\r\n        const markdownMatch = content.match(/\"report_markdown\"\\s*:\\s*\"([^\"]*(?:\\\\.[^\"]*)*)\"/)\r\n        if (markdownMatch && markdownMatch[1]) {\r\n          const extractedMarkdown = markdownMatch[1].replace(/\\\\n/g, '\\n').replace(/\\\\\"/g, '\"')\r\n          console.warn('Extraído report_markdown parcial do JSON truncado')\r\n          return {\r\n            report_markdown: extractedMarkdown,\r\n            insights: correctInsightsStructure({}),\r\n          }\r\n        }\r\n      } catch (extractError) {\r\n        console.error('Erro ao extrair conteúdo parcial:', extractError)\r\n      }\r\n    }\r\n  }\r\n\r\n  // 4. Última tentativa: criar resposta mínima\r\n  console.error('Não foi possível parsear resposta. Tamanho do conteúdo:', content.length)\r\n  console.error('Primeiros 500 chars:', content.substring(0, 500))\r\n  console.error('Últimos 500 chars:', content.substring(Math.max(0, content.length - 500)))\r\n  throw new Error(`Não foi possível parsear a resposta da IA. Formato inválido. Tamanho: ${content.length} caracteres`)\r\n}\r\n\r\nfunction validateAIResponse(data: any): data is AIReportResponse {\r\n  if (!data || typeof data !== 'object') return false\r\n  if (!data.report_markdown || typeof data.report_markdown !== 'string') return false\r\n  if (!data.insights || typeof data.insights !== 'object') return false\r\n\r\n  const insights = data.insights\r\n  if (!insights.score || typeof insights.score !== 'object') return false\r\n  if (typeof insights.score.clarity !== 'number') return false\r\n  if (typeof insights.score.consistency !== 'number') return false\r\n  if (typeof insights.score.completeness !== 'number') return false\r\n  if (typeof insights.score.impact_potential !== 'number') return false\r\n\r\n  // identity_summary é opcional (apenas para IDENTITY)\r\n  if (insights.identity_summary && typeof insights.identity_summary !== 'object') return false\r\n\r\n  if (!Array.isArray(insights.alerts)) return false\r\n  if (!Array.isArray(insights.recommendations)) return false\r\n  if (!Array.isArray(insights.missing_data)) return false\r\n  if (!Array.isArray(insights.contradictions)) return false\r\n  if (insights.checklist && !Array.isArray(insights.checklist)) return false\r\n  if (!Array.isArray(insights.tags)) return false\r\n\r\n  return true\r\n}\r\n\r\nfunction correctInsightsStructure(insights: any): InsightsJSON {\r\n  return {\r\n    score: {\r\n      clarity: insights.score?.clarity ?? insights.clarity ?? 5,\r\n      consistency: insights.score?.consistency ?? insights.consistency ?? 5,\r\n      completeness: insights.score?.completeness ?? insights.completeness ?? 5,\r\n      impact_potential: insights.score?.impact_potential ?? insights.impact_potential ?? 5,\r\n    },\r\n    identity_summary: insights.identity_summary || undefined,\r\n    alerts: Array.isArray(insights.alerts) ? insights.alerts : [],\r\n    recommendations: Array.isArray(insights.recommendations) ? insights.recommendations : [],\r\n    missing_data: Array.isArray(insights.missing_data) ? insights.missing_data : [],\r\n    contradictions: Array.isArray(insights.contradictions) ? insights.contradictions : [],\r\n    checklist: Array.isArray(insights.checklist) ? insights.checklist : undefined,\r\n    tags: Array.isArray(insights.tags) ? insights.tags : [],\r\n  }\r\n}\r\n\r\nexport async function generateSectionReportWithRetry(\r\n  sectionCode: string,\r\n  snapshot: SectionSnapshot,\r\n  options: GenerateOptions,\r\n): Promise<{\r\n  report_markdown: string\r\n  insights: InsightsJSON\r\n  token_usage?: any\r\n}> {\r\n  try {\r\n    return await generateSectionReport(sectionCode, snapshot, options)\r\n  } catch (error: any) {\r\n    console.warn('Primeira tentativa falhou, tentando novamente...', error.message)\r\n    try {\r\n      return await generateSectionReport(sectionCode, snapshot, options)\r\n    } catch (retryError: any) {\r\n      throw new Error(`Falha após retry: ${retryError.message}`)\r\n    }\r\n  }\r\n}\r\n\r\n\r\n\r\n","import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { authenticateToken, AuthRequest } from '@/lib/api-shared/auth'\r\nimport pool from '@/lib/api-shared/db'\r\nimport { buildSectionSnapshot } from '@/lib/api-shared/snapshotBuilder'\r\nimport { generateSectionReportWithRetry } from '@/lib/api-shared/section-ai-client'\r\n\r\nexport default async function handler(\r\n  req: VercelRequest,\r\n  res: VercelResponse,\r\n) {\r\n  res.setHeader('Access-Control-Allow-Credentials', 'true')\r\n  res.setHeader('Access-Control-Allow-Origin', '*')\r\n  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT')\r\n  res.setHeader('Access-Control-Allow-Headers', 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization')\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    res.status(200).end()\r\n    return\r\n  }\r\n\r\n  return authenticateToken(req as AuthRequest, res, async () => {\r\n    try {\r\n      const { method } = req\r\n      const authReq = req as AuthRequest\r\n      const user = authReq.user!\r\n      const dossierId = req.query.id as string\r\n      const sectionCode = req.query.sectionCode as string\r\n\r\n      if (!dossierId || !sectionCode) {\r\n        return res.status(400).json({ error: 'dossierId e sectionCode são obrigatórios' })\r\n      }\r\n\r\n      // Validar acesso ao dossiê\r\n      const dossierResult = await pool.query(\r\n        'SELECT clinic_id FROM dossiers WHERE id = $1',\r\n        [dossierId],\r\n      )\r\n\r\n      if (dossierResult.rows.length === 0) {\r\n        return res.status(404).json({ error: 'Dossiê não encontrado' })\r\n      }\r\n\r\n      const clinicId = dossierResult.rows[0].clinic_id\r\n\r\n      if (user.role !== 'admin' && user.clinicId !== clinicId) {\r\n        return res.status(403).json({ error: 'Acesso negado a este dossiê' })\r\n      }\r\n\r\n      // Validar seção\r\n      const sectionResult = await pool.query('SELECT id FROM sections WHERE code = $1', [\r\n        sectionCode,\r\n      ])\r\n\r\n      if (sectionResult.rows.length === 0) {\r\n        return res.status(404).json({ error: 'Seção não encontrada' })\r\n      }\r\n\r\n      const sectionId = sectionResult.rows[0].id\r\n\r\n      if (method === 'GET') {\r\n        // Retornar último relatório da seção\r\n        try {\r\n          const reportResult = await pool.query(\r\n            `SELECT * FROM ai_reports \r\n             WHERE dossier_id = $1 AND section_code = $2 \r\n             ORDER BY created_at DESC \r\n             LIMIT 1`,\r\n            [dossierId, sectionCode],\r\n          )\r\n\r\n          if (reportResult.rows.length === 0) {\r\n            return res.status(404).json({ error: 'Relatório ainda não gerado para esta seção' })\r\n          }\r\n\r\n          const report = reportResult.rows[0]\r\n          return res.status(200).json({\r\n            id: report.id,\r\n            status: report.status,\r\n            report_markdown: report.report_markdown,\r\n            insights: report.insights_json,\r\n            created_at: report.created_at,\r\n            updated_at: report.updated_at,\r\n            prompt_key: report.prompt_key,\r\n            prompt_version: report.prompt_version,\r\n            model: report.model,\r\n          })\r\n        } catch (dbError: any) {\r\n          console.error('Erro ao buscar relatório:', dbError)\r\n          return res.status(500).json({ \r\n            error: 'Erro ao buscar relatório',\r\n            message: dbError.message \r\n          })\r\n        }\r\n      }\r\n\r\n      if (method === 'POST') {\r\n        // Gerar novo relatório\r\n        const apiKey = process.env.OPENAI_API_KEY\r\n        if (!apiKey) {\r\n          console.error('OPENAI_API_KEY não configurada')\r\n          return res.status(500).json({ error: 'Configuração do servidor incompleta' })\r\n        }\r\n\r\n        try {\r\n          // 1. Build snapshot\r\n          console.log(`[${new Date().toISOString()}] Construindo snapshot para seção ${sectionCode} do dossiê ${dossierId}...`)\r\n          let snapshot: any\r\n          try {\r\n            snapshot = await buildSectionSnapshot(dossierId, sectionCode)\r\n            console.log(`[${new Date().toISOString()}] Snapshot construído com sucesso. Respostas: ${snapshot.answers?.length || 0}, Entidades: ${Object.keys(snapshot.entities || {}).length}`)\r\n          } catch (snapshotError: any) {\r\n            console.error(`[${new Date().toISOString()}] Erro ao construir snapshot:`, snapshotError)\r\n            throw new Error(`Erro ao construir snapshot: ${snapshotError.message}`)\r\n          }\r\n\r\n          // 2. Registrar evento\r\n          let reportId: string | null = null\r\n          try {\r\n            const eventResult = await pool.query(\r\n              `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n               VALUES (NULL, 'snapshot_built', $1)\r\n               RETURNING id`,\r\n              [JSON.stringify({ section_code: sectionCode, dossier_id: dossierId })],\r\n            )\r\n          } catch (error) {\r\n            // Ignorar erro de eventos (opcional)\r\n          }\r\n\r\n          // 3. Call LLM\r\n          console.log(`[${new Date().toISOString()}] Chamando IA para gerar relatório...`)\r\n          // Ajustar temperatura baseado na seção (IDENTITY usa 0.4-0.6)\r\n          const temperature = sectionCode === 'IDENTITY' ? 0.5 : 0.7\r\n          \r\n          let aiResult: any\r\n          try {\r\n            aiResult = await generateSectionReportWithRetry(sectionCode, snapshot, {\r\n              apiKey,\r\n              model: 'gpt-4o',\r\n              temperature,\r\n              promptVersion: '1.0.0',\r\n              tone: 'intermediario',\r\n            })\r\n            console.log(`[${new Date().toISOString()}] Relatório gerado pela IA com sucesso. Tamanho do markdown: ${aiResult.report_markdown?.length || 0} caracteres`)\r\n          } catch (aiError: any) {\r\n            console.error(`[${new Date().toISOString()}] Erro ao gerar relatório com IA:`, aiError)\r\n            throw new Error(`Erro na geração pela IA: ${aiError.message}`)\r\n          }\r\n\r\n          // 4. Persistir relatório\r\n          const insertResult = await pool.query(\r\n            `INSERT INTO ai_reports (\r\n              clinic_id, dossier_id, section_id, section_code, status,\r\n              input_snapshot_json, report_markdown, insights_json,\r\n              prompt_key, prompt_version, model, temperature, token_usage_json\r\n            ) VALUES ($1, $2, $3, $4, 'generated', $5, $6, $7, $8, $9, $10, $11, $12)\r\n            RETURNING id`,\r\n            [\r\n              clinicId,\r\n              dossierId,\r\n              sectionId,\r\n              sectionCode,\r\n              JSON.stringify(snapshot),\r\n              aiResult.report_markdown,\r\n              JSON.stringify(aiResult.insights),\r\n              'SECTION_REPORT_V1',\r\n              '1.0.0',\r\n              'gpt-4o',\r\n              temperature, // Usar a variável temperature calculada\r\n              aiResult.token_usage ? JSON.stringify(aiResult.token_usage) : null,\r\n            ],\r\n          )\r\n\r\n          reportId = insertResult.rows[0].id\r\n\r\n          // 5. Marcar relatórios anteriores como stale\r\n          await pool.query(\r\n            `UPDATE ai_reports\r\n             SET status = 'stale', updated_at = NOW()\r\n             WHERE dossier_id = $1 AND section_code = $2 AND id != $3 AND status = 'generated'`,\r\n            [dossierId, sectionCode, reportId],\r\n          )\r\n\r\n          // Marcar relatório final como stale quando uma seção é regenerada\r\n          await pool.query(\r\n            `UPDATE ai_reports\r\n             SET status = 'stale', updated_at = NOW()\r\n             WHERE dossier_id = $1 AND section_code = 'FINAL_REPORT' AND status = 'generated'`,\r\n            [dossierId],\r\n          )\r\n\r\n          // 6. Registrar eventos\r\n          try {\r\n            await pool.query(\r\n              `UPDATE ai_report_events SET ai_report_id = $1 WHERE ai_report_id IS NULL`,\r\n              [reportId],\r\n            )\r\n            await pool.query(\r\n              `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n               VALUES ($1, 'llm_called', $2)`,\r\n              [reportId, JSON.stringify({ model: 'gpt-4o', temperature: 0.7 })],\r\n            )\r\n            await pool.query(\r\n              `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n               VALUES ($1, 'persisted', $2)`,\r\n              [reportId, JSON.stringify({ success: true })],\r\n            )\r\n          } catch (error) {\r\n            // Ignorar erros de eventos\r\n          }\r\n\r\n          console.log(`Relatório gerado com sucesso: ${reportId}`)\r\n\r\n          return res.status(200).json({\r\n            id: reportId,\r\n            status: 'generated',\r\n            report_markdown: aiResult.report_markdown,\r\n            insights: aiResult.insights,\r\n            created_at: new Date().toISOString(),\r\n          })\r\n        } catch (error: any) {\r\n          console.error('Erro ao gerar relatório:', error)\r\n          console.error('Stack trace:', error.stack)\r\n\r\n          // Salvar erro no banco\r\n          try {\r\n            const errorReportResult = await pool.query(\r\n              `INSERT INTO ai_reports (\r\n                clinic_id, dossier_id, section_id, section_code, status,\r\n                input_snapshot_json, report_markdown, insights_json,\r\n                error_message, prompt_key, prompt_version, model\r\n              ) VALUES ($1, $2, $3, $4, 'error', $5, '', '{}', $6, $7, $8, $9)\r\n              RETURNING id`,\r\n              [\r\n                clinicId,\r\n                dossierId,\r\n                sectionId,\r\n                sectionCode,\r\n                JSON.stringify({ error: error.message, stack: error.stack }),\r\n                error.message || 'Erro desconhecido',\r\n                'SECTION_REPORT_V1',\r\n                '1.0.0',\r\n                'gpt-4o',\r\n              ],\r\n            )\r\n\r\n            // Registrar evento de erro\r\n            try {\r\n              await pool.query(\r\n                `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n                 VALUES ($1, 'error', $2)`,\r\n                [errorReportResult.rows[0].id, JSON.stringify({ error: error.message, stack: error.stack })],\r\n              )\r\n            } catch {\r\n              // Ignorar\r\n            }\r\n          } catch (dbError) {\r\n            console.error('Erro ao salvar erro no banco:', dbError)\r\n          }\r\n\r\n          // Retornar mensagem de erro mais detalhada\r\n          const errorMessage = error.message || 'Erro desconhecido'\r\n          const errorDetails = process.env.NODE_ENV === 'development' \r\n            ? {\r\n                stack: error.stack,\r\n                name: error.name,\r\n              }\r\n            : undefined\r\n\r\n          console.error('Erro completo:', {\r\n            message: errorMessage,\r\n            stack: error.stack,\r\n            name: error.name,\r\n          })\r\n\r\n          // Tentar buscar o relatório de erro salvo no banco\r\n          try {\r\n            const errorReportResult = await pool.query(\r\n              `SELECT * FROM ai_reports \r\n               WHERE dossier_id = $1 AND section_code = $2 AND status = 'error'\r\n               ORDER BY created_at DESC \r\n               LIMIT 1`,\r\n              [dossierId, sectionCode],\r\n            )\r\n\r\n            if (errorReportResult.rows.length > 0) {\r\n              const errorReport = errorReportResult.rows[0]\r\n              return res.status(500).json({\r\n                id: errorReport.id,\r\n                status: 'error',\r\n                error_message: errorReport.error_message || errorMessage,\r\n                report_markdown: '',\r\n                insights: {},\r\n                created_at: errorReport.created_at,\r\n                message: errorMessage,\r\n                details: errorDetails,\r\n              })\r\n            }\r\n          } catch (dbError) {\r\n            console.error('Erro ao buscar relatório de erro:', dbError)\r\n          }\r\n\r\n          return res.status(500).json({\r\n            error: 'Erro ao gerar relatório',\r\n            message: errorMessage,\r\n            details: errorDetails,\r\n          })\r\n        }\r\n      }\r\n\r\n      return res.status(405).json({ error: 'Método não permitido' })\r\n    } catch (error: any) {\r\n      console.error('Erro na API de relatórios:', error)\r\n      return res.status(500).json({ error: error.message })\r\n    }\r\n  })\r\n}\r\n\r\n","import type { NextApiResponse } from '../../types'\nimport type { IncomingMessage, ServerResponse } from 'node:http'\n\nimport { sendError } from '../../server/api-utils'\nimport { RouteKind } from '../../server/route-kind'\nimport type { Span } from '../../server/lib/trace/tracer'\nimport { PagesAPIRouteModule } from '../../server/route-modules/pages-api/module.compiled'\n\nimport { hoist } from './helpers'\n\n// Import the userland code.\nimport * as userland from 'VAR_USERLAND'\nimport { getTracer, SpanKind } from '../../server/lib/trace/tracer'\nimport { BaseServerSpan } from '../../server/lib/trace/constants'\nimport type { InstrumentationOnRequestError } from '../../server/instrumentation/types'\nimport { addRequestMeta } from '../../server/request-meta'\n\n// Re-export the handler (should be the default export).\nexport default hoist(userland, 'default')\n\n// Re-export config.\nexport const config = hoist(userland, 'config')\n\n// Create and export the route module that will be consumed.\nconst routeModule = new PagesAPIRouteModule({\n  definition: {\n    kind: RouteKind.PAGES_API,\n    page: 'VAR_DEFINITION_PAGE',\n    pathname: 'VAR_DEFINITION_PATHNAME',\n    // The following aren't used in production.\n    bundlePath: '',\n    filename: '',\n  },\n  userland,\n  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n  relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n})\n\nexport async function handler(\n  req: IncomingMessage,\n  res: ServerResponse,\n  ctx: {\n    waitUntil?: (prom: Promise<void>) => void\n  }\n): Promise<void> {\n  if (routeModule.isDev) {\n    addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint())\n  }\n  let srcPage = 'VAR_DEFINITION_PAGE'\n\n  // turbopack doesn't normalize `/index` in the page name\n  // so we need to to process dynamic routes properly\n  // TODO: fix turbopack providing differing value from webpack\n  if (process.env.TURBOPACK) {\n    srcPage = srcPage.replace(/\\/index$/, '') || '/'\n  }\n\n  const prepareResult = await routeModule.prepare(req, res, { srcPage })\n\n  if (!prepareResult) {\n    res.statusCode = 400\n    res.end('Bad Request')\n    ctx.waitUntil?.(Promise.resolve())\n    return\n  }\n\n  const { query, params, prerenderManifest, routerServerContext } =\n    prepareResult\n\n  try {\n    const method = req.method || 'GET'\n    const tracer = getTracer()\n\n    const activeSpan = tracer.getActiveScopeSpan()\n    const onRequestError =\n      routeModule.instrumentationOnRequestError.bind(routeModule)\n\n    const invokeRouteModule = async (span?: Span) =>\n      routeModule\n        .render(req, res, {\n          query: {\n            ...query,\n            ...params,\n          },\n          params,\n          allowedRevalidateHeaderKeys: process.env\n            .__NEXT_ALLOWED_REVALIDATE_HEADERS as any as string[],\n          multiZoneDraftMode: Boolean(process.env.__NEXT_MULTI_ZONE_DRAFT_MODE),\n          trustHostHeader: process.env\n            .__NEXT_TRUST_HOST_HEADER as any as boolean,\n          // TODO: get this from from runtime env so manifest\n          // doesn't need to load\n          previewProps: prerenderManifest.preview,\n          propagateError: false,\n          dev: routeModule.isDev,\n          page: 'VAR_DEFINITION_PAGE',\n\n          internalRevalidate: routerServerContext?.revalidate,\n\n          onError: (...args: Parameters<InstrumentationOnRequestError>) =>\n            onRequestError(req, ...args),\n        })\n        .finally(() => {\n          if (!span) return\n\n          span.setAttributes({\n            'http.status_code': res.statusCode,\n            'next.rsc': false,\n          })\n\n          const rootSpanAttributes = tracer.getRootSpanAttributes()\n          // We were unable to get attributes, probably OTEL is not enabled\n          if (!rootSpanAttributes) {\n            return\n          }\n\n          if (\n            rootSpanAttributes.get('next.span_type') !==\n            BaseServerSpan.handleRequest\n          ) {\n            console.warn(\n              `Unexpected root span type '${rootSpanAttributes.get(\n                'next.span_type'\n              )}'. Please report this Next.js issue https://github.com/vercel/next.js`\n            )\n            return\n          }\n\n          const route = rootSpanAttributes.get('next.route')\n          if (route) {\n            const name = `${method} ${route}`\n\n            span.setAttributes({\n              'next.route': route,\n              'http.route': route,\n              'next.span_name': name,\n            })\n            span.updateName(name)\n          } else {\n            span.updateName(`${method} ${srcPage}`)\n          }\n        })\n\n    // TODO: activeSpan code path is for when wrapped by\n    // next-server can be removed when this is no longer used\n    if (activeSpan) {\n      await invokeRouteModule(activeSpan)\n    } else {\n      await tracer.withPropagatedContext(req.headers, () =>\n        tracer.trace(\n          BaseServerSpan.handleRequest,\n          {\n            spanName: `${method} ${srcPage}`,\n            kind: SpanKind.SERVER,\n            attributes: {\n              'http.method': method,\n              'http.target': req.url,\n            },\n          },\n          invokeRouteModule\n        )\n      )\n    }\n  } catch (err) {\n    // we re-throw in dev to show the error overlay\n    if (routeModule.isDev) {\n      throw err\n    }\n    // this is technically an invariant as error handling\n    // should be done inside of api-resolver onError\n    sendError(res as NextApiResponse, 500, 'Internal Server Error')\n  } finally {\n    // We don't allow any waitUntil work in pages API routes currently\n    // so if callback is present return with resolved promise since no\n    // pending work\n    ctx.waitUntil?.(Promise.resolve())\n  }\n}\n"],"names":["sendError","RouteKind","PagesAPIRouteModule","hoist","userland","getTracer","SpanKind","BaseServerSpan","addRequestMeta","config","routeModule","definition","kind","PAGES_API","page","pathname","bundlePath","filename","distDir","process","env","__NEXT_RELATIVE_DIST_DIR","relativeProjectDir","__NEXT_RELATIVE_PROJECT_DIR","handler","req","res","ctx","isDev","hrtime","bigint","srcPage","TURBOPACK","replace","prepareResult","prepare","statusCode","end","waitUntil","Promise","resolve","query","params","prerenderManifest","routerServerContext","method","tracer","activeSpan","getActiveScopeSpan","onRequestError","instrumentationOnRequestError","bind","invokeRouteModule","span","render","allowedRevalidateHeaderKeys","__NEXT_ALLOWED_REVALIDATE_HEADERS","multiZoneDraftMode","Boolean","__NEXT_MULTI_ZONE_DRAFT_MODE","trustHostHeader","__NEXT_TRUST_HOST_HEADER","previewProps","preview","propagateError","dev","internalRevalidate","revalidate","onError","args","finally","setAttributes","rootSpanAttributes","getRootSpanAttributes","get","handleRequest","console","warn","route","name","updateName","withPropagatedContext","headers","trace","spanName","SERVER","attributes","url","err"],"mappings":"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","ignoreList":[4]}