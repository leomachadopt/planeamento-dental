module.exports=[70406,(e,t,s)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},47044,(e,t,s)=>{t.exports=e.x("jsonwebtoken-cc89c121a8bdfb14",()=>require("jsonwebtoken-cc89c121a8bdfb14"))},21503,e=>e.a(async(t,s)=>{try{let t=await e.y("pg-519b72043f8edc04");e.n(t),s()}catch(e){s(e)}},!0),64104,e=>e.a(async(t,s)=>{try{var r=e.i(21503),a=t([r]);if([r]=a.then?(await a)():a,!process.env.DATABASE_URL)throw console.error("❌ DATABASE_URL não está configurada!"),console.error("❌ Configure DATABASE_URL no arquivo .env.local ou nas variáveis de ambiente"),Error("DATABASE_URL não configurada. Configure no .env.local ou variáveis de ambiente.");let o=new r.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});o.on("connect",()=>{console.log("✅ Conectado ao banco de dados Neon")}),o.on("error",e=>{console.error("❌ Erro no pool de conexões:",e)}),e.s(["default",0,o]),s()}catch(e){s(e)}},!1),63963,e=>{"use strict";var t=e.i(47044);let s=process.env.JWT_SECRET||"your-secret-key-change-in-production";function r(e,r,a){let o=e.headers.authorization,i=o&&o.split(" ")[1];if(!i)return r.status(401).json({error:"Token não fornecido"});try{e.user=t.default.verify(i,s),a()}catch(e){return r.status(403).json({error:"Token inválido ou expirado"})}}function a(e,t,s){if(e.user?.role!=="admin")return t.status(403).json({error:"Acesso negado. Admin necessário."});s()}process.env.JWT_SECRET||console.warn("⚠️  JWT_SECRET não configurado! Usando valor padrão inseguro."),e.s(["authenticateToken",()=>r,"requireAdmin",()=>a])},40987,e=>e.a(async(t,s)=>{try{var r=e.i(64104),a=t([r]);async function o(e,t){try{await r.default.query(`UPDATE ai_reports 
       SET status = 'stale', updated_at = NOW()
       WHERE dossier_id = $1 AND section_code = $2 AND status = 'generated'`,[e,t])}catch(e){console.error("Erro ao marcar relatórios como stale:",e)}}function i(e){return({customer_segments:"IDENTITY",value_propositions:"IDENTITY",competitors:"MARKET",service_categories:"OFFER",services:"OFFER",team_members:"OPERATIONS",roles:"OPERATIONS",capacities:"OPERATIONS",strategic_choices:"STRATEGY",initiatives:"PLAN"})[e]||null}async function n(e){try{let t=await r.default.query(`SELECT s.code 
       FROM sections s
       JOIN question_sets qs ON qs.section_id = s.id
       JOIN questions q ON q.question_set_id = qs.id
       WHERE q.id = $1`,[e]);if(t.rows.length>0)return t.rows[0].code}catch(e){console.error("Erro ao buscar seção da pergunta:",e)}return null}async function u(e){try{await r.default.query(`UPDATE ai_reports 
       SET status = 'stale', updated_at = NOW()
       WHERE dossier_id = $1 AND section_code = 'FINAL_REPORT' AND status = 'generated'`,[e])}catch(e){console.error("Erro ao marcar relatório final como stale:",e)}}[r]=a.then?(await a)():a,e.s(["getSectionForEntity",()=>i,"getSectionForQuestion",()=>n,"markFinalReportAsStale",()=>u,"markSectionReportsAsStale",()=>o]),s()}catch(e){s(e)}},!1),23103,e=>e.a(async(t,s)=>{try{var r=e.i(64104),a=t([r]);async function o(e,t){let s,a=await r.default.query("SELECT id FROM sections WHERE code = $1",[t]);if(0===a.rows.length)return void console.warn(`Se\xe7\xe3o ${t} n\xe3o encontrada`);let o=a.rows[0].id,i=await r.default.query(`SELECT COUNT(*) as total FROM questions q
     JOIN question_sets qs ON qs.id = q.question_set_id
     WHERE qs.section_id = $1 AND q.required = true`,[o]),n=await r.default.query(`SELECT COUNT(*) as total FROM answers a
     JOIN questions q ON q.id = a.question_id
     JOIN question_sets qs ON qs.id = q.question_set_id
     WHERE qs.section_id = $1 AND a.dossier_id = $2 
     AND (a.value_text IS NOT NULL AND a.value_text != '' 
          OR a.value_number IS NOT NULL 
          OR a.value_json IS NOT NULL)`,[o,e]),u=parseInt(i.rows[0].total),l=parseInt(n.rows[0].total),d=0;if(0===u){let e=await r.default.query(`SELECT COUNT(*) as total FROM questions q
       JOIN question_sets qs ON qs.id = q.question_set_id
       WHERE qs.section_id = $1`,[o]),t=parseInt(e.rows[0].total);d=100*(0===t)}else d=Math.round(l/u*100);if("IDENTITY"===t){let t=await r.default.query("SELECT COUNT(*) as count FROM customer_segments WHERE dossier_id = $1 AND status = $2",[e,"active"]),s=await r.default.query("SELECT COUNT(*) as count FROM value_propositions WHERE dossier_id = $1 AND status = $2",[e,"active"]),a=parseInt(t.rows[0].count)>=1,o=parseInt(s.rows[0].count)>=1;a&&o?d=Math.min(100,d+10):(a||o)&&(d=Math.min(100,d+5))}else if("MARKET"===t){let t=await r.default.query("SELECT COUNT(*) as count FROM competitors WHERE dossier_id = $1 AND status = $2",[e,"active"]);parseInt(t.rows[0].count)>=1&&(d=Math.min(100,d+10))}else if("OFFER"===t){let t=await r.default.query("SELECT COUNT(*) as count FROM services WHERE dossier_id = $1 AND status = $2",[e,"active"]);parseInt(t.rows[0].count)>=1&&(d=Math.min(100,d+10))}else if("OPERATIONS"===t){let t=await r.default.query("SELECT COUNT(*) as count FROM team_members WHERE dossier_id = $1 AND status = $2",[e,"active"]),s=await r.default.query("SELECT COUNT(*) as count FROM capacities WHERE dossier_id = $1 AND status = $2",[e,"active"]),a=parseInt(t.rows[0].count)>=1,o=parseInt(s.rows[0].count)>=1;(a||o)&&(d=Math.min(100,d+10))}else if("STRATEGY"===t){let t=await r.default.query("SELECT COUNT(*) as count FROM strategic_choices WHERE dossier_id = $1 AND status = $2",[e,"active"]);parseInt(t.rows[0].count)>=1&&(d=Math.min(100,d+10))}else if("PLAN"===t){let t=await r.default.query("SELECT COUNT(*) as count FROM initiatives WHERE dossier_id = $1 AND status = $2",[e,"active"]);parseInt(t.rows[0].count)>=1&&(d=Math.min(100,d+10))}s=0===d?"not_started":100===d?"complete":"in_progress",await r.default.query(`INSERT INTO dossier_sections_status (dossier_id, section_id, completion_percent, status, last_updated_at)
     VALUES ($1, $2, $3, $4, NOW())
     ON CONFLICT (dossier_id, section_id)
     DO UPDATE SET 
       completion_percent = EXCLUDED.completion_percent,
       status = EXCLUDED.status,
       last_updated_at = NOW()`,[e,o,d,s])}[r]=a.then?(await a)():a,e.s(["updateSectionCompletion",()=>o]),s()}catch(e){s(e)}},!1),90490,e=>e.a(async(t,s)=>{try{var r=e.i(63963),a=e.i(64104),o=e.i(40987),i=e.i(23103),n=t([a,o,i]);async function u(e,t){return(t.setHeader("Access-Control-Allow-Credentials","true"),t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET,OPTIONS,PATCH,DELETE,POST,PUT"),t.setHeader("Access-Control-Allow-Headers","X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization"),"OPTIONS"===e.method)?void t.status(200).end():(0,r.authenticateToken)(e,t,async()=>{try{let{method:s}=e,r=e.user,n=e.query.id,u=e.query.sectionCode;if(!n)return t.status(400).json({error:"ID do dossiê é obrigatório"});let l=await a.default.query("SELECT clinic_id FROM dossiers WHERE id = $1",[n]);if(0===l.rows.length)return t.status(404).json({error:"Dossiê não encontrado"});let d=l.rows[0].clinic_id;if("admin"!==r.role&&r.clinicId!==d)return t.status(403).json({error:"Acesso negado a este dossiê"});if("GET"===s){let e=`
          SELECT a.*, q.code as question_code, q.text as question_text, q.type as question_type
          FROM answers a
          JOIN questions q ON q.id = a.question_id
          WHERE a.dossier_id = $1
        `,s=[n];u&&(e+=`
            AND q.question_set_id IN (
              SELECT qs.id FROM question_sets qs
              JOIN sections s ON s.id = qs.section_id
              WHERE s.code = $2
            )
          `,s.push(u)),e+=" ORDER BY q.order_index";let r=await a.default.query(e,s);return t.status(200).json(r.rows)}if("POST"===s){let{answers:s}=e.body;if(!Array.isArray(s))return t.status(400).json({error:"answers deve ser um array"});let r=s.map(e=>e.questionId).filter(Boolean);if(0===r.length)return t.status(400).json({error:"Nenhuma pergunta válida fornecida"});let l=await a.default.query("SELECT id, code, type FROM questions WHERE id = ANY($1::uuid[])",[r]);if(l.rows.length!==r.length)return t.status(400).json({error:"Uma ou mais perguntas não foram encontradas"});let d=s.map(async e=>{try{let{questionId:t,valueText:s,valueNumber:r,valueJson:o,source:i}=e,u=l.rows.find(e=>e.id===t);if(!u)return null;let d=null,c=null,E=null;if("number"===u.type||"currency"===u.type||"scale"===u.type)c=void 0!==r?r:s?parseFloat(s):null;else if("json"===u.type||"multi_select"===u.type)if(null!=o)E=o;else if(s)try{E=JSON.parse(s)}catch(e){console.warn(`⚠️ Pergunta ${u.code} \xe9 tipo ${u.type} mas recebeu texto simples. Salvando como value_text.`),d=s,E=null}else E=null;else d=void 0!==s?s:r?String(r):null;return a.default.query(`INSERT INTO answers (dossier_id, question_id, value_text, value_number, value_json, source, updated_at)
               VALUES ($1, $2, $3, $4, $5, $6, NOW())
               ON CONFLICT (dossier_id, question_id)
               DO UPDATE SET
                 value_text = EXCLUDED.value_text,
                 value_number = EXCLUDED.value_number,
                 value_json = EXCLUDED.value_json,
                 source = EXCLUDED.source,
                 updated_at = NOW()
               RETURNING *`,[n,t,d,c,E,i||"user"])}catch(t){throw console.error(`Erro ao processar resposta da pergunta ${e.questionId}:`,t.message),t}}),c=(await Promise.all(d.filter(Boolean))).map(e=>e.rows[0]).filter(Boolean),E=new Set;for(let e of c){let t=await (0,o.getSectionForQuestion)(e.question_id);t&&E.add(t)}for(let e of(u&&E.add(u),E))await (0,o.markSectionReportsAsStale)(n,e);for(let e of(E.size>0&&await (0,o.markFinalReportAsStale)(n),E))await (0,i.updateSectionCompletion)(n,e);return t.status(200).json({saved:c.length,answers:c})}return t.status(405).json({error:"Método não permitido"})}catch(e){return console.error("Erro na API de respostas:",e),t.status(500).json({error:e.message})}})}[a,o,i]=n.then?(await n)():n,e.s(["default",()=>u]),s()}catch(e){s(e)}},!1),9021,e=>e.a(async(t,s)=>{try{var r=e.i(93957),a=e.i(72664),o=e.i(61471),i=e.i(65751),n=e.i(90490),u=e.i(90078),l=e.i(57218),d=e.i(2576),c=t([n]);[n]=c.then?(await c)():c;let p=(0,i.hoist)(n,"default"),_=(0,i.hoist)(n,"config"),f=new o.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/dossiers/[id]/answers",pathname:"/api/dossiers/[id]/answers",bundlePath:"",filename:""},userland:n,distDir:".next",relativeProjectDir:""});async function E(e,t,s){f.isDev&&(0,d.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/dossiers/[id]/answers";a=a.replace(/\/index$/,"")||"/";let o=await f.prepare(e,t,{srcPage:a});if(!o){t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve());return}let{query:i,params:n,prerenderManifest:c,routerServerContext:E}=o;try{let s=e.method||"GET",r=(0,u.getTracer)(),o=r.getActiveScopeSpan(),d=f.instrumentationOnRequestError.bind(f),p=async o=>f.render(e,t,{query:{...i,...n},params:n,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:c.preview,propagateError:!1,dev:f.isDev,page:"/api/dossiers/[id]/answers",internalRevalidate:null==E?void 0:E.revalidate,onError:(...t)=>d(e,...t)}).finally(()=>{if(!o)return;o.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=r.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=e.get("next.route");if(i){let e=`${s} ${i}`;o.setAttributes({"next.route":i,"http.route":i,"next.span_name":e}),o.updateName(e)}else o.updateName(`${s} ${a}`)});o?await p(o):await r.withPropagatedContext(e.headers,()=>r.trace(l.BaseServerSpan.handleRequest,{spanName:`${s} ${a}`,kind:u.SpanKind.SERVER,attributes:{"http.method":s,"http.target":e.url}},p))}catch(e){if(f.isDev)throw e;(0,r.sendError)(t,500,"Internal Server Error")}finally{null==s.waitUntil||s.waitUntil.call(s,Promise.resolve())}}e.s(["config",0,_,"default",0,p,"handler",()=>E]),s()}catch(e){s(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__89e1aa51._.js.map