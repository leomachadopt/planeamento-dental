module.exports=[70406,(e,t,s)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},47044,(e,t,s)=>{t.exports=e.x("jsonwebtoken-cc89c121a8bdfb14",()=>require("jsonwebtoken-cc89c121a8bdfb14"))},21503,e=>e.a(async(t,s)=>{try{let t=await e.y("pg-519b72043f8edc04");e.n(t),s()}catch(e){s(e)}},!0),64104,e=>e.a(async(t,s)=>{try{var o=e.i(21503),r=t([o]);if([o]=r.then?(await r)():r,!process.env.DATABASE_URL)throw console.error("❌ DATABASE_URL não está configurada!"),console.error("❌ Configure DATABASE_URL no arquivo .env.local ou nas variáveis de ambiente"),Error("DATABASE_URL não configurada. Configure no .env.local ou variáveis de ambiente.");let i=new o.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});i.on("connect",()=>{console.log("✅ Conectado ao banco de dados Neon")}),i.on("error",e=>{console.error("❌ Erro no pool de conexões:",e)}),e.s(["default",0,i]),s()}catch(e){s(e)}},!1),63963,e=>{"use strict";var t=e.i(47044);let s=process.env.JWT_SECRET||"your-secret-key-change-in-production";function o(e,o,r){let i=e.headers.authorization,n=i&&i.split(" ")[1];if(!n)return o.status(401).json({error:"Token não fornecido"});try{e.user=t.default.verify(n,s),r()}catch(e){return o.status(403).json({error:"Token inválido ou expirado"})}}function r(e,t,s){if(e.user?.role!=="admin")return t.status(403).json({error:"Acesso negado. Admin necessário."});s()}process.env.JWT_SECRET||console.warn("⚠️  JWT_SECRET não configurado! Usando valor padrão inseguro."),e.s(["authenticateToken",()=>o,"requireAdmin",()=>r])},6779,e=>e.a(async(t,s)=>{try{var o=e.i(63963),r=e.i(64104),i=t([r]);async function n(e,t){return(t.setHeader("Access-Control-Allow-Credentials","true"),t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET,OPTIONS,PATCH,DELETE,POST,PUT"),t.setHeader("Access-Control-Allow-Headers","X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization"),"OPTIONS"===e.method)?void t.status(200).end():(0,o.authenticateToken)(e,t,async()=>{try{let{method:s}=e,o=e.user,i=e.query.id,n=e.query.sectionCode;if(!i)return t.status(400).json({error:"ID do dossiê é obrigatório"});let a=await r.default.query("SELECT clinic_id FROM dossiers WHERE id = $1",[i]);if(0===a.rows.length)return t.status(404).json({error:"Dossiê não encontrado"});let d=a.rows[0].clinic_id;if("admin"!==o.role&&o.clinicId!==d)return t.status(403).json({error:"Acesso negado a este dossiê"});if("GET"===s)if(n){let e=await r.default.query("SELECT * FROM sections WHERE code = $1",[n]);if(0===e.rows.length)return t.status(404).json({error:"Seção não encontrada"});let s=e.rows[0],o=(await r.default.query(`SELECT * FROM dossier_sections_status 
             WHERE dossier_id = $1 AND section_id = $2`,[i,s.id])).rows[0]||{status:"not_started",completion_percent:0},a=await r.default.query(`SELECT DISTINCT ON (qs.subsection_id, qs.section_id)
             qs.*, sub.code as subsection_code, sub.name as subsection_name
             FROM question_sets qs
             LEFT JOIN subsections sub ON sub.id = qs.subsection_id
             WHERE qs.section_id = $1 AND qs.is_active = true
             ORDER BY qs.subsection_id, qs.section_id, qs.version DESC`,[s.id]),u=await Promise.all(a.rows.map(async e=>{let t=await r.default.query(`SELECT q.*, 
                 json_agg(
                   json_build_object('id', qo.id, 'label', qo.label, 'value', qo.value, 'order_index', qo.order_index)
                   ORDER BY qo.order_index
                 ) FILTER (WHERE qo.id IS NOT NULL) as options
                 FROM questions q
                 LEFT JOIN question_options qo ON qo.question_id = q.id
                 WHERE q.question_set_id = $1
                 GROUP BY q.id
                 ORDER BY q.order_index`,[e.id]),s=t.rows.map(e=>e.id),o=[];s.length>0&&(o=(await r.default.query(`SELECT * FROM answers 
                   WHERE dossier_id = $1 AND question_id = ANY($2::uuid[])`,[i,s])).rows);let n=new Map(o.map(e=>[e.question_id,e])),a=t.rows.map(e=>({...e,options:e.options||[],answer:n.get(e.id)||null}));return{...e,questions:a}})),c={};return"IDENTITY"===n&&(c.customerSegments=(await r.default.query("SELECT * FROM customer_segments WHERE clinic_id = $1 AND dossier_id = $2 ORDER BY priority, created_at",[d,i])).rows,c.valuePropositions=(await r.default.query(`SELECT vp.*, cs.name as target_segment_name
               FROM value_propositions vp
               LEFT JOIN customer_segments cs ON cs.id = vp.target_segment_id
               WHERE vp.clinic_id = $1 AND vp.dossier_id = $2
               ORDER BY vp.created_at`,[d,i])).rows),t.status(200).json({section:s,status:o,questionSets:u,entities:c})}else{let e=await r.default.query(`SELECT s.*, 
             COALESCE(dss.status, 'not_started') as status,
             COALESCE(dss.completion_percent, 0) as completion_percent,
             dss.last_updated_at
             FROM sections s
             LEFT JOIN dossier_sections_status dss ON dss.section_id = s.id AND dss.dossier_id = $1
             ORDER BY s.order_index`,[i]);return t.status(200).json(e.rows)}return t.status(405).json({error:"Método não permitido"})}catch(e){return console.error("Erro na API de seções:",e),t.status(500).json({error:e.message})}})}[r]=i.then?(await i)():i,e.s(["default",()=>n]),s()}catch(e){s(e)}},!1),80401,e=>e.a(async(t,s)=>{try{var o=e.i(93957),r=e.i(72664),i=e.i(61471),n=e.i(65751),a=e.i(6779),d=e.i(90078),u=e.i(57218),c=e.i(2576),l=t([a]);[a]=l.then?(await l)():l;let E=(0,n.hoist)(a,"default"),_=(0,n.hoist)(a,"config"),q=new i.PagesAPIRouteModule({definition:{kind:r.RouteKind.PAGES_API,page:"/api/dossiers/[id]/sections",pathname:"/api/dossiers/[id]/sections",bundlePath:"",filename:""},userland:a,distDir:".next",relativeProjectDir:""});async function p(e,t,s){q.isDev&&(0,c.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/dossiers/[id]/sections";r=r.replace(/\/index$/,"")||"/";let i=await q.prepare(e,t,{srcPage:r});if(!i){t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve());return}let{query:n,params:a,prerenderManifest:l,routerServerContext:p}=i;try{let s=e.method||"GET",o=(0,d.getTracer)(),i=o.getActiveScopeSpan(),c=q.instrumentationOnRequestError.bind(q),E=async i=>q.render(e,t,{query:{...n,...a},params:a,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:l.preview,propagateError:!1,dev:q.isDev,page:"/api/dossiers/[id]/sections",internalRevalidate:null==p?void 0:p.revalidate,onError:(...t)=>c(e,...t)}).finally(()=>{if(!i)return;i.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=o.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=e.get("next.route");if(n){let e=`${s} ${n}`;i.setAttributes({"next.route":n,"http.route":n,"next.span_name":e}),i.updateName(e)}else i.updateName(`${s} ${r}`)});i?await E(i):await o.withPropagatedContext(e.headers,()=>o.trace(u.BaseServerSpan.handleRequest,{spanName:`${s} ${r}`,kind:d.SpanKind.SERVER,attributes:{"http.method":s,"http.target":e.url}},E))}catch(e){if(q.isDev)throw e;(0,o.sendError)(t,500,"Internal Server Error")}finally{null==s.waitUntil||s.waitUntil.call(s,Promise.resolve())}}e.s(["config",0,_,"default",0,E,"handler",()=>p]),s()}catch(e){s(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__b997782f._.js.map