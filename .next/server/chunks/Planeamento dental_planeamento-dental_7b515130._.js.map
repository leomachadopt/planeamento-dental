{"version":3,"sources":["../../../../../Planeamento%20dental/planeamento-dental/src/lib/api-shared/finalSnapshotBuilder.ts","../../../../../Planeamento%20dental/planeamento-dental/src/lib/api-shared/final-ai-client.ts","../../../../../Planeamento%20dental/planeamento-dental/pages/api/dossiers/%5Bid%5D/final-report.ts","../../../../../Planeamento%20dental/planeamento-dental/node_modules/next/src/build/templates/pages-api.ts"],"sourcesContent":["// Builder de snapshot global para Relatório Final\r\n// Consolida todos os relatórios de seções e calcula métricas globais\r\nimport pool from './db'\r\n\r\nexport interface FinalSnapshot {\r\n  clinic: {\r\n    id: string\r\n    name: string\r\n    location?: string\r\n    type?: string\r\n  }\r\n  dossier: {\r\n    id: string\r\n    title: string\r\n    baseline_date?: string\r\n  }\r\n  sections: Array<{\r\n    section_code: string\r\n    section_name: string\r\n    report_markdown?: string\r\n    insights?: any\r\n    scores?: {\r\n      clarity: number\r\n      consistency: number\r\n      completeness: number\r\n      impact_potential: number\r\n    }\r\n    alerts?: Array<{\r\n      severity: 'high' | 'medium' | 'low'\r\n      title: string\r\n      detail: string\r\n      evidence: string[]\r\n    }>\r\n    recommendations?: Array<{\r\n      priority: number\r\n      title: string\r\n      detail: string\r\n      effort: 'low' | 'medium' | 'high'\r\n      expected_impact: 'low' | 'medium' | 'high'\r\n    }>\r\n    missing_data?: Array<{\r\n      item: string\r\n      why_it_matters: string\r\n      how_to_fill: string\r\n    }>\r\n    is_stale: boolean\r\n    has_report: boolean\r\n  }>\r\n  global_metrics: {\r\n    average_scores: {\r\n      clarity: number\r\n      consistency: number\r\n      completeness: number\r\n      impact_potential: number\r\n    }\r\n    high_severity_alerts: number\r\n    medium_severity_alerts: number\r\n    low_severity_alerts: number\r\n    total_recommendations: number\r\n    top_recommendations: Array<{\r\n      title: string\r\n      priority: number\r\n      frequency: number\r\n    }>\r\n  }\r\n  missing_sections: string[]\r\n  stale_sections: string[]\r\n  generated_at: string\r\n}\r\n\r\n/**\r\n * Constrói snapshot global consolidando todos os relatórios de seções\r\n */\r\nexport async function buildFinalSnapshot(dossierId: string): Promise<FinalSnapshot> {\r\n  // 1. Buscar dados básicos\r\n  const dossierResult = await pool.query('SELECT * FROM dossiers WHERE id = $1', [dossierId])\r\n  if (dossierResult.rows.length === 0) {\r\n    throw new Error('Dossiê não encontrado')\r\n  }\r\n  const dossier = dossierResult.rows[0]\r\n\r\n  const clinicResult = await pool.query('SELECT * FROM clinics WHERE id = $1', [dossier.clinic_id])\r\n  if (clinicResult.rows.length === 0) {\r\n    throw new Error('Clínica não encontrada')\r\n  }\r\n  const clinic = clinicResult.rows[0]\r\n\r\n  // 2. Buscar todas as seções (exceto FINAL_REPORT)\r\n  const sectionsResult = await pool.query(\r\n    `SELECT * FROM sections WHERE code != 'FINAL_REPORT' ORDER BY order_index`,\r\n  )\r\n\r\n  // 3. Buscar último relatório de cada seção\r\n  const sectionsData: FinalSnapshot['sections'] = []\r\n  const missingSections: string[] = []\r\n  const staleSections: string[] = []\r\n\r\n  let totalClarity = 0\r\n  let totalConsistency = 0\r\n  let totalCompleteness = 0\r\n  let totalImpactPotential = 0\r\n  let sectionsWithScores = 0\r\n\r\n  let highSeverityAlerts = 0\r\n  let mediumSeverityAlerts = 0\r\n  let lowSeverityAlerts = 0\r\n  const allRecommendations: Array<{ title: string; priority: number }> = []\r\n\r\n  for (const section of sectionsResult.rows) {\r\n    // Buscar último relatório da seção (generated ou stale)\r\n    const reportResult = await pool.query(\r\n      `SELECT * FROM ai_reports \r\n       WHERE dossier_id = $1 AND section_code = $2 \r\n       ORDER BY created_at DESC \r\n       LIMIT 1`,\r\n      [dossierId, section.code],\r\n    )\r\n\r\n    const hasReport = reportResult.rows.length > 0\r\n    const report = hasReport ? reportResult.rows[0] : null\r\n    const isStale = report?.status === 'stale'\r\n\r\n    if (isStale) {\r\n      staleSections.push(section.code)\r\n    }\r\n\r\n    if (!hasReport) {\r\n      missingSections.push(section.code)\r\n    }\r\n\r\n    let insights: any = null\r\n    let scores: any = null\r\n    let alerts: any[] = []\r\n    let recommendations: any[] = []\r\n    let missingData: any[] = []\r\n\r\n    if (report) {\r\n      try {\r\n        insights = typeof report.insights_json === 'string'\r\n          ? JSON.parse(report.insights_json)\r\n          : report.insights_json\r\n\r\n        scores = insights?.score || {}\r\n        alerts = insights?.alerts || []\r\n        recommendations = insights?.recommendations || []\r\n        missingData = insights?.missing_data || []\r\n\r\n        // Acumular scores para média\r\n        if (scores.clarity !== undefined) {\r\n          totalClarity += scores.clarity\r\n          totalConsistency += scores.consistency || 0\r\n          totalCompleteness += scores.completeness || 0\r\n          totalImpactPotential += scores.impact_potential || 0\r\n          sectionsWithScores++\r\n        }\r\n\r\n        // Contar alertas por severidade\r\n        alerts.forEach((alert: any) => {\r\n          if (alert.severity === 'high') highSeverityAlerts++\r\n          else if (alert.severity === 'medium') mediumSeverityAlerts++\r\n          else if (alert.severity === 'low') lowSeverityAlerts++\r\n        })\r\n\r\n        // Acumular recomendações\r\n        recommendations.forEach((rec: any) => {\r\n          allRecommendations.push({\r\n            title: rec.title || '',\r\n            priority: rec.priority || 0,\r\n          })\r\n        })\r\n      } catch (error) {\r\n        console.warn(`Erro ao parsear insights da seção ${section.code}:`, error)\r\n      }\r\n    }\r\n\r\n    sectionsData.push({\r\n      section_code: section.code,\r\n      section_name: section.name,\r\n      report_markdown: report?.report_markdown || undefined,\r\n      insights: insights || undefined,\r\n      scores: scores || undefined,\r\n      alerts: alerts.length > 0 ? alerts : undefined,\r\n      recommendations: recommendations.length > 0 ? recommendations : undefined,\r\n      missing_data: missingData.length > 0 ? missingData : undefined,\r\n      is_stale: isStale,\r\n      has_report: hasReport,\r\n    })\r\n  }\r\n\r\n  // 4. Calcular métricas globais\r\n  const averageScores = {\r\n    clarity: sectionsWithScores > 0 ? totalClarity / sectionsWithScores : 0,\r\n    consistency: sectionsWithScores > 0 ? totalConsistency / sectionsWithScores : 0,\r\n    completeness: sectionsWithScores > 0 ? totalCompleteness / sectionsWithScores : 0,\r\n    impact_potential: sectionsWithScores > 0 ? totalImpactPotential / sectionsWithScores : 0,\r\n  }\r\n\r\n  // Agrupar recomendações similares (por título)\r\n  const recommendationsMap = new Map<string, { title: string; priority: number; frequency: number }>()\r\n  allRecommendations.forEach((rec) => {\r\n    const key = rec.title.toLowerCase().trim()\r\n    const existing = recommendationsMap.get(key)\r\n    if (existing) {\r\n      existing.frequency++\r\n      existing.priority = Math.max(existing.priority, rec.priority)\r\n    } else {\r\n      recommendationsMap.set(key, {\r\n        title: rec.title,\r\n        priority: rec.priority,\r\n        frequency: 1,\r\n      })\r\n    }\r\n  })\r\n\r\n  const topRecommendations = Array.from(recommendationsMap.values())\r\n    .sort((a, b) => {\r\n      // Ordenar por prioridade primeiro, depois por frequência\r\n      if (b.priority !== a.priority) return b.priority - a.priority\r\n      return b.frequency - a.frequency\r\n    })\r\n    .slice(0, 10)\r\n\r\n  return {\r\n    clinic: {\r\n      id: clinic.id,\r\n      name: clinic.clinic_name,\r\n    },\r\n    dossier: {\r\n      id: dossier.id,\r\n      title: dossier.title,\r\n      baseline_date: dossier.baseline_date || undefined,\r\n    },\r\n    sections: sectionsData,\r\n    global_metrics: {\r\n      average_scores: averageScores,\r\n      high_severity_alerts: highSeverityAlerts,\r\n      medium_severity_alerts: mediumSeverityAlerts,\r\n      low_severity_alerts: lowSeverityAlerts,\r\n      total_recommendations: allRecommendations.length,\r\n      top_recommendations: topRecommendations,\r\n    },\r\n    missing_sections: missingSections,\r\n    stale_sections: staleSections,\r\n    generated_at: new Date().toISOString(),\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n","// Versão server-side do AI client para Relatório Final\r\n// Nota: getSystemPrompt e buildFinalReportPrompt precisam ser acessados via import dinâmico\r\n// ou duplicados aqui. Por enquanto, vamos duplicar a lógica necessária.\r\nimport type { FinalSnapshot } from './finalSnapshotBuilder'\r\n\r\n// Duplicar getSystemPrompt aqui para evitar problemas de import\r\nfunction getSystemPrompt(tone: string): string {\r\n  const toneMap = {\r\n    formal: 'Você é um consultor de gestão estratégica especializado em clínicas de saúde. Use linguagem formal, técnica e objetiva. Seja preciso e baseie todas as conclusões nos dados fornecidos.',\r\n    informal: 'Você é um mentor de negócios que fala de forma acessível e direta. Use linguagem informal e próxima, evitando jargões excessivos. Seja prático e baseie recomendações nos dados fornecidos.',\r\n    intermediario: 'Você é um consultor experiente que equilibra profissionalismo com clareza. Use linguagem clara, mas profissional. Seja objetivo e baseie análises nos dados fornecidos.',\r\n  }\r\n  return toneMap[tone as keyof typeof toneMap] || toneMap.intermediario\r\n}\r\n\r\n// Duplicar buildFinalReportPrompt aqui (versão completa do section-prompts.ts)\r\nfunction buildFinalReportPrompt(snapshot: FinalSnapshot, tone: string = 'intermediario'): string {\r\n  const finalReportInstruction = `\r\nVocê é um consultor sênior de gestão estratégica que recebeu todos os relatórios setoriais de uma clínica de saúde.\r\nSua missão é escrever o PARECER FINAL EXECUTIVO para o dono da clínica e/ou investidores.\r\n\r\nEste documento será o documento estratégico oficial do negócio, consolidando todas as análises setoriais em uma narrativa única, clara e acionável.\r\n\r\n**CONTEXTO:**\r\nVocê recebeu relatórios detalhados de cada área estratégica da clínica. Algumas áreas podem estar completas, outras podem ter lacunas.\r\nSua tarefa é:\r\n1. Consolidar os achados em uma narrativa executiva única\r\n2. Identificar as 3-7 prioridades estratégicas mais importantes\r\n3. Mapear riscos críticos e oportunidades\r\n4. Criar um roadmap de alto nível para os próximos 12-24 meses\r\n5. Ser claro sobre o que NÃO fazer (kill list)\r\n\r\n**ESTRUTURA OBRIGATÓRIA DO RELATÓRIO:**\r\n\r\n1. **CAPA**\r\n   - Nome da clínica: ${snapshot.clinic.name}\r\n   - Nome do dossiê: ${snapshot.dossier.title}\r\n   - Data: ${new Date().toLocaleDateString('pt-PT')}\r\n   - Subtítulo: \"Relatório Estratégico Consolidado\"\r\n\r\n2. **SUMÁRIO EXECUTIVO** (1-2 páginas equivalentes)\r\n   - Diagnóstico geral da situação atual\r\n   - 3-5 grandes conclusões principais\r\n   - Visão geral do estado de saúde do negócio\r\n\r\n3. **MAPA DE SAÚDE DO NEGÓCIO**\r\n   - Visão geral por área (Identidade, Mercado, Oferta, Operações, Estratégia, Plano)\r\n   - Pontos fortes e fracos de cada área\r\n   - Scores médios de clareza, consistência, completude e potencial de impacto\r\n\r\n4. **PRINCIPAIS RISCOS ESTRATÉGICOS**\r\n   - Lista priorizada de riscos\r\n   - Impacto de cada risco e por que são perigosos\r\n   - Seções afetadas por cada risco\r\n\r\n5. **PRINCIPAIS OPORTUNIDADES**\r\n   - Oportunidades identificadas\r\n   - Potencial de impacto\r\n   - Esforço necessário\r\n\r\n6. **AS 3-7 PRIORIDADES ESTRATÉGICAS**\r\n   Para cada prioridade, incluir:\r\n   - Contexto e situação atual\r\n   - Por que é prioridade\r\n   - Impacto esperado (alto/médio/baixo)\r\n   - Esforço necessário (alto/médio/baixo)\r\n   - Racional por trás da priorização\r\n\r\n7. **ROADMAP DE ALTO NÍVEL (12-24 MESES)**\r\n   - Fases ou ondas de implementação\r\n   - O que vem antes do quê (dependências)\r\n   - Marcos principais\r\n   - Timeline aproximada\r\n\r\n8. **O QUE NÃO FAZER**\r\n   - Cortes estratégicos necessários\r\n   - Focos a abandonar\r\n   - Renúncias estratégicas conscientes\r\n   - Atividades que não agregam valor\r\n\r\n9. **APÊNDICE**\r\n   - Resumo executivo de cada seção analisada\r\n   - Referências aos relatórios setoriais completos\r\n\r\n**DADOS CONSOLIDADOS:**\r\n\r\nClínica: ${snapshot.clinic.name}\r\nDossiê: ${snapshot.dossier.title}\r\nData de referência: ${snapshot.dossier.baseline_date || 'Não definida'}\r\n\r\n**MÉTRICAS GLOBAIS:**\r\n\r\nScores Médios:\r\n- Clareza: ${snapshot.global_metrics.average_scores.clarity.toFixed(1)}/10\r\n- Consistência: ${snapshot.global_metrics.average_scores.consistency.toFixed(1)}/10\r\n- Completude: ${snapshot.global_metrics.average_scores.completeness.toFixed(1)}/10\r\n- Potencial de Impacto: ${snapshot.global_metrics.average_scores.impact_potential.toFixed(1)}/10\r\n\r\nAlertas:\r\n- Alta severidade: ${snapshot.global_metrics.high_severity_alerts}\r\n- Média severidade: ${snapshot.global_metrics.medium_severity_alerts}\r\n- Baixa severidade: ${snapshot.global_metrics.low_severity_alerts}\r\n\r\nTotal de recomendações: ${snapshot.global_metrics.total_recommendations}\r\n\r\n**RELAÇÃO DE SEÇÕES:**\r\n\r\n${snapshot.sections.map((section) => {\r\n  const status = section.has_report\r\n    ? section.is_stale\r\n      ? '⚠️ DESATUALIZADO'\r\n      : '✅ ATUALIZADO'\r\n    : '❌ NÃO GERADO'\r\n  return `\r\n**${section.section_name}** (${section.section_code}) - ${status}\r\n${section.has_report ? `Scores: C=${section.scores?.clarity || 0}/10, Co=${section.scores?.consistency || 0}/10, Cp=${section.scores?.completeness || 0}/10, I=${section.scores?.impact_potential || 0}/10` : 'Sem relatório disponível'}\r\n${section.alerts && section.alerts.length > 0 ? `Alertas: ${section.alerts.length} (${section.alerts.filter((a: any) => a.severity === 'high').length} alta, ${section.alerts.filter((a: any) => a.severity === 'medium').length} média, ${section.alerts.filter((a: any) => a.severity === 'low').length} baixa)` : ''}\r\n${section.recommendations && section.recommendations.length > 0 ? `Recomendações: ${section.recommendations.length}` : ''}\r\n${section.report_markdown ? `\\nResumo do relatório:\\n${section.report_markdown.substring(0, 500)}...` : ''}\r\n`\r\n}).join('\\n')}\r\n\r\n${snapshot.missing_sections.length > 0 ? `\\n⚠️ **SEÇÕES SEM RELATÓRIO:** ${snapshot.missing_sections.join(', ')}\\nExplique no relatório que essas áreas não foram analisadas e por que isso importa.` : ''}\r\n\r\n${snapshot.stale_sections.length > 0 ? `\\n⚠️ **SEÇÕES DESATUALIZADAS:** ${snapshot.stale_sections.join(', ')}\\nOs dados dessas seções foram alterados após a geração dos relatórios.` : ''}\r\n\r\n**TOP RECOMENDAÇÕES (agrupadas):**\r\n\r\n${snapshot.global_metrics.top_recommendations.slice(0, 10).map((rec: any, idx: number) => \r\n  `${idx + 1}. ${rec.title} (Prioridade: ${rec.priority}, Mencionada ${rec.frequency}x)`\r\n).join('\\n')}\r\n\r\n---\r\n\r\n**FORMATO DE SAÍDA ESPERADO:**\r\n\r\nVocê DEVE retornar um JSON válido com a seguinte estrutura EXATA:\r\n\r\n{\r\n  \"report_markdown\": \"# Relatório Estratégico Consolidado\\\\n\\\\n[Conteúdo completo em Markdown seguindo a estrutura obrigatória acima]\",\r\n  \"insights\": {\r\n    \"global_score\": {\r\n      \"clarity\": 0-10,\r\n      \"consistency\": 0-10,\r\n      \"completeness\": 0-10,\r\n      \"impact_potential\": 0-10\r\n    },\r\n    \"top_priorities\": [\r\n      {\r\n        \"rank\": 1-7,\r\n        \"title\": \"Título da prioridade\",\r\n        \"rationale\": \"Por que é prioridade\",\r\n        \"expected_impact\": \"high|medium|low\",\r\n        \"effort\": \"high|medium|low\"\r\n      }\r\n    ],\r\n    \"critical_risks\": [\r\n      {\r\n        \"severity\": \"high|medium|low\",\r\n        \"title\": \"Título do risco\",\r\n        \"detail\": \"Descrição detalhada\",\r\n        \"affected_sections\": [\"IDENTITY\", \"MARKET\", ...]\r\n      }\r\n    ],\r\n    \"key_opportunities\": [\r\n      {\r\n        \"title\": \"Título da oportunidade\",\r\n        \"detail\": \"Descrição\",\r\n        \"potential_impact\": \"high|medium|low\",\r\n        \"effort_required\": \"high|medium|low\"\r\n      }\r\n    ],\r\n    \"strategic_focus\": [\"foco 1\", \"foco 2\", ...],\r\n    \"kill_list\": [\"coisa a parar de fazer 1\", \"coisa a parar de fazer 2\", ...],\r\n    \"missing_sections\": [\"seção sem relatório 1\", ...]\r\n  }\r\n}\r\n\r\n**INSTRUÇÕES IMPORTANTES:**\r\n\r\n- O report_markdown deve seguir EXATAMENTE a estrutura obrigatória listada acima\r\n- Seja específico e cite dados concretos dos relatórios setoriais\r\n- Priorize clareza e acionabilidade sobre complexidade\r\n- Identifique contradições entre seções e resolva-as\r\n- Seja honesto sobre lacunas (seções faltantes)\r\n- O relatório deve ser útil tanto para o dono da clínica quanto para investidores\r\n- Use linguagem ${tone === 'formal' ? 'formal e técnica' : tone === 'informal' ? 'acessível e direta' : 'clara e profissional'}\r\n- O documento deve ter entre 15-25 páginas equivalentes quando impresso\r\n\r\nGere o relatório final completo e os insights estruturados baseados EXCLUSIVAMENTE nos dados fornecidos acima.\r\n  `.trim()\r\n\r\n  return finalReportInstruction\r\n}\r\n\r\nexport interface FinalReportInsights {\r\n  global_score: {\r\n    clarity: number\r\n    consistency: number\r\n    completeness: number\r\n    impact_potential: number\r\n  }\r\n  top_priorities: Array<{\r\n    rank: number\r\n    title: string\r\n    rationale: string\r\n    expected_impact: 'high' | 'medium' | 'low'\r\n    effort: 'high' | 'medium' | 'low'\r\n  }>\r\n  critical_risks: Array<{\r\n    severity: 'high' | 'medium' | 'low'\r\n    title: string\r\n    detail: string\r\n    affected_sections: string[]\r\n  }>\r\n  key_opportunities: Array<{\r\n    title: string\r\n    detail: string\r\n    potential_impact: 'high' | 'medium' | 'low'\r\n    effort_required: 'high' | 'medium' | 'low'\r\n  }>\r\n  strategic_focus: string[]\r\n  kill_list: string[]\r\n  missing_sections: string[]\r\n}\r\n\r\nexport interface FinalReportResponse {\r\n  report_markdown: string\r\n  insights: FinalReportInsights\r\n}\r\n\r\nexport interface GenerateOptions {\r\n  apiKey: string\r\n  model?: string\r\n  temperature?: number\r\n  promptVersion?: string\r\n  tone?: string\r\n}\r\n\r\nconst DEFAULT_MODEL = 'gpt-4o'\r\nconst DEFAULT_TEMPERATURE = 0.7\r\nconst DEFAULT_TONE = 'intermediario'\r\n\r\nexport async function generateFinalReport(\r\n  snapshot: FinalSnapshot,\r\n  options: GenerateOptions,\r\n): Promise<{\r\n  report_markdown: string\r\n  insights: FinalReportInsights\r\n  token_usage?: any\r\n}> {\r\n  const {\r\n    apiKey,\r\n    model = DEFAULT_MODEL,\r\n    temperature = DEFAULT_TEMPERATURE,\r\n    tone = DEFAULT_TONE,\r\n  } = options\r\n\r\n  const systemPrompt = getSystemPrompt(tone)\r\n  const userPrompt = buildFinalReportPrompt(snapshot, tone)\r\n\r\n  const response = await fetch('https://api.openai.com/v1/chat/completions', {\r\n    method: 'POST',\r\n    headers: {\r\n      'Content-Type': 'application/json',\r\n      Authorization: `Bearer ${apiKey}`,\r\n    },\r\n    body: JSON.stringify({\r\n      model,\r\n      messages: [\r\n        {\r\n          role: 'system',\r\n          content: systemPrompt,\r\n        },\r\n        {\r\n          role: 'user',\r\n          content: userPrompt,\r\n        },\r\n      ],\r\n      temperature,\r\n      max_tokens: 8000, // Mais tokens para relatório final\r\n      response_format: { type: 'json_object' },\r\n    }),\r\n  })\r\n\r\n  if (!response.ok) {\r\n    const error = await response.json().catch(() => ({ error: { message: response.statusText } }))\r\n    throw new Error(`Erro na API OpenAI: ${error.error?.message || response.statusText}`)\r\n  }\r\n\r\n  const data = await response.json()\r\n  const content = data.choices[0]?.message?.content\r\n\r\n  if (!content) {\r\n    throw new Error('Resposta vazia da OpenAI')\r\n  }\r\n\r\n  const parsed = parseAIResponse(content)\r\n\r\n  return {\r\n    report_markdown: parsed.report_markdown,\r\n    insights: parsed.insights,\r\n    token_usage: data.usage,\r\n  }\r\n}\r\n\r\nfunction parseAIResponse(content: string): FinalReportResponse {\r\n  try {\r\n    const parsed = JSON.parse(content)\r\n    if (validateAIResponse(parsed)) {\r\n      return parsed\r\n    }\r\n  } catch (error) {\r\n    // Tentar extrair JSON\r\n  }\r\n\r\n  try {\r\n    const jsonMatch = content.match(/```json\\s*([\\s\\S]*?)\\s*```/) || content.match(/\\{[\\s\\S]*\\}/)\r\n    if (jsonMatch) {\r\n      const jsonStr = jsonMatch[1] || jsonMatch[0]\r\n      const parsed = JSON.parse(jsonStr)\r\n      if (validateAIResponse(parsed)) {\r\n        return parsed\r\n      }\r\n    }\r\n  } catch (error) {\r\n    // Falha\r\n  }\r\n\r\n  try {\r\n    const parsed = JSON.parse(content)\r\n    const corrected = {\r\n      report_markdown: parsed.report_markdown || parsed.report || '# Relatório Final\\n\\nErro ao processar resposta.',\r\n      insights: correctInsightsStructure(parsed.insights || parsed),\r\n    }\r\n    if (validateAIResponse(corrected)) {\r\n      return corrected\r\n    }\r\n  } catch (error) {\r\n    // Falha\r\n  }\r\n\r\n  throw new Error('Não foi possível parsear a resposta da IA. Formato inválido.')\r\n}\r\n\r\nfunction validateAIResponse(data: any): data is FinalReportResponse {\r\n  if (!data || typeof data !== 'object') return false\r\n  if (!data.report_markdown || typeof data.report_markdown !== 'string') return false\r\n  if (!data.insights || typeof data.insights !== 'object') return false\r\n\r\n  const insights = data.insights\r\n  if (!insights.global_score || typeof insights.global_score !== 'object') return false\r\n  if (typeof insights.global_score.clarity !== 'number') return false\r\n  if (typeof insights.global_score.consistency !== 'number') return false\r\n  if (typeof insights.global_score.completeness !== 'number') return false\r\n  if (typeof insights.global_score.impact_potential !== 'number') return false\r\n\r\n  if (!Array.isArray(insights.top_priorities)) return false\r\n  if (!Array.isArray(insights.critical_risks)) return false\r\n  if (!Array.isArray(insights.key_opportunities)) return false\r\n  if (!Array.isArray(insights.strategic_focus)) return false\r\n  if (!Array.isArray(insights.kill_list)) return false\r\n  if (!Array.isArray(insights.missing_sections)) return false\r\n\r\n  return true\r\n}\r\n\r\nfunction correctInsightsStructure(insights: any): FinalReportInsights {\r\n  return {\r\n    global_score: {\r\n      clarity: insights.global_score?.clarity ?? insights.clarity ?? 5,\r\n      consistency: insights.global_score?.consistency ?? insights.consistency ?? 5,\r\n      completeness: insights.global_score?.completeness ?? insights.completeness ?? 5,\r\n      impact_potential: insights.global_score?.impact_potential ?? insights.impact_potential ?? 5,\r\n    },\r\n    top_priorities: Array.isArray(insights.top_priorities) ? insights.top_priorities : [],\r\n    critical_risks: Array.isArray(insights.critical_risks) ? insights.critical_risks : [],\r\n    key_opportunities: Array.isArray(insights.key_opportunities) ? insights.key_opportunities : [],\r\n    strategic_focus: Array.isArray(insights.strategic_focus) ? insights.strategic_focus : [],\r\n    kill_list: Array.isArray(insights.kill_list) ? insights.kill_list : [],\r\n    missing_sections: Array.isArray(insights.missing_sections) ? insights.missing_sections : [],\r\n  }\r\n}\r\n\r\nexport async function generateFinalReportWithRetry(\r\n  snapshot: FinalSnapshot,\r\n  options: GenerateOptions,\r\n): Promise<{\r\n  report_markdown: string\r\n  insights: FinalReportInsights\r\n  token_usage?: any\r\n}> {\r\n  try {\r\n    return await generateFinalReport(snapshot, options)\r\n  } catch (error: any) {\r\n    console.warn('Primeira tentativa falhou, tentando novamente...', error.message)\r\n    try {\r\n      return await generateFinalReport(snapshot, options)\r\n    } catch (retryError: any) {\r\n      throw new Error(`Falha após retry: ${retryError.message}`)\r\n    }\r\n  }\r\n}\r\n\r\n","import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport { authenticateToken, AuthRequest } from '@/lib/api-shared/auth'\r\nimport pool from '@/lib/api-shared/db'\r\nimport { buildFinalSnapshot } from '@/lib/api-shared/finalSnapshotBuilder'\r\nimport { generateFinalReportWithRetry } from '@/lib/api-shared/final-ai-client'\r\n\r\nexport default async function handler(\r\n  req: VercelRequest,\r\n  res: VercelResponse,\r\n) {\r\n  res.setHeader('Access-Control-Allow-Credentials', 'true')\r\n  res.setHeader('Access-Control-Allow-Origin', '*')\r\n  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT')\r\n  res.setHeader('Access-Control-Allow-Headers', 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization')\r\n\r\n  if (req.method === 'OPTIONS') {\r\n    res.status(200).end()\r\n    return\r\n  }\r\n\r\n  return authenticateToken(req as AuthRequest, res, async () => {\r\n    try {\r\n      const { method } = req\r\n      const authReq = req as AuthRequest\r\n      const user = authReq.user!\r\n      const dossierId = req.query.id as string\r\n\r\n      if (!dossierId) {\r\n        return res.status(400).json({ error: 'ID do dossiê é obrigatório' })\r\n      }\r\n\r\n      // Validar acesso ao dossiê\r\n      const dossierResult = await pool.query(\r\n        'SELECT clinic_id FROM dossiers WHERE id = $1',\r\n        [dossierId],\r\n      )\r\n\r\n      if (dossierResult.rows.length === 0) {\r\n        return res.status(404).json({ error: 'Dossiê não encontrado' })\r\n      }\r\n\r\n      const clinicId = dossierResult.rows[0].clinic_id\r\n\r\n      if (user.role !== 'admin' && user.clinicId !== clinicId) {\r\n        return res.status(403).json({ error: 'Acesso negado a este dossiê' })\r\n      }\r\n\r\n      // Validar seção FINAL_REPORT\r\n      const sectionResult = await pool.query('SELECT id FROM sections WHERE code = $1', [\r\n        'FINAL_REPORT',\r\n      ])\r\n\r\n      if (sectionResult.rows.length === 0) {\r\n        return res.status(404).json({ error: 'Seção FINAL_REPORT não encontrada' })\r\n      }\r\n\r\n      const sectionId = sectionResult.rows[0].id\r\n\r\n      if (method === 'GET') {\r\n        // Retornar último relatório final\r\n        const reportResult = await pool.query(\r\n          `SELECT * FROM ai_reports \r\n           WHERE dossier_id = $1 AND section_code = 'FINAL_REPORT'\r\n           ORDER BY created_at DESC \r\n           LIMIT 1`,\r\n          [dossierId],\r\n        )\r\n\r\n        if (reportResult.rows.length === 0) {\r\n          return res.status(404).json({ error: 'Relatório final ainda não gerado' })\r\n        }\r\n\r\n        const report = reportResult.rows[0]\r\n        return res.status(200).json({\r\n          id: report.id,\r\n          status: report.status,\r\n          report_markdown: report.report_markdown,\r\n          insights: report.insights_json,\r\n          created_at: report.created_at,\r\n          updated_at: report.updated_at,\r\n          prompt_key: report.prompt_key,\r\n          prompt_version: report.prompt_version,\r\n          model: report.model,\r\n        })\r\n      }\r\n\r\n      if (method === 'POST') {\r\n        // Validar que pelo menos 1 seção tem relatório\r\n        const sectionsWithReports = await pool.query(\r\n          `SELECT COUNT(DISTINCT section_code) as count \r\n           FROM ai_reports \r\n           WHERE dossier_id = $1 AND section_code != 'FINAL_REPORT'`,\r\n          [dossierId],\r\n        )\r\n\r\n        if (parseInt(sectionsWithReports.rows[0].count) === 0) {\r\n          return res.status(400).json({\r\n            error: 'É necessário ter pelo menos um relatório de seção gerado antes de gerar o relatório final',\r\n          })\r\n        }\r\n\r\n        const apiKey = process.env.OPENAI_API_KEY\r\n        if (!apiKey) {\r\n          console.error('OPENAI_API_KEY não configurada')\r\n          return res.status(500).json({ error: 'Configuração do servidor incompleta' })\r\n        }\r\n\r\n        try {\r\n          // 1. Build snapshot global\r\n          console.log(`Construindo snapshot global para relatório final...`)\r\n          const snapshot = await buildFinalSnapshot(dossierId)\r\n\r\n          // 2. Registrar evento\r\n          let reportId: string | null = null\r\n          try {\r\n            await pool.query(\r\n              `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n               VALUES (NULL, 'snapshot_built', $1)\r\n               RETURNING id`,\r\n              [JSON.stringify({ section_code: 'FINAL_REPORT', dossier_id: dossierId })],\r\n            )\r\n          } catch (error) {\r\n            // Ignorar erro de eventos (opcional)\r\n          }\r\n\r\n          // 3. Call LLM\r\n          console.log(`Chamando IA para gerar relatório final...`)\r\n          const aiResult = await generateFinalReportWithRetry(snapshot, {\r\n            apiKey,\r\n            model: 'gpt-4o',\r\n            temperature: 0.7,\r\n            promptVersion: '1.0.0',\r\n            tone: 'intermediario',\r\n          })\r\n\r\n          // 4. Persistir relatório\r\n          const insertResult = await pool.query(\r\n            `INSERT INTO ai_reports (\r\n              clinic_id, dossier_id, section_id, section_code, status,\r\n              input_snapshot_json, report_markdown, insights_json,\r\n              prompt_key, prompt_version, model, temperature, token_usage_json\r\n            ) VALUES ($1, $2, $3, 'FINAL_REPORT', 'generated', $4, $5, $6, $7, $8, $9, $10, $11)\r\n            RETURNING id`,\r\n            [\r\n              clinicId,\r\n              dossierId,\r\n              sectionId,\r\n              JSON.stringify(snapshot),\r\n              aiResult.report_markdown,\r\n              JSON.stringify(aiResult.insights),\r\n              'FINAL_REPORT_V1',\r\n              '1.0.0',\r\n              'gpt-4o',\r\n              0.7,\r\n              aiResult.token_usage ? JSON.stringify(aiResult.token_usage) : null,\r\n            ],\r\n          )\r\n\r\n          reportId = insertResult.rows[0].id\r\n\r\n          // 5. Marcar relatórios finais anteriores como stale\r\n          await pool.query(\r\n            `UPDATE ai_reports \r\n             SET status = 'stale', updated_at = NOW()\r\n             WHERE dossier_id = $1 AND section_code = 'FINAL_REPORT' AND id != $2 AND status = 'generated'`,\r\n            [dossierId, reportId],\r\n          )\r\n\r\n          // 6. Registrar eventos\r\n          try {\r\n            await pool.query(\r\n              `UPDATE ai_report_events SET ai_report_id = $1 WHERE ai_report_id IS NULL`,\r\n              [reportId],\r\n            )\r\n            await pool.query(\r\n              `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n               VALUES ($1, 'llm_called', $2)`,\r\n              [reportId, JSON.stringify({ model: 'gpt-4o', temperature: 0.7 })],\r\n            )\r\n            await pool.query(\r\n              `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n               VALUES ($1, 'persisted', $2)`,\r\n              [reportId, JSON.stringify({ success: true })],\r\n            )\r\n          } catch (error) {\r\n            // Ignorar erros de eventos\r\n          }\r\n\r\n          console.log(`Relatório final gerado com sucesso: ${reportId}`)\r\n\r\n          return res.status(200).json({\r\n            id: reportId,\r\n            status: 'generated',\r\n            report_markdown: aiResult.report_markdown,\r\n            insights: aiResult.insights,\r\n            created_at: new Date().toISOString(),\r\n          })\r\n        } catch (error: any) {\r\n          console.error('Erro ao gerar relatório final:', error)\r\n\r\n          // Salvar erro no banco\r\n          try {\r\n            const errorReportResult = await pool.query(\r\n              `INSERT INTO ai_reports (\r\n                clinic_id, dossier_id, section_id, section_code, status,\r\n                input_snapshot_json, report_markdown, insights_json,\r\n                error_message, prompt_key, prompt_version, model\r\n              ) VALUES ($1, $2, $3, 'FINAL_REPORT', 'error', $4, '', '{}', $5, $6, $7, $8)\r\n              RETURNING id`,\r\n              [\r\n                clinicId,\r\n                dossierId,\r\n                sectionId,\r\n                JSON.stringify({ error: 'Snapshot não pôde ser construído' }),\r\n                error.message,\r\n                'FINAL_REPORT_V1',\r\n                '1.0.0',\r\n                'gpt-4o',\r\n              ],\r\n            )\r\n\r\n            // Registrar evento de erro\r\n            try {\r\n              await pool.query(\r\n                `INSERT INTO ai_report_events (ai_report_id, event_type, payload_json)\r\n                 VALUES ($1, 'error', $2)`,\r\n                [errorReportResult.rows[0].id, JSON.stringify({ error: error.message })],\r\n              )\r\n            } catch {\r\n              // Ignorar\r\n            }\r\n          } catch (dbError) {\r\n            console.error('Erro ao salvar erro no banco:', dbError)\r\n          }\r\n\r\n          return res.status(500).json({\r\n            error: 'Erro ao gerar relatório final',\r\n            message: error.message,\r\n          })\r\n        }\r\n      }\r\n\r\n      return res.status(405).json({ error: 'Método não permitido' })\r\n    } catch (error: any) {\r\n      console.error('Erro na API de relatório final:', error)\r\n      return res.status(500).json({ error: error.message })\r\n    }\r\n  })\r\n}\r\n\r\n\r\n\r\n\r\n","import type { NextApiResponse } from '../../types'\nimport type { IncomingMessage, ServerResponse } from 'node:http'\n\nimport { sendError } from '../../server/api-utils'\nimport { RouteKind } from '../../server/route-kind'\nimport type { Span } from '../../server/lib/trace/tracer'\nimport { PagesAPIRouteModule } from '../../server/route-modules/pages-api/module.compiled'\n\nimport { hoist } from './helpers'\n\n// Import the userland code.\nimport * as userland from 'VAR_USERLAND'\nimport { getTracer, SpanKind } from '../../server/lib/trace/tracer'\nimport { BaseServerSpan } from '../../server/lib/trace/constants'\nimport type { InstrumentationOnRequestError } from '../../server/instrumentation/types'\nimport { addRequestMeta } from '../../server/request-meta'\n\n// Re-export the handler (should be the default export).\nexport default hoist(userland, 'default')\n\n// Re-export config.\nexport const config = hoist(userland, 'config')\n\n// Create and export the route module that will be consumed.\nconst routeModule = new PagesAPIRouteModule({\n  definition: {\n    kind: RouteKind.PAGES_API,\n    page: 'VAR_DEFINITION_PAGE',\n    pathname: 'VAR_DEFINITION_PATHNAME',\n    // The following aren't used in production.\n    bundlePath: '',\n    filename: '',\n  },\n  userland,\n  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n  relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n})\n\nexport async function handler(\n  req: IncomingMessage,\n  res: ServerResponse,\n  ctx: {\n    waitUntil?: (prom: Promise<void>) => void\n  }\n): Promise<void> {\n  if (routeModule.isDev) {\n    addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint())\n  }\n  let srcPage = 'VAR_DEFINITION_PAGE'\n\n  // turbopack doesn't normalize `/index` in the page name\n  // so we need to to process dynamic routes properly\n  // TODO: fix turbopack providing differing value from webpack\n  if (process.env.TURBOPACK) {\n    srcPage = srcPage.replace(/\\/index$/, '') || '/'\n  }\n\n  const prepareResult = await routeModule.prepare(req, res, { srcPage })\n\n  if (!prepareResult) {\n    res.statusCode = 400\n    res.end('Bad Request')\n    ctx.waitUntil?.(Promise.resolve())\n    return\n  }\n\n  const { query, params, prerenderManifest, routerServerContext } =\n    prepareResult\n\n  try {\n    const method = req.method || 'GET'\n    const tracer = getTracer()\n\n    const activeSpan = tracer.getActiveScopeSpan()\n    const onRequestError =\n      routeModule.instrumentationOnRequestError.bind(routeModule)\n\n    const invokeRouteModule = async (span?: Span) =>\n      routeModule\n        .render(req, res, {\n          query: {\n            ...query,\n            ...params,\n          },\n          params,\n          allowedRevalidateHeaderKeys: process.env\n            .__NEXT_ALLOWED_REVALIDATE_HEADERS as any as string[],\n          multiZoneDraftMode: Boolean(process.env.__NEXT_MULTI_ZONE_DRAFT_MODE),\n          trustHostHeader: process.env\n            .__NEXT_TRUST_HOST_HEADER as any as boolean,\n          // TODO: get this from from runtime env so manifest\n          // doesn't need to load\n          previewProps: prerenderManifest.preview,\n          propagateError: false,\n          dev: routeModule.isDev,\n          page: 'VAR_DEFINITION_PAGE',\n\n          internalRevalidate: routerServerContext?.revalidate,\n\n          onError: (...args: Parameters<InstrumentationOnRequestError>) =>\n            onRequestError(req, ...args),\n        })\n        .finally(() => {\n          if (!span) return\n\n          span.setAttributes({\n            'http.status_code': res.statusCode,\n            'next.rsc': false,\n          })\n\n          const rootSpanAttributes = tracer.getRootSpanAttributes()\n          // We were unable to get attributes, probably OTEL is not enabled\n          if (!rootSpanAttributes) {\n            return\n          }\n\n          if (\n            rootSpanAttributes.get('next.span_type') !==\n            BaseServerSpan.handleRequest\n          ) {\n            console.warn(\n              `Unexpected root span type '${rootSpanAttributes.get(\n                'next.span_type'\n              )}'. Please report this Next.js issue https://github.com/vercel/next.js`\n            )\n            return\n          }\n\n          const route = rootSpanAttributes.get('next.route')\n          if (route) {\n            const name = `${method} ${route}`\n\n            span.setAttributes({\n              'next.route': route,\n              'http.route': route,\n              'next.span_name': name,\n            })\n            span.updateName(name)\n          } else {\n            span.updateName(`${method} ${srcPage}`)\n          }\n        })\n\n    // TODO: activeSpan code path is for when wrapped by\n    // next-server can be removed when this is no longer used\n    if (activeSpan) {\n      await invokeRouteModule(activeSpan)\n    } else {\n      await tracer.withPropagatedContext(req.headers, () =>\n        tracer.trace(\n          BaseServerSpan.handleRequest,\n          {\n            spanName: `${method} ${srcPage}`,\n            kind: SpanKind.SERVER,\n            attributes: {\n              'http.method': method,\n              'http.target': req.url,\n            },\n          },\n          invokeRouteModule\n        )\n      )\n    }\n  } catch (err) {\n    // we re-throw in dev to show the error overlay\n    if (routeModule.isDev) {\n      throw err\n    }\n    // this is technically an invariant as error handling\n    // should be done inside of api-resolver onError\n    sendError(res as NextApiResponse, 500, 'Internal Server Error')\n  } finally {\n    // We don't allow any waitUntil work in pages API routes currently\n    // so if callback is present return with resolved promise since no\n    // pending work\n    ctx.waitUntil?.(Promise.resolve())\n  }\n}\n"],"names":["sendError","RouteKind","PagesAPIRouteModule","hoist","userland","getTracer","SpanKind","BaseServerSpan","addRequestMeta","config","routeModule","definition","kind","PAGES_API","page","pathname","bundlePath","filename","distDir","process","env","__NEXT_RELATIVE_DIST_DIR","relativeProjectDir","__NEXT_RELATIVE_PROJECT_DIR","handler","req","res","ctx","isDev","hrtime","bigint","srcPage","TURBOPACK","replace","prepareResult","prepare","statusCode","end","waitUntil","Promise","resolve","query","params","prerenderManifest","routerServerContext","method","tracer","activeSpan","getActiveScopeSpan","onRequestError","instrumentationOnRequestError","bind","invokeRouteModule","span","render","allowedRevalidateHeaderKeys","__NEXT_ALLOWED_REVALIDATE_HEADERS","multiZoneDraftMode","Boolean","__NEXT_MULTI_ZONE_DRAFT_MODE","trustHostHeader","__NEXT_TRUST_HOST_HEADER","previewProps","preview","propagateError","dev","internalRevalidate","revalidate","onError","args","finally","setAttributes","rootSpanAttributes","getRootSpanAttributes","get","handleRequest","console","warn","route","name","updateName","withPropagatedContext","headers","trace","spanName","SERVER","attributes","url","err"],"mappings":"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","ignoreList":[3]}