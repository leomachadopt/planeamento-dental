module.exports=[70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},47044,(e,t,r)=>{t.exports=e.x("jsonwebtoken-cc89c121a8bdfb14",()=>require("jsonwebtoken-cc89c121a8bdfb14"))},21503,e=>e.a(async(t,r)=>{try{let t=await e.y("pg-519b72043f8edc04");e.n(t),r()}catch(e){r(e)}},!0),64104,e=>e.a(async(t,r)=>{try{var o=e.i(21503),a=t([o]);if([o]=a.then?(await a)():a,!process.env.DATABASE_URL)throw console.error("❌ DATABASE_URL não está configurada!"),console.error("❌ Configure DATABASE_URL no arquivo .env.local ou nas variáveis de ambiente"),Error("DATABASE_URL não configurada. Configure no .env.local ou variáveis de ambiente.");let n=new o.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});n.on("connect",()=>{console.log("✅ Conectado ao banco de dados Neon")}),n.on("error",e=>{console.error("❌ Erro no pool de conexões:",e)}),e.s(["default",0,n]),r()}catch(e){r(e)}},!1),63963,e=>{"use strict";var t=e.i(47044);let r=process.env.JWT_SECRET||"your-secret-key-change-in-production";function o(e,o,a){let n=e.headers.authorization,i=n&&n.split(" ")[1];if(!i)return o.status(401).json({error:"Token não fornecido"});try{e.user=t.default.verify(i,r),a()}catch(e){return o.status(403).json({error:"Token inválido ou expirado"})}}function a(e,t,r){if(e.user?.role!=="admin")return t.status(403).json({error:"Acesso negado. Admin necessário."});r()}process.env.JWT_SECRET||console.warn("⚠️  JWT_SECRET não configurado! Usando valor padrão inseguro."),e.s(["authenticateToken",()=>o,"requireAdmin",()=>a])},84993,e=>e.a(async(t,r)=>{try{var o=e.i(63963),a=e.i(64104),n=t([a]);async function i(t,r){return(r.setHeader("Access-Control-Allow-Credentials","true"),r.setHeader("Access-Control-Allow-Origin","*"),r.setHeader("Access-Control-Allow-Methods","GET,OPTIONS,PATCH,DELETE,POST,PUT"),r.setHeader("Access-Control-Allow-Headers","X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, Authorization"),"OPTIONS"===t.method)?void r.status(200).end():(0,o.authenticateToken)(t,r,async()=>{try{let{method:o}=t,n=t.user,i=t.query.id,s=t.query.format||"pdf";if(!i)return r.status(400).json({error:"ID do dossiê é obrigatório"});if("GET"!==o)return r.status(405).json({error:"Método não permitido"});let l=await a.default.query("SELECT clinic_id FROM dossiers WHERE id = $1",[i]);if(0===l.rows.length)return r.status(404).json({error:"Dossiê não encontrado"});let d=l.rows[0].clinic_id;if("admin"!==n.role&&n.clinicId!==d)return r.status(403).json({error:"Acesso negado a este dossiê"});let c=await a.default.query(`SELECT ar.*, d.title as dossier_title, c.clinic_name
         FROM ai_reports ar
         JOIN dossiers d ON d.id = ar.dossier_id
         JOIN clinics c ON c.id = ar.clinic_id
         WHERE ar.dossier_id = $1 AND ar.section_code = 'FINAL_REPORT'
         ORDER BY ar.created_at DESC 
         LIMIT 1`,[i]);if(0===c.rows.length)return r.status(404).json({error:"Relatório final ainda não gerado"});let u=c.rows[0];if("pdf"!==s)return r.status(400).json({error:"Formato não suportado. Use format=pdf"});{let{jsPDF:t}=await e.A(77672),o=new t({orientation:"portrait",unit:"mm",format:"a4"}),a=o.internal.pageSize.getWidth(),n=o.internal.pageSize.getHeight(),s=20,l=e=>s+e>n-20&&(o.addPage(),s=20,!0);o.setFontSize(24),o.setFont("helvetica","bold");let d=u.clinic_name||"Clínica",c=o.getTextWidth(d);o.text(d,(a-c)/2,s),s+=15,o.setFontSize(18),o.setFont("helvetica","normal");let p=u.dossier_title||"Dossiê",f=o.getTextWidth(p);o.text(p,(a-f)/2,s),s+=10,o.setFontSize(16),o.text("Relatório Estratégico Consolidado",(a-o.getTextWidth("Relatório Estratégico Consolidado"))/2,s),s+=15,o.setFontSize(12),o.setFont("helvetica","italic");let g=new Date(u.created_at).toLocaleDateString("pt-PT");o.text(`Gerado em: ${g}`,(a-o.getTextWidth(`Gerado em: ${g}`))/2,s),s=n-30,o.addPage(),s=20;let h=u.report_markdown.replace(/^#+\s+(.+)$/gm,"$1").replace(/\*\*(.+?)\*\*/g,"$1").replace(/\*(.+?)\*/g,"$1").replace(/\[(.+?)\]\(.+?\)/g,"$1").replace(/`(.+?)`/g,"$1").replace(/^\s*[-*+]\s+/gm,"• ").replace(/^\s*\d+\.\s+/gm,"").trim(),m=o.splitTextToSize(h,a-40);for(let e of(o.setFontSize(11),o.setFont("helvetica","normal"),m))l(7),o.text(e,20,s),s+=7;let v=o.internal.pages.length-1;for(let e=1;e<=v;e++)o.setPage(e),o.setFontSize(10),o.text(`P\xe1gina ${e} de ${v}`,a-20-o.getTextWidth(`P\xe1gina ${e} de ${v}`),n-10);let T=Buffer.from(o.output("arraybuffer"));return r.setHeader("Content-Type","application/pdf"),r.setHeader("Content-Disposition",`attachment; filename="relatorio-final-${i}.pdf"`),r.status(200).send(T)}}catch(e){return console.error("Erro na exportação do relatório final:",e),r.status(500).json({error:e.message})}})}[a]=n.then?(await n)():n,e.s(["default",()=>i]),r()}catch(e){r(e)}},!1),7333,e=>e.a(async(t,r)=>{try{var o=e.i(93957),a=e.i(72664),n=e.i(61471),i=e.i(65751),s=e.i(84993),l=e.i(90078),d=e.i(57218),c=e.i(2576),u=t([s]);[s]=u.then?(await u)():u;let f=(0,i.hoist)(s,"default"),g=(0,i.hoist)(s,"config"),h=new n.PagesAPIRouteModule({definition:{kind:a.RouteKind.PAGES_API,page:"/api/dossiers/[id]/final-report/export",pathname:"/api/dossiers/[id]/final-report/export",bundlePath:"",filename:""},userland:s,distDir:".next",relativeProjectDir:""});async function p(e,t,r){h.isDev&&(0,c.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/dossiers/[id]/final-report/export";a=a.replace(/\/index$/,"")||"/";let n=await h.prepare(e,t,{srcPage:a});if(!n){t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve());return}let{query:i,params:s,prerenderManifest:u,routerServerContext:p}=n;try{let r=e.method||"GET",o=(0,l.getTracer)(),n=o.getActiveScopeSpan(),c=h.instrumentationOnRequestError.bind(h),f=async n=>h.render(e,t,{query:{...i,...s},params:s,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:u.preview,propagateError:!1,dev:h.isDev,page:"/api/dossiers/[id]/final-report/export",internalRevalidate:null==p?void 0:p.revalidate,onError:(...t)=>c(e,...t)}).finally(()=>{if(!n)return;n.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let e=o.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=e.get("next.route");if(i){let e=`${r} ${i}`;n.setAttributes({"next.route":i,"http.route":i,"next.span_name":e}),n.updateName(e)}else n.updateName(`${r} ${a}`)});n?await f(n):await o.withPropagatedContext(e.headers,()=>o.trace(d.BaseServerSpan.handleRequest,{spanName:`${r} ${a}`,kind:l.SpanKind.SERVER,attributes:{"http.method":r,"http.target":e.url}},f))}catch(e){if(h.isDev)throw e;(0,o.sendError)(t,500,"Internal Server Error")}finally{null==r.waitUntil||r.waitUntil.call(r,Promise.resolve())}}e.s(["config",0,g,"default",0,f,"handler",()=>p]),r()}catch(e){r(e)}},!1),77672,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_jspdf_14033e64._.js"].map(t=>e.l(t))).then(()=>t(94735)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__91363652._.js.map