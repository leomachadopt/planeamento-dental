{"version":3,"sources":["../../../../../Planeamento%20dental/planeamento-dental/src/lib/api-shared/db.ts","../../../../../Planeamento%20dental/planeamento-dental/src/lib/api-shared/auth.ts"],"sourcesContent":["// Módulo compartilhado para API routes\r\n// Este arquivo só roda no servidor (Node.js)\r\n\r\nimport { Pool } from 'pg'\r\n\r\n// Validar DATABASE_URL\r\nif (!process.env.DATABASE_URL) {\r\n  console.error('❌ DATABASE_URL não está configurada!')\r\n  console.error('❌ Configure DATABASE_URL no arquivo .env.local ou nas variáveis de ambiente')\r\n  throw new Error('DATABASE_URL não configurada. Configure no .env.local ou variáveis de ambiente.')\r\n}\r\n\r\n// Pool de conexões PostgreSQL\r\nconst pool = new Pool({\r\n  connectionString: process.env.DATABASE_URL,\r\n  ssl: {\r\n    rejectUnauthorized: false,\r\n  },\r\n  max: 20,\r\n  idleTimeoutMillis: 30000,\r\n  connectionTimeoutMillis: 2000,\r\n})\r\n\r\npool.on('connect', () => {\r\n  console.log('✅ Conectado ao banco de dados Neon')\r\n})\r\n\r\npool.on('error', (err) => {\r\n  console.error('❌ Erro no pool de conexões:', err)\r\n})\r\n\r\nexport default pool\r\n\r\n\r\n\r\n\r\n\r\n","import type { VercelRequest, VercelResponse } from '@vercel/node'\r\nimport jwt from 'jsonwebtoken'\r\n\r\nexport interface AuthRequest extends VercelRequest {\r\n  user?: {\r\n    id: string\r\n    email: string\r\n    role: 'admin' | 'user'\r\n    clinicId?: string\r\n    name: string\r\n  }\r\n}\r\n\r\n// Usar variável de ambiente ou fallback\r\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production'\r\n\r\nif (!process.env.JWT_SECRET) {\r\n  console.warn('⚠️  JWT_SECRET não configurado! Usando valor padrão inseguro.')\r\n}\r\n\r\nexport function authenticateToken(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  const authHeader = req.headers['authorization']\r\n  const token = authHeader && authHeader.split(' ')[1]\r\n\r\n  if (!token) {\r\n    return res.status(401).json({ error: 'Token não fornecido' })\r\n  }\r\n\r\n  try {\r\n    const decoded = jwt.verify(token, JWT_SECRET) as AuthRequest['user']\r\n    req.user = decoded\r\n    next()\r\n  } catch (error) {\r\n    return res.status(403).json({ error: 'Token inválido ou expirado' })\r\n  }\r\n}\r\n\r\nexport function requireAdmin(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  if (req.user?.role !== 'admin') {\r\n    return res.status(403).json({ error: 'Acesso negado. Admin necessário.' })\r\n  }\r\n  next()\r\n}\r\n\r\nexport function optionalAuth(\r\n  req: AuthRequest,\r\n  res: VercelResponse,\r\n  next: () => void\r\n) {\r\n  const authHeader = req.headers['authorization']\r\n  const token = authHeader && authHeader.split(' ')[1]\r\n\r\n  if (token) {\r\n    try {\r\n      const decoded = jwt.verify(token, JWT_SECRET) as AuthRequest['user']\r\n      req.user = decoded\r\n    } catch (error) {\r\n      // Token inválido, mas continua sem autenticação\r\n    }\r\n  }\r\n  next()\r\n}\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":"4XAGA,IAAA,EAAA,EAAA,CAAA,CAAA,gBAGA,4BAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,CAG3B,CAH6B,KAC7B,QAAQ,KAAK,CAAC,wCACd,QAAQ,KAAK,CAAC,+EACR,AAAI,MAAM,mFAIlB,IAAM,EAAO,IAAI,EAAA,IAAI,CAAC,CACpB,iBAAkB,QAAQ,GAAG,CAAC,YAAY,CAC1C,IAAK,CACH,oBAAoB,CACtB,EACA,IAAK,GACL,kBAAmB,IACnB,wBAAyB,GAC3B,GAEA,EAAK,EAAE,CAAC,UAAW,KACjB,QAAQ,GAAG,CAAC,qCACd,GAEA,EAAK,EAAE,CAAC,QAAS,AAAC,IAChB,QAAQ,KAAK,CAAC,8BAA+B,EAC/C,oBAEe,mDC9Bf,IAAA,EAAA,EAAA,CAAA,CAAA,OAaA,IAAM,EAAa,QAAQ,GAAG,CAAC,UAAU,EAAI,uCAMtC,SAAS,EACd,CAAgB,CAChB,CAAmB,CACnB,CAAgB,EAEhB,IAAM,EAAa,EAAI,OAAO,CAAC,aAAgB,CACzC,EAAQ,GAAc,EAAW,KAAK,CAAC,IAAI,CAAC,EAAE,CAEpD,GAAI,CAAC,EACH,KADU,EACH,EAAI,MAAM,CAAC,KAAK,IAAI,CAAC,CAAE,MAAO,qBAAsB,GAG7D,GAAI,CAEF,EAAI,IAAI,CADQ,EAAA,AACL,OADQ,CAAC,MAAM,CAAC,EAAO,GAElC,GACF,CAAE,MAAO,EAAO,CACd,OAAO,EAAI,MAAM,CAAC,KAAK,IAAI,CAAC,CAAE,MAAO,4BAA6B,EACpE,CACF,CAEO,SAAS,EACd,CAAgB,CAChB,CAAmB,CACnB,CAAgB,EAEhB,GAAI,EAAI,IAAI,EAAE,OAAS,QACrB,CAD8B,MACvB,EAAI,MAAM,CAAC,KAAK,IAAI,CAAC,CAAE,MAAO,kCAAmC,GAE1E,GACF,CAlCI,AAAC,QAAQ,GAAG,CAAC,UAAU,EAAE,AAC3B,QAAQ,IAAI,CAAC"}